---
title: "Provincial Netdown"
author: "Hailey Eckstrand"
date: "Last run on `r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    code_folding: hide
    # highlight: monochrome
    highlight: tango
    keep_md: yes
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
---

## Background

This report describes the data and methodology used to classify the Provincial THLB Proxy land base into four nested categories: Total TSA area, analysis forested land base (AFLB), gross timber harvesting land base (gTHLB) and timber harvesting land base (THLB).

### Document setup

```{r r-version}
r_version <- R.version.string
```

This report is prepared using [RStudio](https://www.rstudio.com) and `r r_version`. All necessary R package libraries have been loaded into the work environment, and the required document elements have been set up.

```{r  setup, message = FALSE, warning = FALSE, results = 'hide'}

# load libraries:
library(knitr)
library(kableExtra)
library(tidyverse)
library(sf)
library(ggnewscale)
library(tidyterra)
library(tmap)
library(ggspatial)
library(scales)
library(cowplot)
library(mapview)
library(tidytext)
library(janitor)

rm(list = ls())

start<-Sys.time()

#knitr...read about knitr here: https://sachsmc.github.io/knit-git-markr-guide/knitr/knit.html
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(connection = "db")
knitr::opts_knit$set(sql.max.print = NA)
knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7, collapse = TRUE)

```

### Netdown process overview

The netdown process is a progressive exclusion algorithm where the TSA land base is classified into four nested categories: Total land base, AFLB, gTHLB, and THLB:

<!-- ![](images/clipboard-1181740388.png){width="656"} -->

To delineate the 4 land base categories, several deductions occur, each of which is described in detail in this document. For each deduction, two steps are followed:

1.  Categorize the area deduction in a *netdown dataframe:*
    -   The netdown dataframe includes a record for each hectare within the Province and multiple fields used to determine area deductions. For example:

        <!-- ![](images/clipboard-2788201750.png){width="554"} -->

    -   As area deductions occur, new variables are created that describe area being removed.

    -   The AFLB, gTHLB and THLB variables are updated with each area deduction. Initially, the AFLB, gTHLB, and THLB all have a value of one. The value gets updated with each area deduction. 
2.  Summarize the area deductions in a netdown summary table - the table summarizes area information for each area deduction:
    -   The **total** area is the gross area for the area deduction category/landclass,
    -   The **percent** is the percent of total TSA area,
    -   The **excluded** value is the area that is excluded from the final THLB - the areas are excluded in the order they appear in the netdown summary table and account for areas excluded in previous deductions.
    -   The **running total** value is the combined total of excluded area for the landclass and each previous landclass identified in the table,
    -   The **netdown** is the remaining area after excluded area is removed. The final value (bottom row) is the THLB.

For example:

### Categorical vs. numerical area deduction variables

**Categorical** variables are nominal variables that describe the type of area being excluded - there is no intrinsic ordering or ranking within each categorical netdown variable. For example, the ownership description variable classifies each hectare by the excluded ownership type (e.g., private land, Tree Farm Licence, etc.). In the netdown dataframe, categorical variables are prefixed with "n" followed by the order in which they occur in the netdown process (e.g., n01_ownership occurs first)

**Numerical** variables capture finer resolution (i.e. less than 100-meter resolution) area deductions and contain numeric values that define the proportion of a given hectare that will be excluded from the AFLB, gTHLB, and THLB (e.g., 10% of a 1-hectare grid cell may be occupied by road). In this analysis, there are 3 numeric area deduction variables (lineal features, inoperable area, and stand-level retention), each of which are described in more detail in this document. Numeric variable names are prefixed with "p" followed by the order in which they occur (e.g., p04_lineal_features occurs 4th in the netdown process).

Once the netdown process is complete, the netdown table and thlb summary table are exported to postgres.

## Data assembly

Prior to completing the netdown process that creates the netdown dataframe and thlb summary, exploratory data analysis is necessary for assembling and pre-processing data. FAIB's analysis-ready dataset is a primary source of data; however, additional data is also used and is described in each netdown area deduction factor.

### Netdown dataframe

Area deduction variables that are required to classify the land base are loaded into the netdown dataframe through a postgres query. AFLB, gTHLB, and THLB variables are added to the dataframe with default values of 1. As the netdown process continues, new variables are added corresponding to each area deduction factor and the AFLB, gTHLB, and THLB values are updated accordingly.

```{r data, eval= FALSE}
library(dadmtools)
library(dplyr)

conn_list <- dadmtools::get_pg_conn_list()

setup_tracking_variable<-function(netdown_tab){
  landclass <- "Provincial Boundary"
  total <- nrow(netdown_tab)
  unit <- nrow(netdown_tab)
  percent <- 100
  excluded <- 0
  running_total <- 0
  netdown<-unit - running_total
  
  netdown_summary <- data.frame(landclass, total, percent, excluded, running_total,netdown)
}

query <- "SELECT
  gr_skey,
  bc_land,
  n01_ownership,
  n02_nonfor,
  p03_linear_features,
  p04_riparian,
  p05_phys_inop,
  n06_merchantability
FROM  
thlb_proxy.prov_netdown"
netdown_tab <- sql_to_df(query, conn_list)
# identify the unit for future labeling
# Query postgres for necessary data (when new data is required it is first processed and loaded to postgres):


#a.arch_grid,
#  a.retention_grid,
#  d.isolated, ## add back in after doing patch analysis

## setup for looking at a different initial land category (e.g., retention area) to determine how much of the area is netted out and how much is in the THLB.

#netdown_tab <- netdown_tab %>% 
  # kelly's retention:
#  filter(retention_grid > 0)
  # elaine's retention:
#  filter(!is.na(retention))
  

## updates since receiving from Kelly:
# all markdowns for individual factors are stored in sub-folders in the TSA02_Netdown r project: C:\Data\TSA02\R_analysis\TSA02_Netdown
  # SKi resorts excluded from AFLB
  # Lineal features updated to 2021 Integrated roads dataset and clipped to TSA. see tsa02_roads.Rmd 
  # Riparian aspatial reduction updated to reflect overlaps with other excluded areas. See tsa02_retention_analysis.Rmd 
  # Provincial parks rasterized based on bcgw data rather than ownership as boundaries not accurately captured in ownership data. Parks_and_Rec.Rmd 
  # WHAs did not capture overlapping WHAs. new wha table created: tsa02_wildlife_WHAs.Rmd (a.wha_harv_code excluded)
  # added conservation lands to miscellaneous reserves netdown step
  # switched from tsa02_tmp_res to tsa02_ar2022 as the feature_ids are consistent with the pfi and msyt.

# Add AFLB, gTHLB, THLB to netdown table. initially all with value of 1 - updated with each netdown step.
netdown_tab <- netdown_tab %>%
  # add new variables (aflb, thlbe_net, and gthlb_net) to the netdown table. Initially, these are all set to a value of 1. Through the netdown process, they will be updated.
  mutate(
    aflb = 1,
    thlb_net = 1,
    gthlb_net = 1
  )
```

### Netdown summary table

The netdown summary table is initially created with the Provincial Boundary. As the netdown process progresses, each area deduction is appended as a new row.


```{r eval= FALSE}

## set up the TSA defaults for the TSA as a whole

netdown_summary <- setup_tracking_variable(netdown_tab = netdown_tab)
#View(netdown_summary)

# identify the initially running total for netted out area (used in subsequent netdown step)
running_total <- 0

pretty_table(x = netdown_summary)

```

## Netdown steps

Each netdown step (area deduction) is described in the following sub-sections.

## Delineating the FMLB - Forest Management Land Base

The FMLB primarily uses the VRI field: `for_mgmt_land_base_ind` as its base with some updates. Note the `for_mgmt_land_base_ind` field is a text field which contains either 'Y' or 'N'.

The following logic is used to derive the `for_mgmt_land_base_ind` field:

```{sql eval= FALSE}
WITH initial_for_mgmt_land_base_ind AS (
SELECT
  CASE
      -- when harvest exist
      WHEN (nullif(v.opening_id::text,'0') IS NULL AND nullif(v.opening_number::text,'0') IS NULL AND v.harvest_date IS NULL)
      
      AND
      -- inventory code = Forest Inventory Planning (FIP);
      -- AND is non productive or unreported
      -- OR
        (
        (
          v.inventory_standard_cd = 'F' 
          AND
          (
          (v.non_productive_cd IS NOT NULL AND v.non_productive_cd <> '00') 
          OR
            (v.non_productive_descriptor_cd IS NOT NULL AND v.non_productive_descriptor_cd <> '00') 
          OR
            v.bclcs_level_1 = 'U'
          )
        )
      -- inventory code != Forest Inventory Planning (FIP);
      -- AND land cover classification either non-vegetated or unreported
      -- OR
      OR
        (
          v.inventory_standard_cd IN ('V', 'I', 'L') 
          AND 
          (
            v.bclcs_level_1 In ('N', 'U')
            OR
            v.bclcs_level_3 = 'A'
          )
        )
      OR
      -- site_index < 5
        (
          COALESCE(COALESCE(v.site_index, v.est_site_index),0) < 5
        )
        )
      then
        'N'
      else
        'Y'
    END fmlb_initial,
    inventory_standard_cd,
    earliest_nonlogging_dist_type,
    crown_closure,
    site_index,
    bclcs_level_1,
    bclcs_level_2,
    bclcs_level_3,
    project
FROM
  whse.veg_comp_lyr_r1_poly_internal_2023 v
)
SELECT
-- Some Fire Update polygons are flipped back from N to Y if they fall into the following pattern:
	CASE WHEN project ilike 'FIRE_UPDATE%' 
		AND inventory_standard_cd = 'V' 
		AND earliest_nonlogging_dist_type like 'B%' 
		AND crown_closure < 5
		AND site_index >= 5
		AND bclcs_level_1 = 'N'
		AND bclcs_level_2 = 'L'
		AND bclcs_level_3 = 'U'
		AND fmlb_initial = 'N'
	THEN 'Y' 
	ELSE fmlb_initial
	END AS fmlb_recreate
FROM
initial_for_mgmt_land_base_ind;
```
