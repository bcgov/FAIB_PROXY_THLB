---
title: "Provincial Netdown"
author: "Hailey Eckstrand"
date: "Last run on `r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    code_folding: hide
    # highlight: monochrome
    highlight: tango
    keep_md: yes
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
---

## Background

This report describes the data and methodology used to classify the Provincial THLB Proxy land base into four nested categories: Forest Management Land Base (FMLB), Forest Assessment Land Base (FALB), Analysis Forested Land Base (AFLB) and Timber Harvesting Land Base (THLB).

### Document setup

```{r r-version}
r_version <- R.version.string
```

This report is prepared using [RStudio](https://www.rstudio.com) and `r r_version`. All necessary R package libraries have been loaded into the work environment, and the required document elements have been set up.

```{r  setup, message = FALSE, warning = FALSE, results = 'hide'}

# load libraries:
library(knitr)
library(kableExtra)
library(tidyverse)
library(sf)
library(ggnewscale)
library(tidyterra)
library(tmap)
library(ggspatial)
library(scales)
library(cowplot)
library(mapview)
library(tidytext)
library(janitor)

rm(list = ls())

start<-Sys.time()

#knitr...read about knitr here: https://sachsmc.github.io/knit-git-markr-guide/knitr/knit.html
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(connection = "db")
knitr::opts_knit$set(sql.max.print = NA)
knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7, collapse = TRUE)

```

### Netdown process overview

The netdown process is a progressive exclusion algorithm where the BC land base is classified into four nested categories: FMLB, FALB, AFLB, and THLB:

To delineate the 4 land base categories, several deductions occur, each of which is described in detail in this document. For each deduction, two steps are followed:

1.  Categorize the area deduction in a *netdown dataframe:*
    -   The netdown dataframe includes a record for each hectare within the Province and multiple fields used to determine area deductions. For example:

    -   The FMLB, FALB, AFLB and THLB variables are updated with each area deduction. Initially, the FMLB, FALB, AFLB and THLB all have a value of one. The value gets updated with each area deduction. 

2.  Summarize the area deductions in a netdown summary table - the table summarizes area information for each area deduction:
    -   The **total** area is the gross area for the area deduction category/landclass,
    -   The **percent** is the percent of total landbase,
    -   The **excluded** value is the area that is excluded from the final THLB - the areas are excluded in the order they appear in the netdown summary table and account for areas excluded in previous deductions.
    -   The **running total** value is the combined total of excluded area for the landclass and each previous landclass identified in the table,
    -   The **netdown** is the remaining area after excluded area is removed. The final value (bottom row) is the THLB.

For example:

### Categorical vs. numerical area deduction variables

**Categorical** variables are nominal variables that describe the type of area being excluded - there is no intrinsic ordering or ranking within each categorical netdown variable. For example, the ownership description variable classifies each hectare by the excluded ownership type (e.g., private land, federal land, etc.). In the netdown dataframe, categorical variables are prefixed with "n" followed by the order in which they occur in the netdown process (e.g., n01_fmlb occurs first)

**Numerical** variables capture finer resolution (i.e. less than 100-meter resolution) area deductions and contain numeric values that define the proportion of a given hectare that will be excluded from the AFLB and THLB (e.g., 10% of a 1-hectare grid cell may be occupied by road). Numeric variable names are prefixed with "p" followed by the order in which they occur (e.g., p04_lineal_features occurs 4th in the netdown process).


## Data assembly

Prior to completing the netdown process that creates the netdown dataframe and thlb summary, pre-processing was performed to create tables that contribute to the creation of the netdown table.

### Netdown dataframe

Area deduction variables that are required to classify the land base are loaded into the netdown dataframe through a postgres query. FMLB, FALB, AFLB, and THLB variables are added to the dataframe with default values of 1. As the netdown process continues, new variables are added corresponding to each area deduction factor and the FMLB, FALB, AFLB, and THLB values are updated accordingly.

### Netdown summary table

The netdown summary table is initially created with the Provincial Boundary. As the netdown process progresses, each area deduction is appended as a new row.

**Data source:** S:\\FOR\\VIC\\HTS\\ANA\\workarea\\PROVINCIAL\\BC_Boundary_Terrestrial.tif

```{r netdown_import, eval=TRUE}
library(dadmtools)
library(dplyr)
library(knitr)
library(kableExtra)
library(tidyverse)
source('../utils/functions.R')

conn_list <- dadmtools::get_pg_conn_list()
## The following query was ran prior
## src\analysis\3.netdown-create-table.R
query <- "	SELECT 
  gr_skey,
  own,
  wha_label,
  harvest_restriction_class_name,
  land_designation_type_code,
	n01_fmlb,
	n02_ownership,
	n03_ownership,
	n04_nonfor,
	p05_linear_features,
	p06_riparian,
	p07_phys_inop,
	n08_merchantability
FROM thlb_proxy.prov_netdown net
WHERE man_unit = 'Boundary TSA'"
netdown_tab <- sql_to_df(query, conn_list)
netdown_summary <- setup_tracking_variable(netdown_tab)
running_total <- 0
pretty_table(netdown_summary)
```


## Netdown steps

Each netdown step (area deduction) is described in the following sub-sections.

## Delineating the FMLB

The following area deductions are removed from the Provincial Boundary area to classify the FMLB. The FMLB used for the provincial THLB Proxy is an adjusted version of the VRI field: `for_mgmt_land_base_ind`. A description and code snippet of the `for_mgmt_land_base_ind` is below. The field is a text field composed of either:

- 'N': non forested 
- 'Y': forested 

Description:

+ 'N' if BEC.natural_disturbance = 'NDT5'
+ 'Y' if harvest IS TRUE, (harvest is defined as: harvest is TRUE if vri.harvest_date is not null OR consolidated cutblocks exist OR vri.opening_id or vri.opening_number IS NOT NULL or '0' otherwise 'N')
+ 'Y' if (vri.bclcs_level_1 IN ('U', '') AND btm.present_land_use_label in ('Old Forest', 'Recently Logged', 'Selectively Logged', 'Young Forest'))
+ 'N' if bclcs_level_1 = 'V' AND bclcs_level_2 <> 'T' and vri.project NOT LIKE 'FIRE_UPDATE%'
+ 'N' if URBAN is true AND vri.for_mgmt_land_base_ind = 'Y', (URBAN defined as: URBAN IS TRUE if vri.non_productive_descriptor_cd = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' vri.OR land_cover_class_cd_3 = 'UR')
+ OTHERWISE vri.for_mgmt_land_base_ind

Code:
The following code snippet show's how `for_mgmt_land_base_ind` is derived.


```{sql fmlb_sql, eval= FALSE}
WITH recreate_for_mgmt_land_base_ind AS (
SELECT
  CASE
      -- when harvest does not exist
      WHEN (nullif(v.opening_id::text,'0') IS NULL AND nullif(v.opening_number::text,'0') IS NULL AND v.harvest_date IS NULL)
      -- AND
      AND
      -- inventory code = Forest Inventory Planning (FIP);
      -- AND is non productive or unreported
      -- OR
        (
        (
          v.inventory_standard_cd = 'F' 
          AND
          (
          (v.non_productive_cd IS NOT NULL AND v.non_productive_cd <> '00') 
          OR
            (v.non_productive_descriptor_cd IS NOT NULL AND v.non_productive_descriptor_cd <> '00') 
          OR
            v.bclcs_level_1 = 'U'
          )
        )
      -- inventory code != Forest Inventory Planning (FIP);
      -- AND land cover classification either non-vegetated or unreported
      -- OR
      OR
        (
          v.inventory_standard_cd IN ('V', 'I', 'L') 
          AND 
          (
            v.bclcs_level_1 In ('N', 'U')
            OR
            v.bclcs_level_3 = 'A'
          )
        )
      OR
      -- site_index < 5
        (
          COALESCE(COALESCE(v.site_index, v.est_site_index),0) < 5
        )
        )
      then
        'N'
      else
        'Y'
    END fmlb_initial,
    inventory_standard_cd,
    earliest_nonlogging_dist_type,
    crown_closure,
    site_index,
    bclcs_level_1,
    bclcs_level_2,
    bclcs_level_3,
    project
FROM
  whse.veg_comp_lyr_r1_poly_internal_2023 v
)
SELECT
-- Some Fire Update polygons are flipped back from N to Y if they fall into the following pattern:
	CASE WHEN project ilike 'FIRE_UPDATE%' 
		AND inventory_standard_cd = 'V' 
		AND earliest_nonlogging_dist_type like 'B%' 
		AND crown_closure < 5
		AND site_index >= 5
		AND bclcs_level_1 = 'N'
		AND bclcs_level_2 = 'L'
		AND bclcs_level_3 = 'U'
		AND fmlb_initial = 'N'
	THEN 'Y' 
	ELSE fmlb_initial
	END AS fmlb_recreate
FROM
recreate_for_mgmt_land_base_ind;
```


Below is a SQL snippet illustrating the logic used to build adjusted FMLB:

```{sql fmlb_adj_sql, eval= FALSE}
		CASE 
			WHEN bec.natural_disturbance = 'NDT5' THEN 'NDT5'
			-- if its been harvested then its forested
			WHEN (nullif(vri.opening_id::text,'0') is not null or nullif(vri.opening_number::text,'0') is not null or cc.harvest_start_year_calendar is not null or ccg.gr_skey is not null) THEN NULL
			-- bring back in btm forested
			WHEN (coalesce(vri.bclcs_level_1,'') IN ('U', '') AND btm.present_land_use_label IN ('Old Forest', 'Recently Logged', 'Selectively Logged','Young Forest')) THEN NULL
			-- exclude where vegetated, not treed and not fire_update
			WHEN vri.bclcs_level_1 = 'V' AND coalesce(vri.bclcs_level_2,'') <> 'T' AND vri.project NOT LIKE 'FIRE_UPDATE%' THEN 'not_treed_not_fire'
			-- exclude urban that has been classified as forested
			WHEN ((trim(vri.non_productive_descriptor_cd) = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' OR vri.land_cover_class_cd_3 = 'UR' OR vri.non_veg_cover_type_1 = 'UR')) AND (coalesce(vri.for_mgmt_land_base_ind,'Y') = 'Y') THEN 'URBAN and fmlb_orig = Y'
			WHEN vri.for_mgmt_land_base_ind = 'Y' THEN NULL
			WHEN vri.for_mgmt_land_base_ind = 'N' THEN 'fmlb_orig = N'
		END AS n01_fmlb
```

**Data sources:** WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_BASEMAPPING.BTM_PRESENT_LAND_USE_V1_SVW, WHSE_FOREST_VEGETATION.BEC_BIOGEOCLIMATIC_POLY


```{r fmlb, eval= TRUE}
netdown_tab <- netdown_tab %>%
  mutate(
    fmlb = 1,
    falb = 1,
    aflb = 1,
    thlb_net = 1
  )

lclass<-"FMLB"
n_step<-"n01_fmlb"

netdown_summary <- netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab <- update_areas_fmlb(netdown_tab,n_step)
running_total <- get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)

pretty_table(netdown_summary)
``` 


### FMLB Summary

```{r fmlb_landbase, eval= TRUE}
lclass<-"LANDBASE SUMMARY - FMLB"

netdown_summary <- landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=fmlb)

pretty_table(netdown_summary)
```


## Delineating the FALB

The following area deductions are removed from the FMLB to classify the FALB

### n02_ownership

The next phase of the netdown process delineates the FALB from the FMLB. The FALB excludes private, municipal and first nation reserve lands. Below is a specific list of ownership classes excluded:

+ 40N, Private, - Parcel has a title registered to a First Nations group
+ 41N, Private - Land Claim Settlement Area
+ 52N, Federal - Indian Reserve
+ 80N, Crown Municipal Parcels


```{r falb, eval= TRUE}

lclass<-"Ownership_Areas_Excluded_from_FALB"
n_step<-"n02_ownership"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_falb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

### FALB Summary

```{r falb_landbase, eval= TRUE}

lclass<-"LANDBASE SUMMARY - FALB"

netdown_summary <- landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=falb)

pretty_table(netdown_summary)
```

## Delineating the AFLB

The following area deductions are removed from the FALB to classify the AFLB

### n03_ownership

The next phase of the netdown process delineates the AFLB from the FALB. 
The FALB excludes the remaining federal lands. Below is a specific list of ownership classes excluded:

+ 50N, Federal - Federal Reserve
+ 51N, Federal - National Park
+ 53N, Federal - Military Reserve
+ 54N, Federal - Dominion government Block/Federal Parcels


```{r aflb_own, eval= TRUE}

lclass<-"Ownership_Areas_Excluded_from_AFLB"
n_step<-"n03_ownership"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_aflb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)

pretty_table(netdown_summary)
```


### n04_nonfor

The FALB land base is further excluded to create a 'not forested or non productive forest'.  These land cover types are not expected to contribute to either timber supply or non-timber management objectives that are based on forested conditions. Attributes that identify non-vegetated and various classes of vegetated areas are classified based on the BC land classification system (BCLCS), the Freshwater Atlas and the Biogeoclimatic Ecosystem Classification (BEC). Areas within historic cutblocks are considered forested and contribute to the THLB except where noted below.

Identifying non-forest/non-productive is done using a long 'case when' statement in a previous postgres table creation. In the netdown table each non-productive class is assigned it’s own descriptive label under the variable n04_nonfor.

**Data sources:** WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_BASEMAPPING.FWA_WETLANDS_POLY

Below is a SQL snippet illustrating the logic used to build non-productive and non-forest areas:

```{sql aflt_nonfor_sql, eval= FALSE}
		CASE 
			WHEN bec.natural_disturbance = 'NDT5' THEN 'NDT5'
			-- if its been harvested then its forested
			WHEN (nullif(vri.opening_id::text,'0') is not null or nullif(vri.opening_number::text,'0') is not null or cc.harvest_start_year_calendar is not null or ccg.gr_skey is not null) THEN NULL
			-- bring back in btm forested
			WHEN (coalesce(vri.bclcs_level_1,'') IN ('U', '') AND btm.present_land_use_label IN ('Old Forest', 'Recently Logged', 'Selectively Logged','Young Forest')) THEN NULL
			-- exclude where vegetated, not treed and not fire_update
			WHEN vri.bclcs_level_1 = 'V' AND coalesce(vri.bclcs_level_2,'') <> 'T' AND vri.project NOT LIKE 'FIRE_UPDATE%' THEN 'not_treed_not_fire'
			-- exclude urban that has been classified as forested
			WHEN ((trim(vri.non_productive_descriptor_cd) = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' OR vri.land_cover_class_cd_3 = 'UR' OR vri.non_veg_cover_type_1 = 'UR')) AND (coalesce(vri.for_mgmt_land_base_ind,'Y') = 'Y') THEN 'URBAN and fmlb_orig = Y'
			WHEN vri.for_mgmt_land_base_ind = 'Y' THEN NULL
			WHEN vri.for_mgmt_land_base_ind = 'N' THEN 'fmlb_orig = N'
		END AS n01_fmlb
```


```{r aflb_nonfor, eval= TRUE}
lclass<-"Non_Forest_and_Non_Productive_Forest"
n_step<-"n04_nonfor"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab<-update_areas_aflb(netdown_tab,n_step)

running_total<-get_running_total(netdown_summary,lclass)

pretty_table(netdown_summary)
```

### p05_linear_features

Productive forest land is lost due to permanent roads, trails, pipelines, transmission lines and other linear features (something relating to or consisting of lines (buffered)). Existing estimates of the area occupied by linear features is determined by applying average feature width buffers to the identified features.

The linear features table was created in July 2024 and reflects the 2021 CE Integrated roads dataset that includes roads and other linear features (railways, power lines, etc.). 

**Data source:** BC cumulative effects framework 2021 integrated roads dataset, WHSE_TANTALIS.TA_CROWN_RIGHTS_OF_WAY_SVW, WHSE_MINERAL_TENURE.OG_PIPELINE_AREA_PERMIT_SP, WHSE_IMAGERY_AND_BASE_MAPS.DRP_OIL_GAS_PIPELINES_BC_SP, WHSE_BASEMAPPING.GBA_TRANSMISSION_LINES_SP, WHSE_BASEMAPPING.GBA_RAILWAY_TRACKS_SP


```{r aflb_lin, eval= TRUE}
lclass<-"Linear_Features"
n_step<-"p05_linear_features"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)


netdown_tab <- netdown_tab %>%
mutate( aflb = aflb * (1-p05_linear_features),
thlb_net = thlb_net * (1-p05_linear_features)
)

running_total<-get_running_total(netdown_summary,lclass)

netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

### AFLB Summary

```{r aflb_landbase, eval= TRUE}
lclass<-"LANDBASE SUMMARY - AFLB"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=aflb)

pretty_table(netdown_summary)
```

## Write AFLB to Postgres

```{r aflb_to_pg, eval= FALSE}

df_to_pg(Id(schema = 'thlb_proxy', table = 'netdown_fmlb_falb_aflb'), netdown_tab[,c('gr_skey', 'fmlb', 'falb', 'aflb')], conn_list, overwrite=TRUE)
```

## Delineating the THLB

The next phase of the netdown process delineates the THLB from the AFLB. 

### n06_park


```{r thlb_parks, eval= TRUE}
lclass<-"Parks_and_Protected_Areas"
n_step<-"n06_park"

netdown_tab <- netdown_tab %>%
  mutate(n06_park = case_when(
  own  == '60N' ~ 'Conservancy_Ecological_Reserve_Protected_Area_Provincial_Park',
  own == '81U' ~ 'Local_Region_Park'))

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```


### n07_wha


```{r thlb_wha, eval= TRUE}
lclass<-"Wildlife_Habitat_Areas"
n_step<-"n07_wha"

netdown_tab <- netdown_tab %>%
  mutate(n07_wha = case_when(
  wha_label  == 'NO HARVEST ZONE' ~ 'NO HARVEST ZONE',
  wha_label == 'NO HARVEST' ~ 'NO HARVEST'))

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

### n08_harvest_restrictions


```{r thlb_rr, eval= TRUE}
lclass<-"Harvest_Restrictions"
n_step<-"n08_harvest_restrictions"

netdown_tab <- netdown_tab %>%
  mutate(n08_harvest_restrictions = case_when(
  harvest_restriction_class_name  == 'Prohibited' ~ glue('{harvest_restriction_class_name} - {land_designation_type_code}'),
  harvest_restriction_class_name == 'Protected' ~ glue('{harvest_restriction_class_name} - {land_designation_type_code}')))

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```




### p06_riparian

```{r thlb_rip, eval= TRUE}
lclass<-"Riparian_Buffers"
n_step<-"p06_riparian"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-p06_riparian)
  )

running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

### p07_phys_inop
To determine physically inoperable areas, elevation, slope and terrain stability mapping were assessed related to historic practice since 2014. 

For each TSA and TFL, binary rasters at 25-meter resolution were created to identify areas with slopes exceeding the 99th percentile within harvested cutblocks since 2014, areas with elevations exceeding 99th percentile within harvested cutblocks since 2014 and areas with unstable or potentially unstable slopes. These rasters were then combined to produce a single "physically inoperable" variable. Finally, the data was aggregated to a 1-hectare resolution to form a proportional inoperable variable.

Please note that when creating the 99th percentile threshold, it was required to have a minumum of 30 cutblocks within the TFL/TSA. If the unit did not have > 30 cutblocks, a TFL would using the threshold of the TSA the TFL overlaps with the most. Only TFL 43 had < 30 cutblocks, and instead, the thresolds from 39 - Sunshine Coast TSA were used for TFL 43.

```{r thlb_phys_inop, eval= TRUE}
lclass<-"Physical_Inoperable"
n_step<-"p07_phys_inop"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-p07_phys_inop)
  )

running_total<-get_running_total(netdown_summary,lclass)
pretty_table(netdown_summary)
```

### n08_merchantability

```{r thlb_merch, eval= TRUE}
lclass<-"Merchantability"
n_step<-"n08_merchantability"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```


### retention
Stand level retention refers to unharvested areas associated with individual cutblocks. An analysis of retention practices derived from RESULTS spatial data collected from 2012 to 2024 were utilized to estimate total stand level retention for the province.

The retention estimate includes areas occupied by biodiveristy, riparian retention, wildlife tree retention (grouped retention), as well as retention for the protection of forest values including archaeological features, site specific habitat features, and/or blue listed species or ecosystems. Stand level retention in the netdown process is modelled as an aspatial adjustment factor and applied to each hectare in the THLB, based on the geometric mean stand level retention for the TSA.

This approach recognises that although retention is not dispersed evenly across the land base the spatial variation in retention levels can be generalized across the land base without undue risk to yield estimation and forms a reasonable approximation for modelling timber supply in a TSA.

To calculate long-term retention, the percentage of coverage by RESULTS reserves relative to the total opening area was determined. Reserves with the Reserve Objective Codes "TIM" (Timber Objective) and "RMA" (Riparian Management Area) were excluded from this calculation. The "TIM" objective does not represent long-term retention, and riparian areas were excluded to avoid double-counting as they are addressed during a separate netdown step.

Additionally, the RESULTS reserves data was filtered to include:
+ Reserves with a silviculture reserve code of "G" (mapped reserves).
+ Disturbance data from 2012 onward, as the "G" reserve code was established in 2011 with a grace period of 1 year, before enforcement in 2012.
+ Only openings where the Opening Category Code is not in ('NREQ', 'SPEX', 'UHRV'), to exclude government-funded silviculture activities.

The distribution of the % retention over the opening was analyzed. A lower cutoff and an upper cutoff was developed to "clean" the data and to remove outliers. The weighted mean of the cleaned RESULTS dataset for each TSA was calculated as the preliminary stand level retention THLB reduction factor. 

The second phase of the process is to adjust the stand level retention reduction to THLB to account for land classes that have already been excluded from the THLB to avoid double counting. A spatial sample of the RESULTS retention dataset was examined through the netdown process to assess the amount of non-productive, inoperable or non merchantable forest that was generally retained within openings.


See below table of cutoffs and ..

```{r retention_table, eval= TRUE}
library(dadmtools)
query <- "SELECT * FROM thlb_proxy.retention_thresholds_man_unit ORDER BY man_unit"
df <- sql_to_df(query, conn_list)
pretty_table(df)
```

```{r retention, eval= FALSE}
lclass<-"Retention"
n_step<-"??"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```


### THLB Summary

```{r thlb_landbase, eval= TRUE}
lclass<-"LANDBASE SUMMARY - THLB"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=thlb_net)

pretty_table(netdown_summary)
```
