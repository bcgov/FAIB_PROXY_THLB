---
title: "Provincial THLB Proxy Netdown"
author: "Hailey Eckstrand"
date: "Last run on August 26, 2025"
output: 
  html_document:
    code_folding: hide
    # highlight: monochrome
    highlight: tango
    keep_md: yes
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
---

## Background

This report describes the data and methodology used to classify the Provincial Proxy THLB into four nested categories: Forest Management Land Base (FMLB), Forest Assessment Land Base (FALB), Proxy Analysis Forested Land Base (pAFLB) and Proxy Timber Harvesting Land Base (pTHLB).

### Document setup


``` r
r_version <- R.version.string
```

This report is prepared using [RStudio](https://www.rstudio.com) and R version 4.3.2 (2023-10-31 ucrt). All necessary R package libraries have been loaded into the work environment, and the required document elements have been set up.


``` r
# load libraries:
library(knitr)
library(kableExtra)
library(tidyverse)
library(sf)
library(ggnewscale)
library(tidyterra)
library(tmap)
library(ggspatial)
library(scales)
library(cowplot)
library(mapview)
library(tidytext)
library(janitor)
library(DT)

rm(list = ls())

start<-Sys.time()

#knitr...read about knitr here: https://sachsmc.github.io/knit-git-markr-guide/knitr/knit.html
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(connection = "db")
knitr::opts_knit$set(sql.max.print = NA)
knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7, collapse = TRUE)
```

### Netdown process overview

The netdown process is a progressive exclusion algorithm where the BC land base is classified into four nested categories: FMLB (Forest Management Land Base), FALB (Forest Assessment Land Base), pAFLB (Proxy Analysis Forest Land Base), and pTHLB (Proxy Timber Harvesting Land Base):


![](C:/projects/FAIB_PROXY_THLB/images/land_classification_diagram.png){width="656"}


To delineate the four land base categories, several deductions occur, each of which is described in detail in this document. The FMLB, FALB, pAFLB and pTHLB variables are updated with each landclass area deduction, also known as netdown inclusion factors. Initially, the FMLB, FALB, pAFLB and pTHLB all have a value of one. The values are updated accordingly with each netdown inclusion factor. 

The area deductions are then presented in a netdown summary table - the table summarizes area information for each netdown inclusion factor and land base:

- The **total** area is the gross area for the landclass area deduction OR land base,
- The **percent** is the percent of total netdown factor or land base relative to the provincial land base (first row Total),
- The **net_excluded** value is the net area that is excluded from the final FMLB, FALB, pAFLB and/or pTHLB (depending on which inclusion factor) - the areas are excluded in the order they appear in the netdown summary table and account for areas excluded in previous deductions.
- The **running total** value is the combined total of excluded area for the landclass and each previous landclass identified in the table,
- The **netdown** is the remaining area after the net excluded area is removed. The final value (bottom row) is the pTHLB.

For example:
![](C:/projects/FAIB_PROXY_THLB/images/netdown_explanation.png){width="656"}

### Categorical vs. numerical area deduction variables

**Categorical** variables are nominal variables that describe the type of area being excluded - there is no intrinsic ordering or ranking within each categorical netdown variable. For example, the ownership description variable classifies each hectare by the excluded ownership type (e.g., private land, federal land, etc.). In the netdown dataframe, categorical variables are prefixed with "n" followed by the order in which they occur in the netdown process (e.g., n01_fmlb occurs first).

**Numerical** variables capture finer resolution (i.e. less than 100-meter resolution) area deductions and contain numeric values that define the proportion of a given hectare that will be excluded from the pAFLB and pTHLB (e.g., 10% of a 1-hectare grid cell may be occupied by road). Numeric variable names are prefixed with "p" followed by the order in which they occur (e.g., p05_linear_features occurs 5th in the netdown process). Note, the "p" refers to proxy within these land base variables: pAFLB and pTHLB


## Data assembly

Prior to completing the netdown process that creates the netdown dataframe, pre-processing was performed to create tables that contribute to the creation of the netdown table. Within this document, the scripts used to import and pre-process the data into tables for that landclass are identified.

### Netdown dataframe

In a pre-processing step, the resultant table: `whse.thlb_proxy_netdown` was created which includes all landclass related fields (E.g. bclcs_level_1) required to calculate the landclass area deduction variables (e.g. n01_fmlb) as well as the calculated netdown inclusion factors themselves. This was done in a pre-processing step as memory limitations were encountered when calculating landclass area deduction variables within this R netdown script. As the netdown process continues, these pre-calculated netdown inclusion factors are used update the FMLB, FALB, pAFLB, and pTHLB values as needed. The following script is used to create the resultant table: `whse.thlb_proxy_netdown`:

```
src\analysis\3.netdown-create-table.R
```


### Netdown summary table

The netdown summary table is initially created with the Provincial Boundary. As the netdown process progresses, each landclass area deduction is appended as a new row. Each netdown inclusion factor (i.e. landclass area deduction) is described in the following sub-sections.


**Data source:** //spatialfiles2.bcgov/archive/FOR/VIC/HTS/ANA/workarea/PROVINCIAL/BC_Boundary_Terrestrial.tif


``` r
library(dadmtools)
library(dplyr)
library(knitr)
library(kableExtra)
library(tidyverse)
source('../utils/functions.R')

conn_list <- dadmtools::get_pg_conn_list()
## The following query was ran prior
## src\analysis\3.netdown-create-table.R
query <- "SELECT 
  p.gr_skey,
  p.tsa_rank1,
  p.wha_label,
  p.harvest_restriction_class_name,
  p.land_designation_type_code,
  p.harvest_start_year_calendar AS cc_year,
	p.current_retention,
	p.n01_fmlb,
	p.n02_ownership,
	p.n03_ownership,
	p.n04_nonfor,
	p.p05_linear_features,
	p.n06_parks,
	p.n07_wha,
	p.n08_misc,
	p.p09_riparian,
  p.n10_arch,
	p.n11_harvest_restrictions,
	p.p12_phys_inop,
	p.n13_non_merchantable,
	p.n14_non_commercial
FROM whse.thlb_proxy_netdown p"
netdown_tab <- sql_to_df(query, conn_list)
netdown_summary <- setup_tracking_variable(netdown_tab)
running_total <- 0
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
</tbody>
</table>



### Data Sources and Import Dates


``` r
library(dadmtools)
library(DT)

conn_list <- dadmtools::get_pg_conn_list()


my_table <- sql_to_df(r"(SELECT created_at::date as import_date, src_type, src_path, src_lyr, dst_schema, dst_tbl, query, notes FROM whse.data_sources where dst_schema != 'public' UNION ALL
select
'2025-08-12' as created_at,
'sqlite' as src_type,
'\\spatialfiles2.bcgov\work\FOR\VIC\HTS\DAM\Staff_WorkArea\heckstrand\thlb_proxy\local_inputs\final_gaps_current_noncurrent_lidar_treedPercent.sqlite' as src_path,
'gaps_current_noncurrent_lidar_treedpercent' as src_lyr,
'whse' as dst_schema,
'gaps_current_noncurrent_lidar_treedpercent' as dst_table,
'' as query,
'Provided by FAIB inventory lidar specialist' as notes
union all
select
'2025-08-12', -- created_at
'sqlite', -- src_type
'\\spatialfiles2.bcgov\work\FOR\VIC\HTS\DAM\Staff_WorkArea\heckstrand\thlb_proxy\local_inputs\final_gaps_lidarProgam_contained_treedpercent.sqlite',
'gaps_lidarprogam_contained_treedpercent', --src_lyr
'whse',-- dst_schema
'gaps_lidarprogam_contained_treedpercent', -- dst_table
'', --query
'Provided by FAIB inventory lidar specialist' -- notes

union all
select
'2025-08-20', -- created_at
'gdb', -- src_type
'\\spatialfiles2.bcgov\archive\FOR\VIC\HTS\ANA\workarea\AR2024\local_inputs\BC_CE_Integrated_Roads_2024_with_buffers.gdb',
'integratedRoadsBuffers', --src_lyr
'whse_vector',-- dst_schema
'integratedRoadsBuffers', -- dst_table
'', --query
'' -- notes

union all
select
'2025-08-20', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.GBA_RAILWAY_TRACKS_SP', --src_lyr
'whse_vector',-- dst_schema
lower('GBA_RAILWAY_TRACKS_SP'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-08-20', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.GBA_TRANSMISSION_LINES_SP', --src_lyr
'whse_vector',-- dst_schema
lower('GBA_TRANSMISSION_LINES_SP'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-08-20', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_IMAGERY_AND_BASE_MAPS.DRP_OIL_GAS_PIPELINES_BC_SP', --src_lyr
'whse_vector',-- dst_schema
lower('DRP_OIL_GAS_PIPELINES_BC_SP'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-08-20', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_MINERAL_TENURE.OG_PIPELINE_AREA_PERMIT_SP', --src_lyr
'whse_vector',-- dst_schema
lower('OG_PIPELINE_AREA_PERMIT_SP'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-08-20', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_TANTALIS.TA_CROWN_RIGHTS_OF_WAY_SVW', --src_lyr
'whse_vector',-- dst_schema
lower('TA_CROWN_RIGHTS_OF_WAY_SVW'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-08-20', -- created_at
'gdb', -- src_type
'\\spatialfiles2.bcgov\work\FOR\VIC\HTS\ANA\Workarea\PROVINCIAL\provincial.gdb',
'tsa_boundaries_2020', --src_lyr
'whse_vector',-- dst_schema
lower('tsa_boundaries_2020'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_FOREST_VEGETATION.RSLT_OPENING_SVW', --src_lyr
'whse_vector',-- dst_schema
lower('RSLT_OPENING_SVW'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_FOREST_VEGETATION.RSLT_FOREST_COVER_INV_SVW', --src_lyr
'whse_vector',-- dst_schema
lower('RSLT_FOREST_COVER_INV_SVW'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_FOREST_VEGETATION.bec_biogeoclimatic_poly', --src_lyr
'whse_vector',-- dst_schema
lower('bec_biogeoclimatic_poly'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.CWB_FLOODPLAINS_BC_AREA_SP', --src_lyr
'whse_vector',-- dst_schema
lower('CWB_FLOODPLAINS_BC_AREA_SP'), -- dst_table
'', --query
'' -- notes

union all
select
'2024-10-01', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.FWA_RIVERS_POLY', --src_lyr
'whse_vector',-- dst_schema
lower('FWA_RIVERS_POLY'), -- dst_table
'', --query
'' -- notes

union all
select
'2024-10-01', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.FWA_LAKES_POLY', --src_lyr
'whse_vector',-- dst_schema
lower('FWA_LAKES_POLY'), -- dst_table
'', --query
'' -- notes

union all
select
'2024-10-01', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.FWA_WETLANDS_POLY', --src_lyr
'whse_vector',-- dst_schema
lower('FWA_WETLANDS_POLY'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_BASEMAPPING.WLS_COMMUNITY_WS_PUB_SVW', --src_lyr
'whse_vector',-- dst_schema
lower('WLS_COMMUNITY_WS_PUB_SVW'), -- dst_table
'', --query
'' -- notes

union all
select
'2024-06-07', -- created_at
'gpkg', -- src_type
'\\spatialfiles2.bcgov\work\FOR\VIC\HTS\DAM\Staff_WorkArea\heckstrand\thlb_proxy\local_inputs\fish_passage_lines.gpkg',
'modelled_habitat_potential', --src_lyr
'whse_vector',-- dst_schema
lower('modelled_habitat_potential'), -- dst_table
'', --query
'Obtained from BC Fish Passage project lead' -- notes

union all
select
'2024-06-07', -- created_at
'csv', -- src_type
'\\spatialfiles2.bcgov\work\FOR\VIC\HTS\DAM\Staff_WorkArea\heckstrand\thlb_proxy\local_inputs\fwa_stream_networks_channel_width.csv',
'fwa_stream_networks_channel_width', --src_lyr
'whse_vector',-- dst_schema
lower('modelled_habitat_potential'), -- dst_table
'', --query
'Obtained from BC Fish Passage project lead' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_TERRESTRIAL_ECOLOGY.STE_TER_ATTRIBUTE_POLYS_SVW', --src_lyr
'whse_vector',-- dst_schema
lower('STE_TER_ATTRIBUTE_POLYS_SVW'), -- dst_table
'slope_stability_class_txt IN (''Potentially unstable'', ''Potentially unstable after road building'', ''Unstable'')', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP', --src_lyr
'whse_vector',-- dst_schema
lower('VEG_CONSOLIDATED_CUT_BLOCKS_SP'), -- dst_table
'', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_FOREST_TENURE.FTEN_MANAGED_LICENCE_POLY_SVW', --src_lyr
'whse_vector',-- dst_schema
lower('FTEN_MANAGED_LICENCE_POLY_SVW'), -- dst_table
'(Retirement_Date is Null or RETIREMENT_DATE > CURRENT_DATE) and FILE_STATUS_CODE = ''HI''', --query
'' -- notes

union all
select
'2025-07-22', -- created_at
'oracle', -- src_type
'bcgw',
'WHSE_ADMIN_BOUNDARIES.FADM_TFL_ALL_SP', --src_lyr
'whse_vector',-- dst_schema
lower('FADM_TFL_ALL_SP'), -- dst_table
'', --query
'' -- notes)", conn_list)



datatable(
  my_table,
  options = list(
    scrollX = TRUE, 
    columnDefs = list(
      list(width = '300px', targets = which(names(my_table) == "src_path") - 1)
    )
  )
) %>%
  formatStyle(
    columns = "src_path",
    whiteSpace = "normal",
    wordWrap = "break-word"
  )
```


```{=html}
<div class="datatables html-widget html-fill-item" id="htmlwidget-8a1613a33f7f4a0ea629" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-8a1613a33f7f4a0ea629">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","24","25","26","27","28","29","30","31","32","33","34","35","36","37","38","39","40","41"],["2025-07-21","2025-07-22","2025-07-22","2025-07-22","2025-07-22","2025-07-22","2025-07-22","2025-07-22","2025-07-22","2025-07-23","2025-07-31","2025-08-16","2025-08-19","2025-08-21","2024-10-17","2024-10-30","2024-12-10","2025-01-08","2025-08-12","2025-08-12","2025-08-20","2025-08-20","2025-08-20","2025-08-20","2025-08-20","2025-08-20","2025-08-20","2025-07-22","2025-07-22","2025-07-22","2025-07-22","2024-10-01","2024-10-01","2024-10-01","2025-07-22","2024-06-07","2024-06-07","2025-07-22","2025-07-22","2025-07-22","2025-07-22"],["oracle","oracle","oracle","gdb","oracle","gdb","oracle","oracle","oracle","oracle","oracle","oracle","gdb","oracle","gdb","oracle","gdb","oracle","sqlite","sqlite","gdb","oracle","oracle","oracle","oracle","oracle","gdb","oracle","oracle","oracle","oracle","oracle","oracle","oracle","oracle","gpkg","csv","oracle","oracle","oracle","oracle"],["bcgw","bcgw","bcgw","\\\\spatialfiles2.bcgov\\work\\for\\vic\\hts\\ana\\workarea\\provincial\\provincial.gdb","bcgw","\\\\spatialfiles2.bcgov\\work\\for\\vic\\hts\\dam\\data\\vri\\vri2024\\internal_copy_not_for_distribution\\veg_comp_2024_lyr_r1_poly.gdb","bcgw","bcgw","bcgw","bcgw","bcgw","bcgw","s:\\for\\vic\\hts\\faib_data_for_distribution\\forest_harvesting_restrictions\\harvest_restrictions_august_2025\\published_version\\forest_harvesting_restrictions.gdb","bcgw","w:\\for\\vic\\hts\\dam\\data\\vri\\tfl_integrated\\tfl_spatial_integration_2016_final3_deliveryv2.gdb","bcgw","c:\\projects\\thlb_proxy\\data\\input\\veg_comp_lyr_r1_poly1_2016\\veg_comp_lyr_r1_poly.gdb","bcgw","\\\\spatialfiles2.bcgov\\work\\FOR\\VIC\\HTS\\DAM\\Staff_WorkArea\\heckstrand\\thlb_proxy\\local_inputs\\final_gaps_current_noncurrent_lidar_treedPercent.sqlite","\\\\spatialfiles2.bcgov\\work\\FOR\\VIC\\HTS\\DAM\\Staff_WorkArea\\heckstrand\\thlb_proxy\\local_inputs\\final_gaps_lidarProgam_contained_treedpercent.sqlite","\\\\spatialfiles2.bcgov\\archive\\FOR\\VIC\\HTS\\ANA\\workarea\\AR2024\\local_inputs\\BC_CE_Integrated_Roads_2024_with_buffers.gdb","bcgw","bcgw","bcgw","bcgw","bcgw","\\\\spatialfiles2.bcgov\\work\\FOR\\VIC\\HTS\\ANA\\Workarea\\PROVINCIAL\\provincial.gdb","bcgw","bcgw","bcgw","bcgw","bcgw","bcgw","bcgw","bcgw","\\\\spatialfiles2.bcgov\\work\\FOR\\VIC\\HTS\\DAM\\Staff_WorkArea\\heckstrand\\thlb_proxy\\local_inputs\\fish_passage_lines.gpkg","\\\\spatialfiles2.bcgov\\work\\FOR\\VIC\\HTS\\DAM\\Staff_WorkArea\\heckstrand\\thlb_proxy\\local_inputs\\fwa_stream_networks_channel_width.csv","bcgw","bcgw","bcgw","bcgw"],["whse_admin_boundaries.adm_nr_regions_sp","whse_admin_boundaries.adm_nr_areas_spg","whse_admin_boundaries.adm_nr_districts_sp","tsa_boundaries_2020","whse_admin_boundaries.fadm_tfl_all_sp","veg_comp_lyr_r1_poly","whse_forest_vegetation.bec_biogeoclimatic_poly","whse_forest_vegetation.f_own","whse_forest_vegetation.rslt_forest_cover_reserve_svw","whse_forest_vegetation.veg_consolidated_cut_blocks_sp","whse_tantalis.ta_park_ecores_pa_svw","whse_wildlife_management.wcp_wildlife_habitat_area_poly","forest_harvesting_restrictions","whse_forest_tenure.ften_managed_licence_poly_svw","tfl_integratedv12_finalv3a","whse_basemapping.btm_present_land_use_v1_svw","veg_comp_lyr_r1_poly","whse_archaeology.raad_tfm_sites_svw","gaps_current_noncurrent_lidar_treedpercent","gaps_lidarprogam_contained_treedpercent","integratedRoadsBuffers","WHSE_BASEMAPPING.GBA_RAILWAY_TRACKS_SP","WHSE_BASEMAPPING.GBA_TRANSMISSION_LINES_SP","WHSE_IMAGERY_AND_BASE_MAPS.DRP_OIL_GAS_PIPELINES_BC_SP","WHSE_MINERAL_TENURE.OG_PIPELINE_AREA_PERMIT_SP","WHSE_TANTALIS.TA_CROWN_RIGHTS_OF_WAY_SVW","tsa_boundaries_2020","WHSE_FOREST_VEGETATION.RSLT_OPENING_SVW","WHSE_FOREST_VEGETATION.RSLT_FOREST_COVER_INV_SVW","WHSE_FOREST_VEGETATION.bec_biogeoclimatic_poly","WHSE_BASEMAPPING.CWB_FLOODPLAINS_BC_AREA_SP","WHSE_BASEMAPPING.FWA_RIVERS_POLY","WHSE_BASEMAPPING.FWA_LAKES_POLY","WHSE_BASEMAPPING.FWA_WETLANDS_POLY","WHSE_BASEMAPPING.WLS_COMMUNITY_WS_PUB_SVW","modelled_habitat_potential","fwa_stream_networks_channel_width","WHSE_TERRESTRIAL_ECOLOGY.STE_TER_ATTRIBUTE_POLYS_SVW","WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP","WHSE_FOREST_TENURE.FTEN_MANAGED_LICENCE_POLY_SVW","WHSE_ADMIN_BOUNDARIES.FADM_TFL_ALL_SP"],["whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector","whse_vector"],["adm_nr_regions_sp","north_south_coast","adm_nr_districts_sp","tsa_boundaries","fadm_tfl_all_sp","veg_comp_lyr_r1_poly_internal","bec_biogeoclimatic_poly","f_own","rslt_forest_cover_reserve_svw","veg_consolidated_cut_blocks_sp","ta_park_ecores_pa_svw","wcp_wildlife_habitat_area_poly","rr_restriction","ften_managed_licence_poly_svw","tfl_integrated2016","btm_present_land_use_v1_svw","veg_comp_lyr_r1_poly_2016","raad_tfm_sites_svw","gaps_current_noncurrent_lidar_treedpercent","gaps_lidarprogam_contained_treedpercent","integratedRoadsBuffers","gba_railway_tracks_sp","gba_transmission_lines_sp","drp_oil_gas_pipelines_bc_sp","og_pipeline_area_permit_sp","ta_crown_rights_of_way_svw","tsa_boundaries_2020","rslt_opening_svw","rslt_forest_cover_inv_svw","bec_biogeoclimatic_poly","cwb_floodplains_bc_area_sp","fwa_rivers_poly","fwa_lakes_poly","fwa_wetlands_poly","wls_community_ws_pub_svw","modelled_habitat_potential","modelled_habitat_potential","ste_ter_attribute_polys_svw","veg_consolidated_cut_blocks_sp","ften_managed_licence_poly_svw","fadm_tfl_all_sp"],["","","","","","","","","","","","timber_harvest_code IN ('NO HARVEST ZONE', 'NO HARVEST')",""," (Retirement_Date is Null or RETIREMENT_DATE &gt; CURRENT_DATE) and FILE_STATUS_CODE = 'HI'","","","","","","","","","","","","","","","","","","","","","","","","slope_stability_class_txt IN ('Potentially unstable', 'Potentially unstable after road building', 'Unstable')","","(Retirement_Date is Null or RETIREMENT_DATE &gt; CURRENT_DATE) and FILE_STATUS_CODE = 'HI'",""],["","For management unit table creation","For management unit table creation","For management unit table creation","For management unit table creation","","","","","","","","","For management unit table creation","","","Downloaded 2016 from: https://catalogue.data.gov.bc.ca/dataset/vri-historical-vegetation-resource-inventory-2002-2022-","","Provided by FAIB inventory lidar specialist","Provided by FAIB inventory lidar specialist","","","","","","","","","","","","","","","","Obtained from BC Fish Passage project lead","Obtained from BC Fish Passage project lead","","","",""]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>import_date<\/th>\n      <th>src_type<\/th>\n      <th>src_path<\/th>\n      <th>src_lyr<\/th>\n      <th>dst_schema<\/th>\n      <th>dst_tbl<\/th>\n      <th>query<\/th>\n      <th>notes<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"scrollX":true,"columnDefs":[{"width":"300px","targets":2},{"orderable":false,"targets":0},{"name":" ","targets":0},{"name":"import_date","targets":1},{"name":"src_type","targets":2},{"name":"src_path","targets":3},{"name":"src_lyr","targets":4},{"name":"dst_schema","targets":5},{"name":"dst_tbl","targets":6},{"name":"query","targets":7},{"name":"notes","targets":8}],"order":[],"autoWidth":false,"orderClasses":false,"rowCallback":"function(row, data, displayNum, displayIndex, dataIndex) {\nvar value=data[3]; $(this.api().cell(row, 3).node()).css({'white-space':'normal','word-wrap':'break-word'});\n}"}},"evals":["options.rowCallback"],"jsHooks":[]}</script>
```



## Delineating the FMLB


### n01_fmlb

The FMLB (Forest Management Land Base) represents the forested area within the province that is considered available for potential forest management activities. It was developed by the Ministry of Forests Forest Analysis and Inventory Branch (FAIB) and provided to the Old Growth Technical Advisory Panel (TAP) in 2021 to support their work in identifying and assessing old growth forests. 

The FMLB is primarily derived from the Vegetation Resources Inventory (VRI) attribute `for_mgmt_land_base_ind`, which indicates areas considered part of the forest management land base. However, FAIB refined this definition through review with satellite imagery, consultation with inventory specialists and guidance from the Biodiversity Guidebook to better align with the practical interpretation of forest cover, particularly in the context of assessing old growth and biodiversity. 

The resulting FMLB provides a standardized spatial representation of forested lands available for management, serving as a foundation for further analysis and decision-making related to old growth and broader forest management.

Since the field `for_mgmt_land_base_ind` plays a key role in the definition of the FMLB, the field definition and the SQL used to populate this VRI field is provided for transparency. The `for_mgmt_land_base_ind` attribute is a text field indicating whether an area is classified as forested or non-forested. It is populated based on the following logic:

- 'N': non forested 
- 'Y': forested 

Rules for populating `for_mgmt_land_base_ind`:

'N' is assigned if:

- 'The stand has never been harvested, AND
  - the inventory source is Forest Inventory Planning (FIP), and the area is either non-productive or BC Land Cover Classification Schema Level 1(bclcs) is unreported; OR
  - The inventory source is not FIP, and the bclcs level 3 is either non-vegetated or unreported or bclcs level 3 is alpine; OR
  - The site index or estimated site index (respectively) is less than 5.

'Y' is assigned if:

- None of the above conditions apply; OR
- The project type is a fire update, and the inventory source is FULL VRI, and the earliest non-logging disturbance type is burn/fire, and the crown closure is less than 5, and the site index is 5 or greater, and the BC Land Cover Classification System (BCLCS) values are as follows:
  - Level 1: Non-vegetated
  - Level 2: Non-treed
  - Level 3: Upland

VRI field definitions were found [here](https://www2.gov.bc.ca/assets/gov/farming-natural-resources-and-industry/forestry/stewardship/forest-analysis-inventory/data-management/standards/vegcomp_poly_rank1_data_dictionaryv5_2019.pdf).

As part of this project, an exercise was conducted to replicate the `for_mgmt_land_base_ind` VRI attribute in order to better understand it. This effort was successful when running against the 2023 VRI. The SQL used to recreate `for_mgmt_land_base_ind` is provided below for reference.



``` sql
WITH recreate_for_mgmt_land_base_ind AS (
SELECT
  CASE
      -- when harvest does not exist
      WHEN (nullif(v.opening_id::text,'0') IS NULL AND nullif(v.opening_number::text,'0') IS NULL AND v.harvest_date IS NULL)
      -- AND
      AND
      -- inventory code = Forest Inventory Planning (FIP);
      -- AND is non productive or unreported
      -- OR
        (
        (
          v.inventory_standard_cd = 'F' 
          AND
          (
          (v.non_productive_cd IS NOT NULL AND v.non_productive_cd <> '00') 
          OR
            (v.non_productive_descriptor_cd IS NOT NULL AND v.non_productive_descriptor_cd <> '00') 
          OR
            v.bclcs_level_1 = 'U'
          )
        )
      -- inventory code != Forest Inventory Planning (FIP);
      -- AND land cover classification either non-vegetated or unreported
      -- OR
      OR
        (
          v.inventory_standard_cd IN ('V', 'I', 'L') 
          AND 
          (
            v.bclcs_level_1 In ('N', 'U')
            OR
            v.bclcs_level_3 = 'A'
          )
        )
      OR
      -- site_index < 5
        (
          COALESCE(COALESCE(v.site_index, v.est_site_index),0) < 5
        )
        )
      then
        'N'
      else
        'Y'
    END fmlb_initial,
    inventory_standard_cd,
    earliest_nonlogging_dist_type,
    crown_closure,
    site_index,
    bclcs_level_1,
    bclcs_level_2,
    bclcs_level_3,
    project
FROM
  whse.veg_comp_lyr_r1_poly_internal v
)
SELECT
-- Some Fire Update polygons are flipped back from N to Y if they fall into the following pattern:
	CASE WHEN project ilike 'FIRE_UPDATE%' 
		AND inventory_standard_cd = 'V' 
		AND earliest_nonlogging_dist_type like 'B%' 
		AND crown_closure < 5
		AND site_index >= 5
		AND bclcs_level_1 = 'N'
		AND bclcs_level_2 = 'L'
		AND bclcs_level_3 = 'U'
		AND fmlb_initial = 'N'
	THEN 'Y' 
	ELSE fmlb_initial
	END AS fmlb_recreate
FROM
recreate_for_mgmt_land_base_ind;
```

The following adjustments were made based on a review of satellite imagery, consultation with inventory specialists, and guidance from the Biodiversity Guidebook. These changes were intended to better align the classification of forest cover with practical interpretations, particularly for assessing old growth and biodiversity. This definition was then later updated in 2025. The following rules were applied in this order:

- 'N' if BEC natural_disturbance = 'NDT5'; I.e. Alpine Tundra
- 'Y' if VRI non-zero opening_id exists or historical harvest (I.e., consolidated cutblock) exists; I.e. previously harvested
- 'N' if BEC zone is 'SWB' and BEC subzone is 'mks', 'uns', 'vks'; spruce-willow-birch shrublands
- 'N' if BEC zone = 'BG'; bunchgrass
- 'Y' if lidar derived tree cover over VRI polygon >= 10% and napercent of lidar coverage of VRI polygon < 25%; data only available where lidar data exists and VRI bclcs is unreported.
- 'N' if lidar derived tree cover over VRI polygon < 10% and napercent of lidar coverage of VRI polygon < 25%; ; data only available where lidar data exists and VRI bclcs is unreported.
- 'Y' if TFL = 19 and base thematic mapping classification (BTM) is Forested and VRI for_mgmt_land_base_ind = 'N' and VRI inventory_standard_cd = 'F' or for_mgmt_land_base_ind is NULL; fix where known old VRI data is incorrect within TFL 19
- 'Y' if Strathcona Park and BCLCS Level 1 = Vegetated and BCLCS Level 2 = Treed and Site Index > 4 and VRI for_mgmt_land_base_ind = 'N'; fix where known incorrect VRI data within Strathcona Park
- 'Y' if BCLCS Level 1 is Unreported or NULL and BTM is forested; infill where no VRI data
- 'N' if area is classified as URBAN AND  VRI for_mgmt_land_base_ind = 'Y', (URBAN defined as: URBAN IS TRUE if vri.non_productive_descriptor_cd = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' vri.OR land_cover_class_cd_3 = 'UR')
- 'N' if BCLCS Level 1 is Non-vegetated and earliest_nonlogging_dist_type is not 'IBM', 'B', 'NB'; I.e., non-veg and not disturbed by Mountain Pine Beetle or Wildfire
- 'Y' if BCLCS Level 1 is Vegetated, BCLCS Level 1 is non-vegetated, VRI for_mgmt_land_base_ind = 'Y', Crown Closure < 10, Land Cover Class Code 1 is null, BTM is forested and earliest_nonlogging_dist_type is not 'IBM', 'B', 'NB' (Mountain Pine Beetle & Wildfire)
- 'N' if BCLCS Level 1 is Vegetated, BCLCS Level 1 is non-vegetated, VRI for_mgmt_land_base_ind = 'Y', Crown Closure < 10, Land Cover Class Code 1 is not Treed (treed defined as 'TB', 'TC', 'TM'), and earliest_nonlogging_dist_type is not 'IBM', 'B', 'NB' (Mountain Pine Beetle & Wildfire)

OTHERWISE retain VRI for_mgmt_land_base_ind


Below is a SQL snippet illustrating the logic used to build the newly adjusted FMLB. It is done using a long 'case when' statement. In the netdown table, when adjusted to 'N', its assigned it's own descriptive label under the variable n01_fmlb. If 'Y', the label is set to NULL. 


``` sql
	CASE 
		-- remove BEC NDT5 — Alpine Tundra and Subalpine Parkland
		WHEN bec.natural_disturbance = 'NDT5' THEN 'BEC NDT5'
		-- keep in any RESULTS openings or consolidated cutblocks
		WHEN (nullif(vri.opening_id::text,'0') is not null or cc.harvest_start_year_calendar is not null) THEN NULL
		-- remove spruce, willow, birch shrublands
		WHEN upper(bec.zone || bec.subzone) IN ('SWBMKS', 'SWBUNS', 'SWBVKS') then 'BEC spruce-willow-birch shrublands'
		-- remove all bec bunch grass
		WHEN bec.zone = 'BG' THEN 'BEC bunchgrass'
		-- current & historical lidar
		-- include in FMLB if >= 10% treed & napercent < 25%
		-- exclude from FMLB if < 10% treed percent & na percent < 25%
		WHEN current_lidar.treedpercent >= 10 and current_lidar.napercent < 25 then NULL
		WHEN current_lidar.treedpercent < 10 and current_lidar.napercent < 25 then 'Lidar < 10% treed %'
		WHEN hx_lidar.treedpercent >= 10 and hx_lidar.napercent < 25 then NULL
		WHEN hx_lidar.treedpercent < 10 and hx_lidar.napercent < 25 then 'Lidar < 10% treed %'
		-- keep in where VRI is unreported but btm present land use is forested
		-- keep in where TFL 19, btm forest and inv != F or orig FMLB is null
		-- known old growth in TFL19 where old inventory
		WHEN 
			tfl.forest_file_id ='TFL19' and 
			((vri.for_mgmt_land_base_ind = 'N' and vri.inventory_standard_cd = 'F') OR (vri.for_mgmt_land_base_ind IS NULL)) and 
			btm.present_land_use_label in ('Old Forest', 'Recently Logged', 'Selectively Logged', 'Young Forest') 
		THEN NULL
		-- keep in known areas of forest in strathcona park 
		WHEN 
			park.protected_lands_name = 'STRATHCONA PARK' AND 
			vri.bclcs_level_1 ='V' AND 
			vri.bclcs_level_2 = 'T' AND 
			vri.site_index > 4 AND
			vri.for_mgmt_land_base_ind ='N' 
		THEN NULL
		-- keep in where VRI is unreported but btm present land use is forested
		WHEN 
			(coalesce(vri.bclcs_level_1,'U') = 'U' AND 
			btm.present_land_use_label IN ('Old Forest', 'Recently Logged', 'Selectively Logged', 'Young Forest')) 
		THEN NULL
		-- remove where original for_mgmt_land_base_ind = 'Y' but other fields denote unreported
		WHEN 
			((trim(vri.non_productive_descriptor_cd) = 'U' OR 
			vri.bclcs_level_5 = 'UR' OR 
			vri.land_cover_class_cd_1 = 'UR' OR 
			vri.land_cover_class_cd_2 = 'UR' OR 
			vri.land_cover_class_cd_3 = 'UR' OR 
			vri.non_veg_cover_type_1 = 'UR')) AND 
			(coalesce(vri.for_mgmt_land_base_ind,'Y') = 'Y') 
		THEN 'unreported/urban'
		-- remove where bclcs_level_1 is Non Vegetated and not beetle kill or wildfire
		-- avoid switching to N when it is beetle kill or wildfire
		WHEN 
			coalesce(vri.bclcs_level_1, 'U') = 'N' AND 
			COALESCE(earliest_nonlogging_dist_type, 'ZZ') not in ('IBM', 'B', 'NB')  
		THEN 'bclcs nonveg, not beetle kill or burn'
		-- keep in veg / non treed / CC < 10 / land cover class IS NULL / not beetle kill (IBM) or wildfire (B, NB) / FMLB original = 'Y' / forested according to feds
		WHEN 
			vri.BCLCS_LEVEL_1 = 'V' AND 
			COALESCE(vri.BCLCS_LEVEL_2, '') <> 'T' AND 
			vri.FOR_MGMT_LAND_BASE_IND = 'Y' AND 
			vri.CROWN_CLOSURE < 10 AND 
			vri.LAND_COVER_CLASS_CD_1 IS NULL AND
			btm.present_land_use_label in ('Old Forest', 'Recently Logged', 'Selectively Logged', 'Young Forest') AND
			COALESCE(earliest_nonlogging_dist_type, 'ZZ') not in ('IBM', 'B', 'NB')
		THEN NULL
		-- remove where veg / non treed / CC < 10 / land cover class not tree classes / not beetle kill (IBM) or wildfire (B, NB) / FMLB original = 'Y'
		-- https://archive.ipcc.ch/ipccreports/sres/land_use/index.php?idp=124
		WHEN 
			vri.BCLCS_LEVEL_1 = 'V' AND 
			COALESCE(vri.BCLCS_LEVEL_2, '') <> 'T' AND 
			vri.FOR_MGMT_LAND_BASE_IND = 'Y' AND 
			vri.CROWN_CLOSURE < 10 AND 
			coalesce(vri.LAND_COVER_CLASS_CD_1, '') NOT IN ('TB', 'TC', 'TM') AND 
			COALESCE(earliest_nonlogging_dist_type, 'ZZ') not in ('IBM', 'B', 'NB')
		THEN 'veg, nontreed etc'
		WHEN vri.for_mgmt_land_base_ind  = 'N' then 'for_mgmt_land_base_ind = N'
		WHEN vri.for_mgmt_land_base_ind  = 'Y' then NULL
		END AS n01_fmlb
```

**Data sources:** BCGW files: WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_BASEMAPPING.BTM_PRESENT_LAND_USE_V1_SVW, WHSE_FOREST_VEGETATION.BEC_BIOGEOCLIMATIC_POLY, WHSE_TANTALIS.TA_PARK_ECORES_PA_SVW, WHSE_ADMIN_BOUNDARIES.FADM_TFL_ALL_SP, Internal Lidar Dataset

__R Scripts__

The following scripts were used to perform this netdown factor's pre-processing: 

```
src\analysis\1.fmlb-import-layers.R
src\analysis\2.fmlb-creation.R
```

#### Non-Forest Summary
The FMLB, FALB, pAFLB and pTHLB variables are updated in the netdown dataframe and the netdown summary is updated to show the areas excluded from the province.


``` r
netdown_tab <- netdown_tab %>%
  mutate(
    fmlb = 1,
    falb = 1,
    aflb = 1,
    thlb_net = 1
  )

lclass<-"FMLB"
n_step<-"n01_fmlb"

netdown_summary <- netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab <- update_areas_fmlb(netdown_tab,n_step)
running_total <- get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.00000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.11151 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
</tbody>
</table>




### FMLB Land base Summary


``` r
lclass<-"LAND BASE SUMMARY - FMLB"

netdown_summary <- landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=fmlb)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.00000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.11151 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.88849 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
</tbody>
</table>




## Delineating the FALB

The FALB (Forest Assessment Land Base) is the portion of the FMLB that is on either provincial publicly managed lands or federal publicly managed lands.  It specifically excludes private, municipal, and first nation reserve lands.  It was originally conceived during the work conducted by the Old Growth Technical Advisory Panel (TAP) in 2021 and in consultation with ministry staff. The following area deductions are removed from the FMLB to classify the FALB.

### n02_ownership

The FALB excludes private, municipal and first nation reserve lands. A specific list of ownership classes excluded is found below. In the netdown table each ownership class is assigned it’s own descriptive label under the variable n02_ownership.

+ 40N, Private, - Parcel has a title registered to a First Nations group
+ 41N, Private - Land Claim Settlement Area
+ 52N, Federal - Indian Reserve
+ 80N, Crown Municipal Parcels

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN

__R Scripts__

No pre-processing was performed on the ownership layer. The dadmtools library was used to import the ownership layer:

```
src\analysis\0.setup-and-import-data-sources.R
```

#### Ownership Summary
The FALB, pAFLB and pTHLB variables are updated in the netdown dataframe and the netdown summary is updated to show the areas excluded from the province.


``` r

lclass<-"Ownership_Areas_Excluded_from_FALB"
n_step<-"n02_ownership"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_falb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.111509 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.888491 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.152813 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
</tbody>
</table>



### FALB Land base Summary


``` r

lclass<-"LAND BASE SUMMARY - FALB"

netdown_summary <- landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=falb)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.111509 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.888491 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.152813 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.890873 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
</tbody>
</table>



## Delineating the pAFLB

The next phase of the netdown process delineates the pAFLB from the FALB. The following area deductions are removed from the FALB to classify the pAFLB.

### n03_ownership

Some areas within the province do not contribute to timber supply for the purpose of this timber supply review. These areas include the remaining federal lands. A specific list of ownership classes excluded is included below. The n03_ownership field is added to the netdown dataframe and includes the description of the ownership category that is being excluded from the land base.

+ 50N, Federal - Federal Reserve
+ 51N, Federal - National Park
+ 53N, Federal - Military Reserve
+ 54N, Federal - Dominion government Block/Federal Parcels

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN

__R Scripts__

No pre-processing was performed on the ownership layer. The dadmtools library was used to import the ownership layer:

```
src\analysis\0.setup-and-import-data-sources.R
```

#### Ownership Summary
The pAFLB and pTHLB variables are updated in the netdown dataframe and the netdown summary is updated to show the areas excluded from the province.


``` r

lclass<-"Ownership_Areas_Excluded_from_pAFLB"
n_step<-"n03_ownership"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_aflb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
</tbody>
</table>




### n04_nonfor

The FALB land base is further excluded to create a 'not forested or non productive forest'.  These land cover types are not expected to contribute to either timber supply or non-timber management objectives that are based on forested conditions. Attributes that identify non-vegetated and various classes of vegetated areas are classified based on the BC land classification system (BCLCS), the Freshwater Atlas (FWA) and the Biogeoclimatic Ecosystem Classification (BEC). Areas within historic harvested openings are considered forested and contribute to the pTHLB except where noted below.

Identifying non-forest/non-productive is done using a long 'case when' statement in a previous postgres table creation. In the netdown table each non-productive class is assigned it’s own descriptive label under the variable n04_nonfor.

**Data sources:** BCGW files: WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_BASEMAPPING.FWA_WETLANDS_POLY

Below is a SQL snippet illustrating the logic used to build non-productive and non-forest areas:


``` sql
		 CASE
		 	-- ALPINE
		 	WHEN vri.bclcs_level_1 = 'N' AND vri.bclcs_level_3 = 'A' THEN 'non_vegetated_alpine_lcs' -- Alpine Rock and Ice
		 	WHEN vri.bclcs_level_2 = 'N' AND vri.bclcs_level_3 = 'A' THEN 'non_treed_alpine_lcs' -- Shrub/Lichen
		 	WHEN bec.bgc_label IN ('BAFAun', 'IMA') THEN 'alpine_bec' -- # BEC sourced Alpine,
		 	-- RIPARIAN
		 	WHEN vri.bclcs_level_1 = 'N' AND vri.bclcs_level_5 = 'LA' THEN 'lake_lcs' -- lakes
		 	WHEN vri.bclcs_level_1 = 'N' AND vri.bclcs_level_5 = 'RE' THEN 'reservoir_lcs' -- reservoir
		 	WHEN vri.bclcs_level_1 = 'N' AND vri.bclcs_level_5 = 'RI' THEN 'riparian_lcs' -- riparian
		 	WHEN vri.bclcs_level_2 = 'T' AND vri.bclcs_level_3 = 'W' THEN 'treed_wetland_lcs' -- treed wetland
		 	WHEN vri.bclcs_level_2 = 'N' AND vri.bclcs_level_3 = 'W' THEN 'non_treed_wetland_lcs'
		 	WHEN vri.bclcs_level_3 = 'W' THEN 'wetlands_lcs' -- nontreed wetland
		 	WHEN wet.waterbody_type = 'W' THEN 'wetland_fwa' -- FWA classification
		 	--  NonVegetated/low productivity
		 	WHEN vri.bclcs_level_1 = 'N' AND cc.harvest_start_year_calendar is null THEN 'non_vegetated_lcs' -- nonvegetated and not an opening
		 	WHEN vri.bclcs_level_2 = 'N' AND vri.bclcs_level_4 NOT IN ('ST', 'SL') AND cc.harvest_start_year_calendar is null THEN 'non_treed_herb_lcs' -- nontreed but not in a cutblock
		 	WHEN vri.bclcs_level_4 IN ('ST', 'SL') AND cc.harvest_start_year_calendar is null THEN 'non_treed_shrub_lcs'
		 	WHEN vri.site_index < 5 AND cc.harvest_start_year_calendar is null THEN 'non_productive_si_vri' -- low productivity stands
		 	WHEN vri.non_productive_descriptor_cd is not null AND cc.harvest_start_year_calendar is null THEN 'FC1_' || vri.non_productive_descriptor_cd -- stand classified in the FC1 as nonproductive
		 	WHEN vri.bclcs_level_1 || vri.bclcs_level_2 = 'VT' AND vri.species_cd_1 is null THEN 'no_species_cd_1' -- species label
		 	WHEN vri.bclcs_level_1 = 'U' OR vri.bclcs_level_1 is null THEN 'unclassified'
		 	ELSE NULL
		 END as n04_nonfor
```

__R Scripts__

No pre-processing was performed on the layers used to derive this netdown factor. The dadmtools library was used to import the required layers:

```
src\analysis\0.setup-and-import-data-sources.R
```

#### Non-Forest and Non-Productive Summary
The pAFLB and pTHLB variables are updated in the netdown dataframe and the netdown summary is updated to show the areas excluded from the province.



``` r
lclass<-"Non_Forest_and_Non_Productive_Forest"
n_step<-"n04_nonfor"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab<-update_areas_aflb(netdown_tab,n_step)

running_total<-get_running_total(netdown_summary,lclass)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
</tbody>
</table>



### p05_linear_features

Productive forest land is permanently lost due to the development of roads, trails, pipelines, transmission lines, and other linear infrastructure features. These features, characterized by their linear nature, are typically represented using buffered areas to approximate their footprint.

Existing estimates of the area affected by linear features are derived by applying standardized buffer widths to the identified features.

The linear features table was created in AUg 2025 and is based on the 2024 Cumulative Effects (CE) Integrated Roads Dataset, incorporating the FAIB Analysis Ready Dataset (ARD) buffer standards. Additional linear features such as railways, transmission lines, pipelines, and rights-of-way are also included, with the following buffer widths applied:

 - Railways: 15m
 - Transmission Lines: 25m
 - Oil and Gas Pipelines: 15m
 - Oil and Gas Pipeline Right of Way 15m
 - Rights of Way (no buffer)
 
 __Application in Land Base Classification:__
 
For linear features, the pAFLB, and pTHLB are multiplied by one minus the proportion linear features:

 - pAFLB = pAFLB * (1- proportion linear features),
 - pTHLB = pTHLB * (1- proportion linear features)
 
In the netdown table, each record is assigned the proportion of the cell covered by linear features, represented by the variable p05_linear_features.

**Data source:** BC cumulative effects framework 2024 integrated roads dataset, WHSE_TANTALIS.TA_CROWN_RIGHTS_OF_WAY_SVW, WHSE_MINERAL_TENURE.OG_PIPELINE_AREA_PERMIT_SP, WHSE_IMAGERY_AND_BASE_MAPS.DRP_OIL_GAS_PIPELINES_BC_SP, WHSE_BASEMAPPING.GBA_TRANSMISSION_LINES_SP, WHSE_BASEMAPPING.GBA_RAILWAY_TRACKS_SP

__R Scripts__

The following scripts were used to perform pre-processing:

```
src\analysis\1.linear-features-import-layers.R
src\analysis\3.linear-features-raster-weight.R
```

#### Linear Features Summary


``` r
lclass<-"Linear_Features"
n_step<-"p05_linear_features"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)


netdown_tab <- netdown_tab %>%
mutate( aflb = aflb * (1-p05_linear_features),
thlb_net = thlb_net * (1-p05_linear_features)
)

running_total<-get_running_total(netdown_summary,lclass)

netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
</tbody>
</table>



### pAFLB Land base Summary


``` r
lclass<-"LAND BASE SUMMARY - pAFLB"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=aflb)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
</tbody>
</table>




## Delineating the pTHLB

The next phase of the netdown process delineates the pTHLB from the pAFLB. 

### n06_park
BC has an extensive protected areas strategy that was developed to protect natural, cultural and recreational values. Protection is afforded under several Acts including the Ecological Reserves Act, Park Act, Protected Areas Act and Environment and Land Use Act. These types of protected areas within the province will be considered part of the pAFLB and contribute to objectives for biodiversity and wildlife. However, these areas are not administered by the Ministry of Forests (MOF) for timber supply and thus are excluded from the pTHLB. Once again the ownership code is used to identify protected areas to be excluded during the netdown process.

Below is a specific list of ownership classes excluded:

+ 60N, Crown - Ecological Reserve
+ 60N, Crown – Provincial Park 
+ 60N, Crown – Protected Area 
+ 60N, Crown - Conservancy Area
+ 81U, Local/Regional Park

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN

__R Scripts__

No pre-processing was performed on the ownership layer. The dadmtools library was used to import the ownership layers:

```
src\analysis\0.setup-and-import-data-sources.R
```

#### Parks and Protected Areas Summary


``` r
lclass<-"Parks_and_Protected_Areas"
n_step<-"n06_parks"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,444 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
</tbody>
</table>




### n07_wha
In British Columbia, wildlife habitat requirements are managed through several tools, including wildlife habitat areas (WHAs). WHAs are mapped areas that are necessary to meet the habitat requirements of an Identified Wildlife element. WHAs designate critical habitats in which activities are managed to limit their impact on the identified wildlife element for which the area was established. The purpose of WHAs is to conserve those habitats considered most limiting to a given Identified Wildlife element. The WHAs that prohibit timber harvesting are excluded from the pTHLB.

**Data sources:** BCGW file: WHSE_WILDLIFE_MANAGEMENT.WCP_WILDLIFE_HABITAT_AREA_POLY

__R Scripts__

No pre-processing was performed on the ownership layer. The dadmtools library was used to import the wildlife habitat layer. Please note that the layer was filtered for to only include where timber_harvest_code IN ('NO HARVEST ZONE', 'NO HARVEST'):

```
src\analysis\0.setup-and-import-data-sources.R
```

#### Wildlife Habitat Areas Summary


``` r
lclass<-"Wildlife_Habitat_Areas"
n_step<-"n07_wha"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,444 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
</tbody>
</table>




### n08_misc
Miscellaneous tenures including the following ownership classes:

+ 69U, Crown - Misc. Reserves
+ 69U, Crown - Watershed Reserve
+ 99N, Crown – Misc. lease


Please note that the proxy THLB does not exclude the following ownership class:
+ 69U, Crown - Misc. Reserves Caribou

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN

__R Scripts__

No pre-processing was performed on the ownership layer. The dadmtools library was used to import the ownership layers:

```
src\analysis\0.setup-and-import-data-sources.R
```

#### Miscellaneous Tenures Summary


``` r
lclass <- "Misc_Tenures"
n_step <- "n08_misc"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,444 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,520 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
</tbody>
</table>




### p09_riparian
Riparian areas occur next to the banks or edges of streams, lakes, and wetlands.  Riparian areas frequently contain the highest number of plant and animal species found in forests, and provide critical habitats, home ranges, and travel corridors for wildlife.  Biologically diverse, these areas maintain ecological linkages throughout the forest landscape, connecting hillsides to streams and upper headwaters to lower valley bottoms.

Management requirements for riparian areas are specified in the Forest Planning and Practices Regulation (FPPR). The intent of these requirements is to minimize or prevent impacts of forestry and range activity on aquatic resource values (e.g., water quality, aquatic ecosystems) and on the values within the surrounding area (e.g., wildlife habitat).

The FPPR specifies riparian classes for streams, wetlands and lakes.  See here for classification FPPR [guidelines](https://www.bclaws.gov.bc.ca/civix/document/id/complete/statreg/14_2004#division_d2e9829). In order to determined the riparian buffer to apply to the different classes, the the [Riparian management area guidebook](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/silviculture/silvicultural-systems/silviculture-guidebooks/riparian-management-area-guidebook) was used. 

__R Scripts__

The following R scripts were used to import all needed data sources, post process imported datasets, perform riparian classification, buffer the riparian classifications and create a raster with a proportion (i.e. number between 0-1) of riparian area coverage per pixel.

```
src\analysis\1.riparian-import-layers.R
src\analysis\2.riparian-fwapg-pre-processing.R
src\analysis\3.riparian-classification.R
```

__Application in Land Base Classification:__


__Note: The riparian netdown inclusion factor also includes the area of the lakes, wetlands and rivers in addition to the buffered areas. As such, the total 'riparian area' will seem larger than expected. As lakes, rivers and wetlands were all netted out in a previous step, the net_excluded value will reflect only the buffered areas and not the area of the lakes, wetlands and rivers.__

Similar to other proportional netdown factors, the pTHLB is multiplied by 1-proportion identified as riparian retention. For example, if pthlb_net is 0.9 prior to excluding riparian retention and the riparian retention is 0.3, the updated pthlb_net for that cell becomes 0.9*(1-0.3) = 0.63.

In the netdown table, each record is assigned the proportion of the cell considered riparian retention, represented by the field p09_riparian.

<details>
  <summary> [Expand for a detailed breakdown of the riparian analysis, including the data sources, methodology, buffers widths for each riparian class.] </summary>
  <br>

__Data Sources__

Data accessed June, 2024
BCGW Layers:

* FWA Wetlands, metadata [link](https://catalogue.data.gov.bc.ca/dataset/freshwater-atlas-wetlands)
* FWA Lakes, metadata [link](https://catalogue.data.gov.bc.ca/dataset/freshwater-atlas-lakes)
* FWA Stream Network, metadata [link](https://catalogue.data.gov.bc.ca/dataset/freshwater-atlas-stream-network)
* FWA Rivers, metadata [link](https://catalogue.data.gov.bc.ca/dataset/freshwater-atlas-rivers)
+ Community Watersheds - Current, metadata [link](https://catalogue.data.gov.bc.ca/dataset/community-watersheds-current)
+ BEC map, metadata [link](https://catalogue.data.gov.bc.ca/dataset/bec-map)
+ Mapped Floodplains in BC (Historical), metadata [link](https://catalogue.data.gov.bc.ca/dataset/mapped-floodplains-in-bc-historical-study-area-limits)

Externally provided data sources:

+ Provincial Fish Habitat Accessibility MODEL to determine fish presence/absence
+ Modeled channel width


<details>
  <summary> [Expand for further details about data sources.]  </summary>
  <br>
  
* __Fish Habitat Accessibility MODEL__ - Fish presence/absence is required to determine stream classification. The provincial BC Fish Passage database was obtained with the approval of project lead. Approval was granted provided the usage is not for operational purposes as the model is only appropriate for use as a broad landscape analysis tool. The dataset is identical to the FWA stream network table but divided into smaller segments. The dataset contains linear_feature_id, allowing it to be related to the FWA stream network table.
  + Filename: `data/input/fishpassage.gpkg.zip`

* __Channel width__ - A dataset including the modelled channel width for all FWA stream segments in the province. The channel width model is invalid when the contributing area is outside BC. As there is no field within the channel width table provided, a different data source was used to identify streams with a contributing area outside BC. See `src\analysis\2.riparian-fwapg-pre-processing.R` for steps used. The dataset contains linear_feature_id, allowing them to be related to the FWA stream network table. For this analysis, stream reaches with a contributing area outside BC were identified manually and set to NULL. A stream order based method was used in lieu of not having channel width when determining riparian classes. 
  + Filename: `data/input/fwa_stream_networks_channel_width.csv.gz`


Description of how channel width was calculated:  
•	_“To obtain estimates of channel width upstream of crossing locations, where available, bcfishpass was utilized to pull average channel gradients from Fisheries Information Summary System (FISS) site assessment data (MoE 2019b) or PSCIS assessment data (MoE 2021) and associate with stream segment lines. When both FISS and PSCIS values were associated with a particular stream segment, or multiple FISS channel widths are available a mean of the average channel widths was used. To model channel width for 2nd order and above stream segments without associated FISS or PSCIS sites, first fwapg was used to estimate the drainage area upstream of the segment. Then, rasters from ClimateBC (Wang et al. 2012) were downloaded to a postgresql database, sampled for upstream watershed areas associated with each stream segment and a mean annual precipitation weighted by upstream watershed area was calculated. In early 2021, Bayesian statistical methods were developed to predict channel width in all provincial freshwater atlas stream segments where width measurements had not previously been measured in the field. The model was based on the relationship between watershed area and mean annual precipitation weighted by upstream watershed area (Thorley and Irvine 2021). In December of 2021, Thorley and Irvine (2021) methods were updated using on a power model derived by Finnegan et al. (2005) which relates stream discharge to watershed area and mean annual precipitation. Data (n = 24849) on watershed size, mean annual precipitation and measured channel width was extracted from the provincial freshwater atlas (FLNRORD 2021; GeoBC 2022), the BC Data Catalogue fisheries datasets (MoE 2020b, 2021) and Wang et al. (2012) utilizing bcfishpass (Norris [2020] 2021) and fwapg (Norris [2019] 2021). Details of this analysis and subsequent outputs can be reviewed [here](https://www.poissonconsulting.ca/f/859859031) (Thorley, Norris, and Irvine 2021).”_  Reference: BC Fish Passage [paper](https://a100.gov.bc.ca/pub/acat/documents/r62435/PEA_F23_F_3761_DCA_1697814406164_EFF767D4C4.pdf)

Channel width code - https://github.com/smnorris/fwapg/tree/main/extras/channel_width/sql

</details>
<br>
<br>
__Riparian Classification Methodology Summary__


Layers were classified according to this FRPA [regulation guidelines](https://www.bclaws.gov.bc.ca/civix/document/id/complete/statreg/14_2004#division_d2e9829).

__Wetlands__
The FWA Wetland polygons served as the primary spatial layer for deriving area-based classifications. For the W2, W3, and W4 classifications, Biogeoclimatic Ecosystem Classification (BEC) attributes were required. To assign BEC zones and subzones to each wetland, a spatial intersection was performed between the BEC layer and the wetlands polygons. If a wetland intersected multiple BEC zones or subzones, the zone or subzone covering the largest portion of the wetland was selected.

__Lakes__
The FWA Lake polygons served as the primary spatial layer for deriving area-based classifications. For the L2, L3, and L4 classifications, Biogeoclimatic Ecosystem Classification (BEC) attributes were required. To assign BEC zones and subzones to each lake, a spatial intersection was performed between the BEC layer and the lake polygons. If a lake intersected multiple BEC zones or subzones, the zone or subzone covering the largest portion of the lake was selected.

__Streams__
The primary data sources used to derive stream classifications were the Fish Habitat Accessibility Model, FWA Rivers, Community Watersheds, the Mapped Floodplains in BC, and modeled channel width. The data format of the Fish Habitat Accessibility Model is a spatial linestring stream network for the province, identical to the FWA Stream Network but divided into smaller segments or reaches.

In order to assign stream riparian classes, the following pre-processing steps were performed:

* Each stream network is assigned a modeled channel width. See Data Sources for further description of the channel width model and its limitations. When channel width was unavailable, stream order was used as a proxy for channel width.
* Each stream network reach was assigned a value for community watershed presence: TRUE if the stream falls within a community watershed, and FALSE if it does not.
* Each stream network reach was assigned a value for active floodplain presence: TRUE if the stream falls within an active floodplain, and FALSE if it does not. All streams that fell within an active floodplain were manually inspected and assigned a value if the surrounding floodplain was >= 100m.
* Each stream is assigned a Natural Resource Area (ex. North, South, Coast)

All classified streams were assigned a stream classification using the above added attributes. Either the modeled channel width exists or the stream has a trans boundary upstream catchment basin (I.e., part of the catchment basin is outside BC). Unclassified streams were assigned classes based on stream order and natural resource area. 
<details>
  <summary> [Expand for further details of how unclassified streams were handled.]  </summary>
  <br>

Stream classification was divided by administrative areas, following advice from FAIB analyst, who noted significant differences between coastal and interior regions.

__North and South Admin Areas__



Table: Stream Classification Assignment within North and South Admin Area (when channel width model does not exist)

|Stream Classification Assigned |Within Community Watershed OR Fish_Passage |Stream Order |
|:------------------------------|:------------------------------------------|:------------|
|S1B (where not S1A)            |NA                                         |>=4          |
|S2                             |Yes                                        |3            |
|S3                             |Yes                                        |2            |
|S4                             |Yes                                        |1            |
|S5                             |No                                         |>1           |
|S6                             |No                                         |1            |



__Coast Admin Area__



Table: Stream Classification Assignment within Coastal Admin Area (when channel width model does not exist)

|Stream Classification Assigned |Within Community Watershed OR Fish_Passage |Stream Order |
|:------------------------------|:------------------------------------------|:------------|
|S1B                            |Yes                                        |>=5          |
|S2                             |Yes                                        |4            |
|S3                             |Yes                                        |(3,2)        |
|S4                             |Yes                                        |1            |
|S5                             |No                                         |>1           |
|S6                             |No                                         |1            |


</details>

<br>
__Rivers__
For a complete stream classification, the FWA Rivers polygon dataset is typically used in Timber Supply Analyses. It is important to include this dataset to ensure that river areas are accounted for in riparian zones. To classify each FWA River polygon, the most common stream classification (i.e., the mode) from the overlapping stream reaches was assigned to the polygon. As river polygons are known to be large rivers, it was assumed erroneous if any were classified as S6 (channel width <= 3m), S3 (channel width >= 1.5m and < 5m) or S4 (< 1.5m). Any FWA rivers classified as S6 were altered to S5 and any classified as S3 or S4 were changed to S2. 

__Buffers__

Buffers were determined using the Riparian management area guidebook found [here](https://www2.gov.bc.ca/gov/content/industry/forestry/managing-our-forest-resources/silviculture/silvicultural-systems/silviculture-guidebooks/riparian-management-area-guidebook). 

__Restrictions in a riparian management zones__

> _"Under the Forest practices within the RMA, fisheries-sensitive zones, and marine-sensitive zones section. The following table summarizes the maximum overall levels of retention within the riparian management zones for each riparian class of stream, wetland and lake that are anticipated to result from consistent implementation of the best management practices recommended in this guidebook. "_

The following tables were copied from Riparian Management area Guidebook. The last column (I.e. Applied Riparian Buffer width (metres)) has been derived and is the result of (reserve zone + (management zone (m) * Maximum Overall Retention in the Riparian Management Zone (%))) / 2.



Table: Stream Riparian Buffer Guidelines

|Riparian Class | Riparian Reserve Zone (metres)| Riparian Mgmt Zone (metres)| Riparian Mgmt Area (metres)|Maximum Overall Retention in the Riparian Mgmt Zone (%) | Applied Riparian Buffer width (metres)|
|:--------------|------------------------------:|---------------------------:|---------------------------:|:-------------------------------------------------------|--------------------------------------:|
|S1-A           |                              0|                         100|                         100|50                                                      |                                   50.0|
|S1-B           |                             50|                          20|                          70|50                                                      |                                   60.0|
|S2             |                             30|                          20|                          50|50                                                      |                                   40.0|
|S3             |                             20|                          20|                          40|50                                                      |                                   30.0|
|S4             |                              0|                          30|                          30|25                                                      |                                    7.5|
|S5             |                              0|                          30|                          30|25                                                      |                                    7.5|
|S6             |                              0|                          20|                          20|5                                                       |                                    1.0|



Table: Wetland Riparian Buffer Guidelines

|Riparian Class | Riparian Reserve Zone (metres)| Riparian Mgmt Zone (metres)| Riparian Mgmt Area (metres)|Maximum Overall Retention in the Riparian Mgmt Zone (%) | Applied Riparian Buffer width (metres)|
|:--------------|------------------------------:|---------------------------:|---------------------------:|:-------------------------------------------------------|--------------------------------------:|
|W1             |                             10|                          40|                          50|25                                                      |                                   20.0|
|W2             |                             10|                          20|                          30|25                                                      |                                   15.0|
|W3             |                              0|                          30|                          30|25                                                      |                                    7.5|
|W4             |                              0|                          30|                          30|25                                                      |                                    7.5|
|W5             |                             10|                          40|                          50|25                                                      |                                   20.0|



Table: Lake Riparian Riparian Buffer Guidelines

|Riparian Class | Riparian Reserve Zone (metres)| Riparian Mgmt Zone (metres)| Riparian Mgmt Area (metres)|Maximum Overall Retention in the Riparian Mgmt Zone (%) | Applied Riparian Buffer width (metres)|
|:--------------|------------------------------:|---------------------------:|---------------------------:|:-------------------------------------------------------|--------------------------------------:|
|L1-A           |                              0|                           0|                           0|25                                                      |                                    0.0|
|L1-B           |                             10|                           0|                          10|25                                                      |                                   10.0|
|L2             |                             10|                          20|                          30|25                                                      |                                   15.0|
|L3             |                              0|                          30|                          30|25                                                      |                                    7.5|
|L4             |                              0|                          30|                          30|25                                                      |                                    7.5|



This analysis applies a riparian buffer with 100% retention to the entire Applied Riparian Buffer width, rather than retaining 100% in the Riparian Reserve Zone and applying the maximum overall retention in the Riparian Management Zone.

For example, an S2 stream would receive a single 40m buffer with 100% retention, instead of a two-tiered approach: a 30m buffer with 100% retention immediately around the stream, followed by an additional 20m buffer with 50% retention extending outward from the first buffer.

The buffered areas were converted into a numeric raster, where each cell represents the proportion of the cell covered by the riparian buffer polygons.


__Usage Limitations__

__Stream__ - Riparian stream classification can only be assigned if the channels have been measured and sampled for fish presence or absence, which requires field work. As such, no provincial riparian classification database exists. This stream classification model is __not appropriate for operational use__. It is acceptable for generating broad landscape level summary stats for something like AAC Impacts and TSR.

__Analysis Methodology Further Details__

__Clarification of FWA River Polygons Riparian Classification__ - A review of several TSAs was conducted to understand how river polygons are classified. The guidelines specify that a stream is classified as S1A if it averages, over a one-kilometer length, either a stream width or an active floodplain width of 100 meters or more. A stream is classified as S1B if its width exceeds 20 meters but it does not meet the criteria for S1A. Since TSAs often lacked access to channel width data, they typically classified river polygons S1A or S1B by manually measuring features from the river polygon or satellite imagery. As this analysis has access to modelled channel width, that was leveraged to classify the river polygons.

The following approach was used:

1. Each stream reach (I.e. segment linestring) is classified individually.
2. The stream reaches within a river polygon are identified
3. The river polygon is assigned the classification of the most common riparian class (I.e., mode) of the stream reaches that are within.

As FWA Rivers are known to be large rivers, it was assumed erroneous if any were classified as S6 (channel width <= 3m), S3 (channel width >= 1.5m and < 5m) or S4 (< 1.5m). Any FWA rivers classified as S6 were altered to S5 and any classified as S3 or S4 were changed to S2. 

Many river polygons were not classified because they lack a stream reach within them. This commonly occurs in braided rivers, where a smaller river polygon is attached to a larger polygon but lacks any stream network linework. In these instances, the FWA polygon was assigned the lowest classification among all adjacent FWA polygons.

This approach is considered a limitation as it is new and differs from TSA analysis and has not been checked against field data.

__Clarification of FWA Wetland Polygons Riparian Classification__: When classifying W5 wetlands, the regulation states:

> _"(a) the area contains:  
  (i) two or more W1 wetlands located within 100 m of each other,  
  (ii) a W1 wetland and one or more non-W1 wetlands, all of which are within 80 m of each other, or  
  (iii) two or more non-W1 wetlands located within 60 m of each other, and  
(b) the combined size of the wetlands, excluding the upland areas, is 5 ha or larger."_


It was unclear whether "non-W1 wetlands" included non-classified wetlands and unclear whether bullet (i) should be read as having an "or" at the end of the line. Based upon clarification from a domain export, W5's were assigned using the following workflow:

* buffer's were created on polygons classified as W1 (50m), W2 (30m), W3 (30m) or W4 (30m)  
* all buffers that overlapped with one or more other buffers were identified and grouped together  
* the sum of the wetland area of all identified overlapping groups was calculated  
* if the area was >= 5 ha, W5 was assigned  

</details>

#### Riparian Retention Summary



``` r
lclass<-"Riparian_Buffers"
n_step<-"p09_riparian"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-p09_riparian)
  )

netdown<-get_netdown(netdown_summary,lclass)
running_total<-get_running_total(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,444 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,520 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
</tbody>
</table>



### n10_arch

A cultural heritage resource is defined in the Forest Act as, “an object, site, or location of a traditional societal practice that is of historical, cultural or archaeological significance to the province, a community, or an aboriginal people”. Cultural heritage resources include archaeological sites structural features, heritage landscape features, and traditional use sites.

The Heritage Conservation Act provides for the protection of British Columbia’s archaeological sites predating 1846. In accordance with the Act (Section 13(2)), archaeological sites may not be damaged, excavated or altered without a permit issued by the Minister or designate.The BC Provincial Heritage Register database is the basis for records on archaeological sites and provides a polygon layer. For this timber supply review, all identified buffered archaeological sites within the provincial application Remote Access to Archaeological Data (RAAD) are excluded from the proxy timber harvesting land base.

**Data source:** BCGW file (restricted) WHSE_ARCHAEOLOGY.RAAD_TFM_SITES_SVW
Access date: Jan 7, 2025

__R Scripts__

No pre-processing was performed for this netdown factor. The layer was imported using the dadmtools:

```
src\analysis\0.setup-and-import-data-sources.R
```


``` r
lclass<-"Non-Cultural_Heritage_Features"
n_step<-"n10_arch"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
</tbody>
</table>




### n11_harvest_restrictions
The Generalized Forest Harvesting Restrictions dataset provides a spatial representation of various land designations that impose varying levels of restrictions on forest harvesting. These designations include parks, ecological reserves, conservancies, ungulate winter ranges, wildlife management areas, old growth management areas, and visual quality objective areas.

The dataset assigns a ranking to forest harvesting restrictions, which determines the priority of spatial layers and attributes when overlaps occur. Each ranked dataset is classified into one of five harvest restriction categories; Protected, Prohibited, High Restricted, Moderate Restricted, and Low Restricted.

For this analysis, areas classified as **Protected or Prohibited** are excluded from the Proxy Timber Harvesting Land Base (pTHLB).


**Data source:** BC Data Catalogue layer: https://catalogue.data.gov.bc.ca/dataset/generalized-forest-harvesting-restrictions

__R Scripts__

No pre-processing was performed for this netdown factor. The layer was imported using the dadmtools:

```
src\analysis\0.setup-and-import-data-sources.R
```


``` r
lclass<-"Harvest_Restrictions"
n_step<-"n11_harvest_restrictions"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 28,925,703 </td>
   <td style="text-align:right;"> 30.5154094 </td>
   <td style="text-align:right;"> 4,859,273.11 </td>
   <td style="text-align:right;"> 61,467,234 </td>
   <td style="text-align:right;"> 33,323,246 </td>
  </tr>
</tbody>
</table>



### p12_phys_inop
Physically inoperable areas were identified based on an assessment of elevation, slope, and terrain stability mapping, with reference to harvesting practices observed over the past decade (2014–2024). This 10-year period was selected to reflect recent operational behavior.

__Methodology__

For each Timber Supply Area (TSA) and Tree Farm Licence (TFL):

 - Binary rasters with a 25-meter resolution were created to identify areas meeting the following criteria:
   - Slopes exceeding the 99th percentile within harvested openings (2014–2024).
   - Elevations exceeding the 99th percentile within harvested openings (2014–2024).
   - Areas classified as unstable or potentially unstable terrain based on terrain stability mapping.
 - These rasters were combined into a single “physically inoperable” layer.
 - The combined data was then aggregated to a 1-hectare resolution, resulting in a proportional inoperable variable representing the fraction of each hectare classified as physically inoperable.

__Minimum Sample Requirement__

 - A minimum of 30 harvested openings per TSA or TFL was required to establish the 99th percentile thresholds for slope and elevation.
 - If a unit had fewer than 30 harvested openings, the thresholds from the neighboring TSA with the greatest geographic overlap were applied.
   - Example: TFL 43 had fewer than 30 harvested openings; therefore, thresholds from the Sunshine Coast TSA were used.

Note:

A table containing the calculated 99th percentile elevation and slope values, along with the number of harvested openings per TSA and TFL, is provided below.

<details>
  <summary> [Expand to view the table of percentile thresholds and sample sizes used in the analysis.] </summary>
  <br>


``` r
query <- "WITH a AS (
SELECT 
	inop_cc.mgmt_unit,
	 CASE 
	 	WHEN inop_cc.mgmt_unit = 'TFL 43' THEN '39 - Sunshine Coast TSA'
	 	ELSE 'Same'
	 END AS mgmt_unit_threshold_used,
	 inop_cc.number_of_cutblocks,
	round(elev_threshold.elev_99th::numeric, 1) as elev_threshold,
	round(slope_threshold.slope_99th::numeric, 1) as slope_threshold
	
FROM 
whse.inoperable_cutblock_summary inop_cc
JOIN
	(
		SELECT 
			DISTINCT ON (cutblock_percentile_99, split_part(inop.man_unit, '-sub-', 1))			 
			cutblock_percentile_99 as elev_99th,
			split_part(inop.man_unit, '-sub-', 1) as man_unit
		FROM 
			whse.inoperable_thresholds inop
		WHERE grid = 'elevation'
		ORDER BY
			cutblock_percentile_99,
			split_part(inop.man_unit, '-sub-', 1)
	) elev_threshold
ON split_part(inop_cc.mgmt_unit, '-sub-', 1) = elev_threshold.man_unit
JOIN
	(
		SELECT 
			DISTINCT ON (cutblock_percentile_99, split_part(inop.man_unit, '-sub-', 1))			 
			cutblock_percentile_99 as slope_99th,
			split_part(inop.man_unit, '-sub-', 1) as man_unit
		FROM 
		whse.inoperable_thresholds inop
		WHERE grid = 'slope'
		ORDER BY
			cutblock_percentile_99,
			split_part(inop.man_unit, '-sub-', 1)
	) slope_threshold
ON split_part(inop_cc.mgmt_unit, '-sub-', 1) = slope_threshold.man_unit
WHERE 
-- 	inop_cc.number_of_cutblocks >= 30
-- AND
	inop_cc.mgmt_unit ilike 'TFL%'
ORDER BY split_part(mgmt_unit, ' ', 2)::int
)
SELECT * FROM a
UNION ALL
(SELECT 
	inop_cc.mgmt_unit,
	 CASE 
	 	WHEN inop_cc.mgmt_unit = 'TFL 43' THEN '39 - Sunshine Coast TSA'
	 	ELSE 'Same'
	 END AS mgmt_unit_threshold_used,
	 inop_cc.number_of_cutblocks,
	round(elev_threshold.elev_99th::numeric, 1) as elev_threshold,
	round(slope_threshold.slope_99th::numeric, 1) as slope_threshold
	
FROM 
whse.inoperable_cutblock_summary inop_cc
JOIN
	(
		SELECT 
			DISTINCT ON (cutblock_percentile_99, split_part(inop.man_unit, '-sub-', 1))			 
			cutblock_percentile_99 as elev_99th,
			split_part(inop.man_unit, '-sub-', 1) as man_unit
		FROM 
			whse.inoperable_thresholds inop
		WHERE grid = 'elevation'
		ORDER BY
			cutblock_percentile_99,
			split_part(inop.man_unit, '-sub-', 1)
	) elev_threshold
ON split_part(inop_cc.mgmt_unit, '-sub-', 1) = elev_threshold.man_unit
JOIN
	(
		SELECT 
			DISTINCT ON (cutblock_percentile_99, split_part(inop.man_unit, '-sub-', 1))			 
			cutblock_percentile_99 as slope_99th,
			split_part(inop.man_unit, '-sub-', 1) as man_unit
		FROM 
		whse.inoperable_thresholds inop
		WHERE grid = 'slope'
		ORDER BY
			cutblock_percentile_99,
			split_part(inop.man_unit, '-sub-', 1)
	) slope_threshold
ON split_part(inop_cc.mgmt_unit, '-sub-', 1) = slope_threshold.man_unit
WHERE 
	inop_cc.mgmt_unit ilike '%TSA'
ORDER BY split_part(mgmt_unit, ' - ', 1)::int
)

-- WITH tfl AS (
-- 	-- join inoperable table with man unit table to determine where a TFL exists but uses a different management unit threshold
-- 	select
-- 		mu.tfl_rank1,
-- 		inop.man_unit
-- 	from
-- 	thlb_proxy.bc_inoperable_gr_skey inop
-- 	join
-- 	whse.man_unit_gr_skey mu USING (gr_skey)
-- 	WHERE tfl_rank1 IS NOT NULL
-- 	GROUP BY 
-- 		inop.man_unit,
-- 		mu.tfl_rank1
-- 	HAVING count(*) > 500
-- ), TSA AS (
-- 	-- join inoperable table with man unit table to determine where a TSA exists but uses a different management unit threshold
-- 	select
-- 		mu.tsa_rank1,
-- 		inop.man_unit,
-- 		count(*)
-- 	from
-- 	thlb_proxy.bc_inoperable_gr_skey inop
-- 	join
-- 	whse.man_unit_gr_skey mu USING (gr_skey)
-- 	WHERE tsa_rank1 IS NOT NULL
-- 	GROUP BY 
-- 		inop.man_unit,
-- 		mu.tsa_rank1
-- 	HAVING count(*) > 5000
-- )"

phys_inop_thresholds_df <- sql_to_df(query, conn_list)

phys_inop_thresholds_df <- phys_inop_thresholds_df %>%
  rename(
    `Mgmt Unit` = `mgmt_unit`,
    `Mgmt Unit Threshold Used` = `mgmt_unit_threshold_used`,
    `No. Harvested Openings since 2014` = `number_of_cutblocks`,
    `Elev 99th Percentile (m)` = `elev_threshold`,
    `Slope 99th Percentile (%)` = `slope_threshold`
  )

kable(phys_inop_thresholds_df,
      booktabs = T,
      format.args = list(big.mark = ","),
      caption =  "Physically Inoperable Thresholds Used" ) %>% 
  kable_styling(bootstrap_options = "striped",
                font_size = 10)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Physically Inoperable Thresholds Used</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Mgmt Unit </th>
   <th style="text-align:left;"> Mgmt Unit Threshold Used </th>
   <th style="text-align:right;"> No. Harvested Openings since 2014 </th>
   <th style="text-align:right;"> Elev 99th Percentile (m) </th>
   <th style="text-align:right;"> Slope 99th Percentile (%) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> TFL 1 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 637 </td>
   <td style="text-align:right;"> 1,031.0 </td>
   <td style="text-align:right;"> 76.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 3 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 155 </td>
   <td style="text-align:right;"> 1,974.0 </td>
   <td style="text-align:right;"> 79.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 6 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,402 </td>
   <td style="text-align:right;"> 1,011.0 </td>
   <td style="text-align:right;"> 83.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 8 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 493 </td>
   <td style="text-align:right;"> 1,763.0 </td>
   <td style="text-align:right;"> 53.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 14 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 434 </td>
   <td style="text-align:right;"> 1,926.0 </td>
   <td style="text-align:right;"> 64.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 18 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 329 </td>
   <td style="text-align:right;"> 1,713.0 </td>
   <td style="text-align:right;"> 54.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 19 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,416 </td>
   <td style="text-align:right;"> 991.0 </td>
   <td style="text-align:right;"> 108.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 23 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 931 </td>
   <td style="text-align:right;"> 1,832.0 </td>
   <td style="text-align:right;"> 76.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 25 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 571 </td>
   <td style="text-align:right;"> 834.0 </td>
   <td style="text-align:right;"> 91.2 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 26 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 171 </td>
   <td style="text-align:right;"> 619.0 </td>
   <td style="text-align:right;"> 75.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 30 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 822 </td>
   <td style="text-align:right;"> 1,168.0 </td>
   <td style="text-align:right;"> 39.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 33 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 110 </td>
   <td style="text-align:right;"> 1,756.0 </td>
   <td style="text-align:right;"> 61.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 35 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 134 </td>
   <td style="text-align:right;"> 1,770.0 </td>
   <td style="text-align:right;"> 37.2 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 37 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 712 </td>
   <td style="text-align:right;"> 1,139.0 </td>
   <td style="text-align:right;"> 95.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 38 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 155 </td>
   <td style="text-align:right;"> 1,325.0 </td>
   <td style="text-align:right;"> 82.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 39 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 633 </td>
   <td style="text-align:right;"> 1,044.0 </td>
   <td style="text-align:right;"> 87.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 41 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 171 </td>
   <td style="text-align:right;"> 952.0 </td>
   <td style="text-align:right;"> 76.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 43 </td>
   <td style="text-align:left;"> 39 - Sunshine Coast TSA </td>
   <td style="text-align:right;"> 23 </td>
   <td style="text-align:right;"> 39.0 </td>
   <td style="text-align:right;"> 14.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 44 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,303 </td>
   <td style="text-align:right;"> 900.0 </td>
   <td style="text-align:right;"> 94.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 45 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 71 </td>
   <td style="text-align:right;"> 672.1 </td>
   <td style="text-align:right;"> 94.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 46 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 351 </td>
   <td style="text-align:right;"> 948.0 </td>
   <td style="text-align:right;"> 89.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 47 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 845 </td>
   <td style="text-align:right;"> 1,200.6 </td>
   <td style="text-align:right;"> 75.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 48 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,096 </td>
   <td style="text-align:right;"> 1,393.0 </td>
   <td style="text-align:right;"> 47.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 49 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 735 </td>
   <td style="text-align:right;"> 1,705.0 </td>
   <td style="text-align:right;"> 53.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 52 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,619 </td>
   <td style="text-align:right;"> 1,637.0 </td>
   <td style="text-align:right;"> 51.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 53 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 343 </td>
   <td style="text-align:right;"> 1,430.0 </td>
   <td style="text-align:right;"> 35.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 54 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 51 </td>
   <td style="text-align:right;"> 648.0 </td>
   <td style="text-align:right;"> 92.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 55 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 108 </td>
   <td style="text-align:right;"> 1,779.0 </td>
   <td style="text-align:right;"> 89.2 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 56 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 122 </td>
   <td style="text-align:right;"> 1,695.0 </td>
   <td style="text-align:right;"> 84.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 58 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 57 </td>
   <td style="text-align:right;"> 366.0 </td>
   <td style="text-align:right;"> 46.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 59 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 294 </td>
   <td style="text-align:right;"> 1,972.0 </td>
   <td style="text-align:right;"> 37.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 60 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 198 </td>
   <td style="text-align:right;"> 587.0 </td>
   <td style="text-align:right;"> 60.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 61 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 163 </td>
   <td style="text-align:right;"> 893.0 </td>
   <td style="text-align:right;"> 94.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 64 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,042 </td>
   <td style="text-align:right;"> 1,211.0 </td>
   <td style="text-align:right;"> 84.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 - Arrow TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,045 </td>
   <td style="text-align:right;"> 1,864.0 </td>
   <td style="text-align:right;"> 72.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 2 - Boundary TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 2,874 </td>
   <td style="text-align:right;"> 1,912.0 </td>
   <td style="text-align:right;"> 55.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 3 - Bulkley TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,884 </td>
   <td style="text-align:right;"> 1,318.0 </td>
   <td style="text-align:right;"> 34.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 4 - Cassiar TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 215 </td>
   <td style="text-align:right;"> 1,278.0 </td>
   <td style="text-align:right;"> 52.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 5 - Cranbrook TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,066 </td>
   <td style="text-align:right;"> 1,985.0 </td>
   <td style="text-align:right;"> 62.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 7 - Golden TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,069 </td>
   <td style="text-align:right;"> 1,833.0 </td>
   <td style="text-align:right;"> 75.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 8 - Fort Nelson TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 88 </td>
   <td style="text-align:right;"> 771.6 </td>
   <td style="text-align:right;"> 38.2 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 9 - Invermere TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 2,229 </td>
   <td style="text-align:right;"> 1,997.0 </td>
   <td style="text-align:right;"> 71.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 10 - Kalum TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,393 </td>
   <td style="text-align:right;"> 1,026.0 </td>
   <td style="text-align:right;"> 74.2 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 11 - Kamloops TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8,089 </td>
   <td style="text-align:right;"> 1,817.0 </td>
   <td style="text-align:right;"> 59.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 12 - Kispiox TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 749 </td>
   <td style="text-align:right;"> 1,165.0 </td>
   <td style="text-align:right;"> 69.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 13 - Kootenay Lake TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,895 </td>
   <td style="text-align:right;"> 1,815.0 </td>
   <td style="text-align:right;"> 73.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 14 - Lakes TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,320 </td>
   <td style="text-align:right;"> 1,310.0 </td>
   <td style="text-align:right;"> 33.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 15 - Lillooet TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 709 </td>
   <td style="text-align:right;"> 1,836.0 </td>
   <td style="text-align:right;"> 74.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 16 - MacKenzie TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 5,011 </td>
   <td style="text-align:right;"> 1,346.0 </td>
   <td style="text-align:right;"> 41.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 17 - Robson Valley TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 867 </td>
   <td style="text-align:right;"> 1,693.0 </td>
   <td style="text-align:right;"> 66.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 18 - Merritt TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,394 </td>
   <td style="text-align:right;"> 1,922.0 </td>
   <td style="text-align:right;"> 44.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 20 - Morice TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,067 </td>
   <td style="text-align:right;"> 1,339.0 </td>
   <td style="text-align:right;"> 32.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 22 - Okanagan TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9,613 </td>
   <td style="text-align:right;"> 1,899.0 </td>
   <td style="text-align:right;"> 64.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 23 - 100 Mile House TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 5,600 </td>
   <td style="text-align:right;"> 1,587.0 </td>
   <td style="text-align:right;"> 37.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 24 - Prince George TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 15,005 </td>
   <td style="text-align:right;"> 1,414.0 </td>
   <td style="text-align:right;"> 40.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 25 - Haida Gwaii TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 954 </td>
   <td style="text-align:right;"> 467.0 </td>
   <td style="text-align:right;"> 53.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 26 - Quesnel TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 20,781 </td>
   <td style="text-align:right;"> 1,561.0 </td>
   <td style="text-align:right;"> 43.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 27 - Revelstoke TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 620 </td>
   <td style="text-align:right;"> 1,762.3 </td>
   <td style="text-align:right;"> 86.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 29 - Williams Lake TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8,981 </td>
   <td style="text-align:right;"> 1,853.0 </td>
   <td style="text-align:right;"> 38.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 30 - Fraser TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,006 </td>
   <td style="text-align:right;"> 1,565.0 </td>
   <td style="text-align:right;"> 87.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 31 - Soo TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,498 </td>
   <td style="text-align:right;"> 1,423.0 </td>
   <td style="text-align:right;"> 88.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 38 - Arrowsmith TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7,437 </td>
   <td style="text-align:right;"> 1,068.0 </td>
   <td style="text-align:right;"> 81.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 39 - Sunshine Coast TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 2,689 </td>
   <td style="text-align:right;"> 1,066.0 </td>
   <td style="text-align:right;"> 98.6 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 40 - Fort St. John TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,102 </td>
   <td style="text-align:right;"> 1,135.0 </td>
   <td style="text-align:right;"> 30.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 41 - Dawson Creek TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 3,987 </td>
   <td style="text-align:right;"> 1,354.0 </td>
   <td style="text-align:right;"> 43.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 43 - Nass TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 721 </td>
   <td style="text-align:right;"> 974.7 </td>
   <td style="text-align:right;"> 55.3 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 44 - Pacific TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 1,056 </td>
   <td style="text-align:right;"> 1,173.0 </td>
   <td style="text-align:right;"> 90.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 45 - Cascadia TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 718 </td>
   <td style="text-align:right;"> 1,776.0 </td>
   <td style="text-align:right;"> 71.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 46 - GBR North TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 2,416 </td>
   <td style="text-align:right;"> 590.0 </td>
   <td style="text-align:right;"> 91.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 47 - GBR South TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 2,113 </td>
   <td style="text-align:right;"> 729.4 </td>
   <td style="text-align:right;"> 90.2 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 48 - North Island TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8,219 </td>
   <td style="text-align:right;"> 1,147.0 </td>
   <td style="text-align:right;"> 90.2 </td>
  </tr>
</tbody>
</table>


</details>

**Data sources:** BCGW layer: WHSE_TERRESTRIAL_ECOLOGY.STE_TER_ATTRIBUTE_POLYS_SVW, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP

Shared drive layer: 

+ R:\\dem\\elevation\\trim_25m\\bcalbers\\tif\\bc_elevation_25m_bcalb.tif

__R Scripts__

The following scripts were used to perform pre-processing:

```
src\analysis\1.physical-inoperability-import-layers.R
src\analysis\2.physical-inoperability-processing.R
src\analysis\3.physical-inoperability-classification.R
```

__Application in Land Base Classification:__

**Note:** All harvested openings were excluded from this netdown step. In other words, if the area was ever harvested, it was not excluded out of the pTHLB due to being physically inoperable.

Similar to other proportion netdown factors, the THLB is multiplied by one minus the physically inoperable proportion:

 - pthlb_net = pthlb_net * (1- p12_phys_inop)
 
In the netdown table, each record is assigned the proportion of the cell considered physically inoperable, represented by the variable p12_phys_inop.

#### Physically Inoperable Areas Summary


``` r
lclass<-"Physical_Inoperable"
n_step<-"p12_phys_inop"

## adjust  physical inoperable variable prior to running summary statistics on it
netdown_tab <- netdown_tab %>%
  mutate(p12_phys_inop = case_when(
    (!is.na(cc_year)) ~ 0, ## change to 0 which will be altered to 1 in later step
    is.na(cc_year) ~ p12_phys_inop
    )
  )

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-p12_phys_inop)
  )

running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 28,925,703 </td>
   <td style="text-align:right;"> 30.5154094 </td>
   <td style="text-align:right;"> 4,859,273.11 </td>
   <td style="text-align:right;"> 61,467,234 </td>
   <td style="text-align:right;"> 33,323,246 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 29,031,855 </td>
   <td style="text-align:right;"> 30.6273948 </td>
   <td style="text-align:right;"> 5,383,399.29 </td>
   <td style="text-align:right;"> 66,850,633 </td>
   <td style="text-align:right;"> 27,939,847 </td>
  </tr>
</tbody>
</table>



### n13_non_merchantable
Stands are considered not merchantable if their characteristics (e.g., low volumes, low value or high cost of harvest, primarily excessive haul distance) deviate significantly from the attributes that have historically defined preferred harvest practices.

Based on expert guidance, the determination of non-merchantable stands for the provincial proxy THLB involved summarizing the site index from the 2016 Vegetation Resource Inventory (VRI) within all harvested openings from 2017 onward, across each TSA and TFL. Selecting the site index from the year preceding the harvest activity (e.g., 2016 for openings harvested in 2017 or later) was intended to reflect site productivity before recent harvesting, providing a more accurate representation of stand potential.

The 2016 VRI dataset was selected as it is the earliest available year with TFL site index data, ensuring the largest possible sample size of harvested openings and TFL site index data. A key objective of the proxy THLB approach is to model THLB within TFLs and other area-based tenures (e.g., community forests, woodlots). Therefore, ensuring the inclusion of TFL site index data was a priority. 

Following expert advice, the 5th percentile of the site index distribution was chosen as the threshold for non-merchantability. VRI stands from the 2023 dataset falling below this threshold were classified as 'non-merchantable.' To recap, the following steps were performed for each TSA and TFL:

1. Identify all openings where harvest year ≥ 2017.
  - Exclude openings with incomplete data (i.e., < 75% of site index values are NOT NULL).
  - Exclude TSAs/TFLs with fewer than 30 openings.

2. Calculate the site index threshold (5th percentile) for the remaining openings.
3. Exclude stands from the pTHLB if the 2023 VRI site index is below site index threshold (i.e. 5th percentile) calculated for that TSA/TFL.

As mentioned above, a threshold for a TSA or TFL was not calculated if there were less than 30 openings. The complete list of TSAs and TFLs were this occurred and the substitute region's threshold that was used, is provided below:

+ Fort Nelson TSA used the threshold from the adjacent Fort St. John TSA.
+ Cassiar TSA used the threshold from the adjacent Nass TSA.
+ TFL 41 used the threshold from the overlapping Kalum TSA.
+ TFL 43 used the threshold from the overlapping Sunshine Coast TSA.
+ TFL 58 used the threshold from the overlapping Haida Gwaii TSA.
+ TFL 54 used the threshold from the overlapping Arrowsmith TSA.
+ TFL 8 used the threshold from the overlapping Boundary TSA.


**Note:** All harvested openings were excluded from this netdown step. In other words, if the area was ever harvested, it was not excluded out of the pTHLB due to being non-merchantable.


Note:

A table containing the calculated 5th percentile site index is provided below.

<details>
  <summary> [Expand to view the table of 5th percentile thresholds used in the analysis.] </summary>
  <br>


``` r
query <- "	WITH a AS (
	SELECT
		CASE 
			WHEN si_manlic.man_unit IS NOT null THEN si_manlic.man_unit
			WHEN si_tfl.man_unit IS NOT NULL THEN si_tfl.man_unit
			WHEN si_tsa.man_unit IS NOT NULL THEN si_tsa.man_unit
		END AS man_unit
		, CASE 
			WHEN si_manlic.man_unit IS NOT null THEN si_manlic.tfl_integrated_p5
			WHEN si_tfl.man_unit IS NOT NULL THEN si_tfl.tfl_integrated_p5
			WHEN si_tsa.man_unit IS NOT NULL THEN si_tsa.tfl_integrated_p5
		END AS p5
	FROM
	whse.veg_comp_lyr_r1_poly_internal_gr_skey vri_key
	LEFT JOIN (SELECT pgid, CASE WHEN site_index = 0 THEN NULL ELSE site_index END AS site_index FROM whse.veg_comp_lyr_r1_poly_internal) vri USING (pgid)
	LEFT JOIN whse.tsa_boundaries_gr_skey tsa_key on tsa_key.gr_skey = vri_key.gr_skey
	LEFT JOIN whse.tsa_boundaries tsa on tsa.pgid = tsa_key.pgid 
	LEFT JOIN whse.tsa_tfl_abt_5p_site_index_cc si_tsa ON si_tsa.forest_file_id = tsa.tsa_number
	LEFT JOIN whse.fadm_tfl_all_sp_gr_skey tfl_key ON tfl_key.gr_skey = vri_key.gr_skey
	LEFT JOIN whse.fadm_tfl_all_sp tfl ON tfl.pgid = tfl_key.pgid 
	LEFT JOIN whse.tsa_tfl_abt_5p_site_index_cc si_tfl ON tfl.forest_file_id = si_tfl.forest_file_id
	LEFT JOIN whse.ften_managed_licence_poly_svw_gr_skey manlic_key ON manlic_key.gr_skey = vri_key.gr_skey
	LEFT JOIN whse.ften_managed_licence_poly_svw manlic ON manlic.pgid = manlic_key.pgid 
	LEFT JOIN whse.tsa_tfl_abt_5p_site_index_cc si_manlic ON manlic.forest_file_id = si_manlic.forest_file_id
	GROUP BY 
	CASE 
		WHEN si_manlic.man_unit IS NOT null THEN si_manlic.man_unit
		WHEN si_tfl.man_unit IS NOT NULL THEN si_tfl.man_unit
		WHEN si_tsa.man_unit IS NOT NULL THEN si_tsa.man_unit
	END, 
	CASE 
		WHEN si_manlic.man_unit IS NOT null THEN si_manlic.tfl_integrated_p5
		WHEN si_tfl.man_unit IS NOT NULL THEN si_tfl.tfl_integrated_p5
		WHEN si_tsa.man_unit IS NOT NULL THEN si_tsa.tfl_integrated_p5
	END
)
(
		SELECT man_unit, 
		case 
			when man_unit = '8 - Fort Nelson TSA' THEN '40 - Fort St. John TSA Used'
			when man_unit = '4 - Cassiar TSA' THEN '43 - Nass TSA Used'
			when man_unit = 'TFL 41' THEN '10 - Kalum TSA Used'
			when man_unit = 'TFL 43' THEN '39 - Sunshine Coast TSA Used'
			when man_unit = 'TFL 58' THEN '25 - Haida Gwaii TSA Used'
			when man_unit = 'TFL 54' THEN '38 - Arrowsmith TSA Used'
			when man_unit = 'TFL 8' THEN '2 - Boundary TSA Used'
			ELSE 'Same'
		end as man_unit_threshold_used,
		p5
		FROM a WHERE man_unit IS NOT NULL AND man_unit ilike 'tfl%' ORDER BY split_part(man_unit, ' ', 2)::int)
UNION ALL
(
		SELECT man_unit, 
		case 
			when man_unit = '8 - Fort Nelson TSA' THEN '40 - Fort St. John TSA Used'
			when man_unit = '4 - Cassiar TSA' THEN '43 - Nass TSA Used'
			when man_unit = 'TFL 41' THEN '10 - Kalum TSA Used'
			when man_unit = 'TFL 43' THEN '39 - Sunshine Coast TSA Used'
			when man_unit = 'TFL 58' THEN '25 - Haida Gwaii TSA Used'
			when man_unit = 'TFL 54' THEN '38 - Arrowsmith TSA Used'
			when man_unit = 'TFL 8' THEN '2 - Boundary TSA Used'
			ELSE 'Same'
		end as man_unit_threshold_used,
		p5
		FROM a WHERE man_unit IS NOT NULL AND man_unit ilike  '%tsa' ORDER BY split_part(man_unit, ' ', 1)::int)
"

mer_thresholds_df <- sql_to_df(query, conn_list)

mer_thresholds_df <- mer_thresholds_df %>%
  rename(
    `Mgmt Unit` = `man_unit`,
    `Mgmt Unit Threshold Used` = `man_unit_threshold_used`,
    `Site Index 5th Percentile` = `p5`
  )

kable(mer_thresholds_df,
      booktabs = T,
      format.args = list(big.mark = ","),
      caption =  "Non-Merchantable Site Index Thresholds Used" ) %>% 
  kable_styling(bootstrap_options = "striped",
                font_size = 10)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Non-Merchantable Site Index Thresholds Used</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Mgmt Unit </th>
   <th style="text-align:left;"> Mgmt Unit Threshold Used </th>
   <th style="text-align:right;"> Site Index 5th Percentile </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> TFL 1 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 3 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 6 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 8 </td>
   <td style="text-align:left;"> 2 - Boundary TSA Used </td>
   <td style="text-align:right;"> 11.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 14 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.70 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 18 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 19 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 10.40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 23 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 12.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 25 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7.90 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 26 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 17.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 30 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 10.91 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 33 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.73 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 35 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 37 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 2.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 38 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 5.84 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 39 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 16.97 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 41 </td>
   <td style="text-align:left;"> 10 - Kalum TSA Used </td>
   <td style="text-align:right;"> 8.19 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 43 </td>
   <td style="text-align:left;"> 39 - Sunshine Coast TSA Used </td>
   <td style="text-align:right;"> 16.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 44 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 15.08 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 45 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 12.47 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 46 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 16.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 47 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 48 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.16 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 49 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 10.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 52 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 53 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 54 </td>
   <td style="text-align:left;"> 38 - Arrowsmith TSA Used </td>
   <td style="text-align:right;"> 13.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 55 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 56 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 58 </td>
   <td style="text-align:left;"> 25 - Haida Gwaii TSA Used </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 59 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 60 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 61 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 14.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> TFL 64 </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 13.08 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 1 - Arrow TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 12.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 2 - Boundary TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 3 - Bulkley TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 4 - Cassiar TSA </td>
   <td style="text-align:left;"> 43 - Nass TSA Used </td>
   <td style="text-align:right;"> 8.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 5 - Cranbrook TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 7 - Golden TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 10.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 8 - Fort Nelson TSA </td>
   <td style="text-align:left;"> 40 - Fort St. John TSA Used </td>
   <td style="text-align:right;"> 9.70 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 9 - Invermere TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 10.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 10 - Kalum TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.19 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 11 - Kamloops TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 12 - Kispiox TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 13 - Kootenay Lake TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 13.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 14 - Lakes TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 15 - Lillooet TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 16 - MacKenzie TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 17 - Robson Valley TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 5.90 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 18 - Merritt TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 20 - Morice TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 7.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 22 - Okanagan TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 23 - 100 Mile House TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 24 - Prince George TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 25 - Haida Gwaii TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 26 - Quesnel TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 27 - Revelstoke TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 29 - Williams Lake TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 6.90 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 30 - Fraser TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 12.40 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 31 - Soo TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.80 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 38 - Arrowsmith TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 13.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 39 - Sunshine Coast TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 16.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 40 - Fort St. John TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.70 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 41 - Dawson Creek TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 9.61 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 43 - Nass TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.50 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 44 - Pacific TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 45 - Cascadia TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.06 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 46 - GBR North TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 8.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 47 - GBR South TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 11.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 48 - North Island TSA </td>
   <td style="text-align:left;"> Same </td>
   <td style="text-align:right;"> 5.86 </td>
  </tr>
</tbody>
</table>


</details>
<br>
**Data sources:** BCGW layer: WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY

BC Data Catalogue layer: 

+ [2016 VRI](https://catalogue.data.gov.bc.ca/dataset/vri-historical-vegetation-resource-inventory-2002-2022-])

Shared drive layers: 

+ 2016 VRI with TFL Integrated

  + `\\spatialfiles2.bcgov\work\FOR\VIC\HTS\DAM\Data\VRI\TFL_Integrated\TFL_integrated_2016_delivery_final.gdb`
  

__R Scripts__

The following scripts were used to perform pre-processing:

```
src\analysis\1.merchantability-import-layers.R
src\analysis\2.merchantability-processing.R
src\analysis\3.merchantability-classification.R
```

#### Non-Merchantable Areas Summary



``` r
lclass<-"Non-Merchantable"
n_step<-"n13_non_merchantable"

netdown_tab <- netdown_tab %>%
  mutate(n13_non_merchantable = case_when(
    (!is.na(cc_year)) ~ NA, ##adjust non-merchantable value to NA if cell was ever previously a cutblock (I.e., consolidated cutblock year exists)
    is.na(cc_year) ~ n13_non_merchantable
    )
  )
netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 28,925,703 </td>
   <td style="text-align:right;"> 30.5154094 </td>
   <td style="text-align:right;"> 4,859,273.11 </td>
   <td style="text-align:right;"> 61,467,234 </td>
   <td style="text-align:right;"> 33,323,246 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 29,031,855 </td>
   <td style="text-align:right;"> 30.6273948 </td>
   <td style="text-align:right;"> 5,383,399.29 </td>
   <td style="text-align:right;"> 66,850,633 </td>
   <td style="text-align:right;"> 27,939,847 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Merchantable </td>
   <td style="text-align:right;"> 22,861,751 </td>
   <td style="text-align:right;"> 24.1181931 </td>
   <td style="text-align:right;"> 3,745,595.83 </td>
   <td style="text-align:right;"> 70,596,229 </td>
   <td style="text-align:right;"> 24,194,251 </td>
  </tr>
</tbody>
</table>



### n14_non_commercial

Stand types dominated (leading) by species with no or little harvest history are considered non-commercial and are excluded from the pTHLB during the netdown process. 
Based on expert guidance, an analysis was performed summarizing the dominant species type from the 2016 Vegetation Resource Inventory (VRI) within all harvested openings from 2017 onward, across each TSA. Selecting the species from the year preceding the harvest activity (e.g., 2016 for openings harvested in 2017 or later) was intended to reflect species before recent harvesting, providing a more accurate representation of species harvested.

The 2016 VRI dataset was selected as it is the earliest available year with TFL species data, ensuring the largest possible sample size of harvested openings. A key objective of the Provincial Proxy THLB approach is to model THLB within TFLs and other area-based tenures (e.g., community forests, woodlots). Therefore, ensuring the inclusion of TFL species data was a priority. 

The analysis examined, for each TSA, the proportion of each species harvested since 2017, relative to the total area harvested since 2017, compared to the proportion of that species' occurrence across the total TSA forested land base during the same time period. A bar chart illustrating this breakdown is available in the GitHub repository at the following location:
```
data\analysis\non_commercial_species_TSA_bar_graphs_percent_occurrence_2024_12_12.pdf
```

The bar charts were reviewed and combined with expert advice from FAIB staff, two rules were developed to classify non-merchantable stands. The rules are listed below. Though the thresholds were developed using VRI 2016 data, they were applied to the most recent VRI dataset available, which, at the time of analysis was the 2023 VRI dataset.

1. Stands with the following dominant species were classified as non-commercial:
  - Black Spruce
    - Species code: SB
  - Whitebark Pine
    - Species code: PA
  - Other Species
    - Species codes: PICEABI, Z, PR, JR, PINUSYL, X, XC, T
  
2. Stands with identified dominant species were classified as non-commercial if one of the following conditions was met:
 + No harvested hectares were recorded since 2017; or
 + The proportion of the species harvested since 2017, relative to the total harvested area since 2017, was less than 50% of the proportion of that species' occurrence across the total TSA land base during the same period.

Example: If trembling aspen accounted for 1.9% of the harvested area since 2017, but trembling aspen comprised 6.6% of the TSA land base, the species would be classified as non-commercial because 1.9% is less than half of 6.6% (i.e., 3.3%).

The above rules were applied to stands with the following dominant species:

  - Deciduous Species
    - Species codes: EA, RA, ACB, MB, E, VB, ACT, QG, DG, MN, ZH, EP, AC, AX, WS, ES, XH, W
  - Trembling Aspen
    - Species code: AT
  - Alder
    - Species codes: D, DR


**Note:** All harvested openings were excluded from this netdown step. In other words, if the area was ever harvested, it was not excluded out of the pTHLB due to being non-merchantable.

__R Scripts__

The following scripts were used to perform pre-processing:

```
src\analysis\1.non-commercial-species-import-layers.R
src\analysis\2.non-commercial-species-processing.R
src\analysis\3.non-commercial-species-classification.R
```

#### Non-Commercial Species Summary



``` r
lclass<-"Non-Commercial"
n_step<-"n14_non_commercial"

netdown_tab <- netdown_tab %>%
  mutate(n14_non_commercial = case_when(
    (!is.na(cc_year)) ~ NA, ##adjust non-merchantable value to NA if cell was ever previously a cutblock (I.e., consolidated cutblock year exists)
    is.na(cc_year) ~ n14_non_commercial
    )
  )

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 28,925,703 </td>
   <td style="text-align:right;"> 30.5154094 </td>
   <td style="text-align:right;"> 4,859,273.11 </td>
   <td style="text-align:right;"> 61,467,234 </td>
   <td style="text-align:right;"> 33,323,246 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 29,031,855 </td>
   <td style="text-align:right;"> 30.6273948 </td>
   <td style="text-align:right;"> 5,383,399.29 </td>
   <td style="text-align:right;"> 66,850,633 </td>
   <td style="text-align:right;"> 27,939,847 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Merchantable </td>
   <td style="text-align:right;"> 22,861,751 </td>
   <td style="text-align:right;"> 24.1181931 </td>
   <td style="text-align:right;"> 3,745,595.83 </td>
   <td style="text-align:right;"> 70,596,229 </td>
   <td style="text-align:right;"> 24,194,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Commercial </td>
   <td style="text-align:right;"> 6,241,057 </td>
   <td style="text-align:right;"> 6.5840546 </td>
   <td style="text-align:right;"> 570,450.02 </td>
   <td style="text-align:right;"> 71,166,679 </td>
   <td style="text-align:right;"> 23,623,801 </td>
  </tr>
</tbody>
</table>



### p15_future_retention


Stand level retention refers to unharvested areas associated with individual harvested openings. An analysis of retention practices derived from RESULTS spatial data collected from 2012 to 2024 were utilized to estimate total stand level retention for the province.

The retention estimate includes areas occupied by biodiversity, riparian retention, wildlife tree retention (grouped retention), as well as retention for the protection of forest values including archaeological features, site specific habitat features, and/or blue listed species or ecosystems. Stand level retention in the netdown process is modelled as an aspatial adjustment factor and applied to each hectare in the pTHLB, based on the adjusted area weighted mean stand level retention for the TSA.

This approach recognizes that although retention is not dispersed evenly across the land base the spatial variation in retention levels can be generalized across the land base without undue risk to yield estimation and forms a reasonable approximation for modelling timber supply in a TSA.

To calculate long-term retention, the percentage of coverage by RESULTS reserves relative to the total opening area was determined. Reserves with the Reserve Objective Code "TIM" (Timber Objective) were excluded from this calculation. The "TIM" objective does not represent long-term retention.

Additionally, the RESULTS reserves data was filtered to include:

+ Reserves with a silviculture reserve code of "G" (mapped reserves).
+ Disturbance data from 2012 onward, as the "G" reserve code was established in 2011 with a grace period of 1 year, before enforcement in 2012.
+ Only openings where the Opening Category Code is not in ('NREQ', 'SPEX', 'UHRV'), to exclude government-funded silviculture activities.

__Data Cleaning__

The distribution of percent retention across openings was analyzed along the exterior ring of each TSA (i.e., area-based tenures are considered retained within the TSA boundary). It is recognized that the RESULTS dataset contains potential data entry errors. To address this, lower and upper cutoffs were established to clean the data and remove outliers.

The lower cutoff was set at the 1st percentile. The upper cutoff was initially intended to be the 99th percentile; however, upon reviewing the distributions and conducting spot checks on unusually high retention percentages, it became evident that a more flexible upper cutoff was necessary. Ultimately, the upper cutoff was defined as the maximum percentile exceeding a subjective threshold of 0.5. The weighted mean of the cleaned RESULTS dataset for each TSA was calculated as the preliminary stand level retention factor. The table below provides the lower and upper cutoffs applied in this analysis for each TSA. The distributions of the retention percentage per result can be found within the Proxy THLB github repo here: 
```
data\analysis\retention\man_unit_retention_histograms_2024_12_12.pdf
```

**Note** Fort Nelson TSA did not have any RESULTS reserves data. As such, the retention results from the adjacent Fort St. John TSA will be used to represent retention in Fort Nelson TSA.
**Data sources:** BCGW layer: WHSE_FOREST_VEGETATION.RSLT_OPENING_SVW, WHSE_FOREST_VEGETATION.RSLT_FOREST_COVER_INV_SVW, WHSE_FOREST_VEGETATION.RSLT_FOREST_COVER_RESERVE_SVW

__R Scripts__

The following scripts were used to perform pre-processing:

```
src\analysis\1.retention-import-layers.R
src\analysis\2.retention-processing.R

```

#### Long Term Stand-Level Retention over all TSAs


``` r
query <- "SELECT 
  man_unit, 
  lower_bound_percentile, 
  upper_bound_percentile, 
  lower_bounds, 
  upper_bounds, 
  weighted_mean_ltr 
FROM 
whse.retention_thresholds_man_unit 
UNION ALL 
SELECT 
  '8 - Fort Nelson TSA', 
  lower_bound_percentile, 
  upper_bound_percentile, 
  lower_bounds, 
  upper_bounds, 
  weighted_mean_ltr 
FROM 
  whse.retention_thresholds_man_unit 
WHERE 
  man_unit = '40 - Fort St. John TSA'"
ltr_df <- sql_to_df(query, conn_list)

ltr_df <- ltr_df %>%
  mutate(across(c(lower_bounds, upper_bounds, weighted_mean_ltr), ~ round(.x * 100, 2)))


ltr_df <- ltr_df %>%
  rename(
    `Management Unit` = `man_unit`,
    `Lower Bound Percentile` = `lower_bound_percentile`,
    `Upper Bound Percentile` = `upper_bound_percentile`,
    `Lower Bounds (%)` = `lower_bounds`,
    `Upper Bounds (%)` = `upper_bounds`,
    `Weighted Mean Long Term Retention (%)` = `weighted_mean_ltr`
  )


kable(ltr_df,
      booktabs = T,
      format.args = list(big.mark = ","),
      caption =  "Long term stand-level retention" ) %>% 
  kable_styling(bootstrap_options = "striped",
                font_size = 10)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Long term stand-level retention</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> Management Unit </th>
   <th style="text-align:left;"> Lower Bound Percentile </th>
   <th style="text-align:left;"> Upper Bound Percentile </th>
   <th style="text-align:right;"> Lower Bounds (%) </th>
   <th style="text-align:right;"> Upper Bounds (%) </th>
   <th style="text-align:right;"> Weighted Mean Long Term Retention (%) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> 1 - Arrow TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 3.22 </td>
   <td style="text-align:right;"> 30.73 </td>
   <td style="text-align:right;"> 9.10 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 10 - Kalum TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 2.00 </td>
   <td style="text-align:right;"> 49.00 </td>
   <td style="text-align:right;"> 12.65 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 11 - Kamloops TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 0.73 </td>
   <td style="text-align:right;"> 47.23 </td>
   <td style="text-align:right;"> 11.06 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 12 - Kispiox TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p98 </td>
   <td style="text-align:right;"> 2.65 </td>
   <td style="text-align:right;"> 44.66 </td>
   <td style="text-align:right;"> 14.36 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 13 - Kootenay Lake TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p98 </td>
   <td style="text-align:right;"> 2.07 </td>
   <td style="text-align:right;"> 42.82 </td>
   <td style="text-align:right;"> 13.59 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 14 - Lakes TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 4.24 </td>
   <td style="text-align:right;"> 44.46 </td>
   <td style="text-align:right;"> 15.52 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 15 - Lillooet TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 1.38 </td>
   <td style="text-align:right;"> 36.98 </td>
   <td style="text-align:right;"> 11.44 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 16 - MacKenzie TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 3.48 </td>
   <td style="text-align:right;"> 37.62 </td>
   <td style="text-align:right;"> 12.31 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 17 - Robson Valley TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p91 </td>
   <td style="text-align:right;"> 2.49 </td>
   <td style="text-align:right;"> 44.31 </td>
   <td style="text-align:right;"> 13.21 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 18 - Merritt TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 1.16 </td>
   <td style="text-align:right;"> 36.45 </td>
   <td style="text-align:right;"> 8.96 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 2 - Boundary TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 3.10 </td>
   <td style="text-align:right;"> 32.96 </td>
   <td style="text-align:right;"> 9.17 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 20 - Morice TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 3.22 </td>
   <td style="text-align:right;"> 47.83 </td>
   <td style="text-align:right;"> 12.69 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 22 - Okanagan TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 2.22 </td>
   <td style="text-align:right;"> 37.49 </td>
   <td style="text-align:right;"> 9.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 23 - 100 Mile House TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 2.07 </td>
   <td style="text-align:right;"> 46.50 </td>
   <td style="text-align:right;"> 17.22 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 24 - Prince George TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 3.60 </td>
   <td style="text-align:right;"> 44.73 </td>
   <td style="text-align:right;"> 16.05 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 25 - Haida Gwaii TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p90 </td>
   <td style="text-align:right;"> 5.07 </td>
   <td style="text-align:right;"> 49.50 </td>
   <td style="text-align:right;"> 23.56 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 26 - Quesnel TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 1.81 </td>
   <td style="text-align:right;"> 46.85 </td>
   <td style="text-align:right;"> 13.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 27 - Revelstoke TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 2.74 </td>
   <td style="text-align:right;"> 42.89 </td>
   <td style="text-align:right;"> 12.01 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 29 - Williams Lake TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p96 </td>
   <td style="text-align:right;"> 0.70 </td>
   <td style="text-align:right;"> 46.79 </td>
   <td style="text-align:right;"> 15.42 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 3 - Bulkley TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p90 </td>
   <td style="text-align:right;"> 2.09 </td>
   <td style="text-align:right;"> 47.36 </td>
   <td style="text-align:right;"> 15.11 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 30 - Fraser TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 4.35 </td>
   <td style="text-align:right;"> 49.26 </td>
   <td style="text-align:right;"> 11.82 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 31 - Soo TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 3.63 </td>
   <td style="text-align:right;"> 44.82 </td>
   <td style="text-align:right;"> 16.87 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 38 - Arrowsmith TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 5.00 </td>
   <td style="text-align:right;"> 42.05 </td>
   <td style="text-align:right;"> 12.24 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 39 - Sunshine Coast TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 4.27 </td>
   <td style="text-align:right;"> 44.21 </td>
   <td style="text-align:right;"> 13.58 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 4 - Cassiar TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 8.39 </td>
   <td style="text-align:right;"> 48.27 </td>
   <td style="text-align:right;"> 21.39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 40 - Fort St. John TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 0.36 </td>
   <td style="text-align:right;"> 38.43 </td>
   <td style="text-align:right;"> 9.04 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 41 - Dawson Creek TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p91 </td>
   <td style="text-align:right;"> 2.40 </td>
   <td style="text-align:right;"> 40.11 </td>
   <td style="text-align:right;"> 11.97 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 43 - Nass TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 7.02 </td>
   <td style="text-align:right;"> 39.81 </td>
   <td style="text-align:right;"> 13.00 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 44 - Pacific TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p98 </td>
   <td style="text-align:right;"> 4.48 </td>
   <td style="text-align:right;"> 43.91 </td>
   <td style="text-align:right;"> 14.58 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 45 - Cascadia TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 3.22 </td>
   <td style="text-align:right;"> 43.78 </td>
   <td style="text-align:right;"> 12.01 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 46 - GBR North TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p98 </td>
   <td style="text-align:right;"> 6.46 </td>
   <td style="text-align:right;"> 40.93 </td>
   <td style="text-align:right;"> 15.81 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 47 - GBR South TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p98 </td>
   <td style="text-align:right;"> 7.22 </td>
   <td style="text-align:right;"> 41.92 </td>
   <td style="text-align:right;"> 15.30 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 48 - North Island TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 4.98 </td>
   <td style="text-align:right;"> 47.52 </td>
   <td style="text-align:right;"> 14.45 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 5 - Cranbrook TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p92 </td>
   <td style="text-align:right;"> 0.89 </td>
   <td style="text-align:right;"> 45.80 </td>
   <td style="text-align:right;"> 14.79 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 7 - Golden TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 2.79 </td>
   <td style="text-align:right;"> 46.51 </td>
   <td style="text-align:right;"> 10.93 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 9 - Invermere TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p97 </td>
   <td style="text-align:right;"> 0.83 </td>
   <td style="text-align:right;"> 47.90 </td>
   <td style="text-align:right;"> 15.61 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 8 - Fort Nelson TSA </td>
   <td style="text-align:left;"> p1 </td>
   <td style="text-align:left;"> p99 </td>
   <td style="text-align:right;"> 0.36 </td>
   <td style="text-align:right;"> 38.43 </td>
   <td style="text-align:right;"> 9.04 </td>
  </tr>
</tbody>
</table>



#### Stand-Level Retention Adjustment Process

Retention areas within openings may include non-THLB forest, such as non-merchantable stands. In the timber supply model, spatial retention is not explicitly incorporated into block design when generating cutblocks. Instead, a non-spatial reduction is applied to the THLB to account for stand-level (in-block) retention. Since the timber supply model only harvests within the THLB, it is necessary to determine the proportion of retention occurring within the THLB.

During the netdown process for stand-level retention, the percentage of retention is adjusted to reflect the proportion that overlaps the pTHLB.

To determine the proportion of retention in pTHLB the following process was used:

+ Rasterize stand-level retention to 1 hectare
+ Add rasterized binary retention value as a land base category into netdown table
+ Iterate through the TSA's
  - Determine the gross area that is the total retention area per TSA
  - Summarize retention area excluded by each netdown category (e.g., linear features, non-forest, non-merchantable forest, etc.).
  - Calculate the remaining retention area that does not overlap other land base exclusions.
  - Divide the remaining retention area by the gross retention area to derive an adjustment factor, representing the proportion of retention occurring within the pTHLB.


Graphs illustrating the distribution of stand-level retention area by land base category for each TSA can be found in the Proxy THLB GitHub repository at the following path: 

```
data\analysis\retention\<TSA> TSA_retention_adjustment_per_landclass.jpeg
```

The adjustment factor is then applied to the weighted mean long-term stand-level retention as follows:

Adjusted Stand-Level Retention = Weighted Mean Long-Term Stand-Level Retention x Adjustment Factor

A summary table below presents the weighted mean stand-level retention and corresponding adjustment factor for each TSA.

__Application in Land Base Classification:__

The adjusted stand-level retention proportion is applied as a non-spatial reduction across the pTHLB for each TSA. The pTHLB is adjusted as follows:

 - pthlb_net = pthlb_net * (1-TSA specific adjusted stand-level retention factor)



``` r


# Initialize a data frame to store results
all_tsa_results <- data.frame(
  tsa = character(),
  landclass = character(),
  Sum_Ret_Overlap = numeric(),
  Total_HA = numeric(),
  Percent = numeric(),
  stringsAsFactors = FALSE
)

tsas <- unique(netdown_tab$tsa_rank1)
## Loop through the tsa's to create a breakdown of total retention area and the areas removed leading to the retention area in THLB
for (tsa in tsas) {
  netdown_tab_tsa <- netdown_tab[which(netdown_tab$tsa_rank1 == tsa),]
  
  netdown_tab_ret <- netdown_tab_tsa[which(!is.na(netdown_tab_tsa$current_retention)),]
  if (nrow(netdown_tab_ret) == 0) {
  	print(glue('TSA: {tsa} does not any retention. Will use a proxy instead.'))
  	next
  }
  netdown_tab_ret <- transform(netdown_tab_ret, ret_overlap = 1)
  
  # List of columns to check
  columns <- c("n01_fmlb", "n02_ownership", "n03_ownership", "n04_nonfor", "p05_linear_features", "n06_parks", "n07_wha", "n08_misc", "p09_riparian", "n10_arch", "n11_harvest_restrictions", "p12_phys_inop", "n13_non_merchantable", "n14_non_commercial")

  
  # Total number of rows in the dataset
  total_rows <- nrow(netdown_tab_ret)
  
  # Previous sum for calculating differences
  previous_sum <- 0
  
  # Iterate through each column
  for (i in seq_along(columns)) {
    if (i == 1) {
      ## Manually insert first row as the total retention
      all_tsa_results <- rbind(
        all_tsa_results,
        data.frame(
          tsa = tsa,
          landclass = 'Total stand-level retention area',
          Sum_Ret_Overlap = total_rows,
          Total_HA = total_rows,
          Percent = 100,
          stringsAsFactors = FALSE
        )
      )
      previous_sum <- total_rows
    }
    
      
    col <- columns[i]
    
    if (startsWith(col, "n")) {
      # For columns starting with 'n', set to 0 where the column is NOT NA
      netdown_tab_ret$ret_overlap <- netdown_tab_ret$ret_overlap * ifelse(!is.na(netdown_tab_ret[[col]]), 0, 1)
    } else if (startsWith(col, "p")) {
      # For columns starting with 'p', multiply by the column values
      netdown_tab_ret$ret_overlap <- netdown_tab_ret$ret_overlap * ifelse(!is.na(1-netdown_tab_ret[[col]]), 1-netdown_tab_ret[[col]], 1)
    }
    
    # Calculate the current sum of ret_overlap
    current_sum <- sum(netdown_tab_ret$ret_overlap, na.rm = TRUE)
    
    # Calculate the total difference (current - previous)
    total_ha <- previous_sum - current_sum 
    
    # Calculate the percent of current ha / over total ha
    percent <- round((total_ha / total_rows) * 100, 2)
  
    # Add the results to the summary table
    all_tsa_results <- rbind(
      all_tsa_results,
      data.frame(
        tsa = tsa,
        landclass = col,
        Sum_Ret_Overlap = current_sum,
        Total_HA = total_ha,
        Percent = percent,
        stringsAsFactors = FALSE
      )
    )
    
    # Update the previous_sum for the next iteration
    previous_sum <- current_sum
  }
    ## manually add the last row of the remaning stand-level retention
    all_tsa_results <- rbind(
      all_tsa_results,
      data.frame(
        tsa = tsa,
        landclass = 'Remaining stand-level retention',
        Sum_Ret_Overlap = tail(all_tsa_results$Sum_Ret_Overlap, n = 1),
        Total_HA = tail(all_tsa_results$Sum_Ret_Overlap, n = 1),
        Percent = round(tail(all_tsa_results$Sum_Ret_Overlap, n = 1)/total_rows * 100,2),
        stringsAsFactors = FALSE
      )
    )
    
  results <-all_tsa_results[which(all_tsa_results$tsa == tsa),]
  results$landclass <- factor(results$landclass, levels = rev(unique(results$landclass)))
  
  plot <- ggplot(results) +
    aes(x = landclass, y = Total_HA, fill = landclass) +
    geom_col() +
    geom_text(aes(label = paste0(round(Total_HA,2), " ha; ", Percent, "%")), size = 3, hjust = -0.1) +
    labs(
      y = "Area (ha)",
      title = glue("{tsa}: RESULTS stand-level retention by land class category"),
      subtitle = "Area of retention by land base category and percent of total retention area",
      x = " "
    ) +
    coord_flip() +
    scale_y_continuous(limits = c(NA, max(results$Total_HA)+5000)) +
    theme_light() +
    guides(fill = "none")
  

  todays_date <- format(Sys.time(), "%Y-%m-%d")
  file_name <- paste('../../data/analysis/retention/', tsa, "_retention_adjustment_per_landclass.jpeg", sep='')
  ggsave(filename = file_name, plot = plot, width = 10, height = 6, dpi = 300)
  rm(plot)
}
## TSA: Fort Nelson TSA does not any retention. Will use a proxy instead.
```

``` r

df_new <- all_tsa_results %>%
  filter(tsa == "Fort St. John TSA") %>%
  mutate(tsa = "Fort Nelson TSA")

all_tsa_results <- bind_rows(all_tsa_results, df_new)

## write table that contains retention adjust to postgres
df_to_pg(Id(schema = 'whse', table = 'retention_adjustment_man_unit'), all_tsa_results, conn_list, overwrite=TRUE)


## join the previously created long term retention table to the newly created adjustment table & create the adjusted retention factor
query <- "WITH ltr AS (
SELECT * 
FROM 
whse.retention_thresholds_man_unit 
UNION ALL 
SELECT 
  '8 - Fort Nelson TSA', 
  lower_bound_percentile, 
  upper_bound_percentile, 
  lower_bounds, 
  upper_bounds, 
  weighted_mean_ltr 
FROM 
  whse.retention_thresholds_man_unit 
where 
  man_unit = '40 - Fort St. John TSA'
)
SELECT
	adj.tsa,
	ltr.weighted_mean_ltr,
	adj.percent/100 as percent,
	ltr.weighted_mean_ltr * adj.percent/100.0 as adjusted_retention
FROM 
ltr
JOIN whse.retention_adjustment_man_unit adj
ON 
  adj.tsa = split_part(ltr.man_unit, ' - ', 2)
WHERE 
  adj.landclass = 'Remaining stand-level retention'"
retention_adjustment_df <- sql_to_df(query, conn_list)

retention_adjustment_df <- retention_adjustment_df %>%
  mutate(across(c(weighted_mean_ltr, percent, adjusted_retention), ~ round(.x * 100, 2)))

retention_adjustment_df <- retention_adjustment_df %>%
  rename(
    `TSA` = `tsa`,
    `Long Term Retention` = `weighted_mean_ltr`,
    `Remaining Stand Level Retention (%)` = `percent`,
    `Adjustment Factor (%)` = `adjusted_retention`
  )

kable(retention_adjustment_df,
      booktabs = T,
      format.args = list(big.mark = ","),
      caption =  "Adjusted stand-level retention" ) %>% 
  kable_styling(bootstrap_options = "striped",
                font_size = 10)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Adjusted stand-level retention</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> TSA </th>
   <th style="text-align:right;"> Long Term Retention </th>
   <th style="text-align:right;"> Remaining Stand Level Retention (%) </th>
   <th style="text-align:right;"> Adjustment Factor (%) </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Arrow TSA </td>
   <td style="text-align:right;"> 9.10 </td>
   <td style="text-align:right;"> 59.72 </td>
   <td style="text-align:right;"> 5.43 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Kalum TSA </td>
   <td style="text-align:right;"> 12.65 </td>
   <td style="text-align:right;"> 57.53 </td>
   <td style="text-align:right;"> 7.28 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Kamloops TSA </td>
   <td style="text-align:right;"> 11.06 </td>
   <td style="text-align:right;"> 70.60 </td>
   <td style="text-align:right;"> 7.81 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Kispiox TSA </td>
   <td style="text-align:right;"> 14.36 </td>
   <td style="text-align:right;"> 59.90 </td>
   <td style="text-align:right;"> 8.60 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Kootenay Lake TSA </td>
   <td style="text-align:right;"> 13.59 </td>
   <td style="text-align:right;"> 63.27 </td>
   <td style="text-align:right;"> 8.60 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Lakes TSA </td>
   <td style="text-align:right;"> 15.52 </td>
   <td style="text-align:right;"> 58.53 </td>
   <td style="text-align:right;"> 9.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Lillooet TSA </td>
   <td style="text-align:right;"> 11.44 </td>
   <td style="text-align:right;"> 59.88 </td>
   <td style="text-align:right;"> 6.85 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> MacKenzie TSA </td>
   <td style="text-align:right;"> 12.31 </td>
   <td style="text-align:right;"> 66.02 </td>
   <td style="text-align:right;"> 8.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Robson Valley TSA </td>
   <td style="text-align:right;"> 13.21 </td>
   <td style="text-align:right;"> 81.15 </td>
   <td style="text-align:right;"> 10.72 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Merritt TSA </td>
   <td style="text-align:right;"> 8.96 </td>
   <td style="text-align:right;"> 65.58 </td>
   <td style="text-align:right;"> 5.88 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Boundary TSA </td>
   <td style="text-align:right;"> 9.17 </td>
   <td style="text-align:right;"> 61.19 </td>
   <td style="text-align:right;"> 5.61 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Morice TSA </td>
   <td style="text-align:right;"> 12.69 </td>
   <td style="text-align:right;"> 51.56 </td>
   <td style="text-align:right;"> 6.54 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Okanagan TSA </td>
   <td style="text-align:right;"> 9.13 </td>
   <td style="text-align:right;"> 66.67 </td>
   <td style="text-align:right;"> 6.09 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> 100 Mile House TSA </td>
   <td style="text-align:right;"> 17.22 </td>
   <td style="text-align:right;"> 61.40 </td>
   <td style="text-align:right;"> 10.58 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Prince George TSA </td>
   <td style="text-align:right;"> 16.05 </td>
   <td style="text-align:right;"> 63.66 </td>
   <td style="text-align:right;"> 10.21 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Haida Gwaii TSA </td>
   <td style="text-align:right;"> 23.56 </td>
   <td style="text-align:right;"> 72.99 </td>
   <td style="text-align:right;"> 17.20 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Quesnel TSA </td>
   <td style="text-align:right;"> 13.00 </td>
   <td style="text-align:right;"> 58.28 </td>
   <td style="text-align:right;"> 7.57 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Revelstoke TSA </td>
   <td style="text-align:right;"> 12.01 </td>
   <td style="text-align:right;"> 62.84 </td>
   <td style="text-align:right;"> 7.55 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Williams Lake TSA </td>
   <td style="text-align:right;"> 15.42 </td>
   <td style="text-align:right;"> 63.67 </td>
   <td style="text-align:right;"> 9.82 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Bulkley TSA </td>
   <td style="text-align:right;"> 15.11 </td>
   <td style="text-align:right;"> 63.99 </td>
   <td style="text-align:right;"> 9.67 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Fraser TSA </td>
   <td style="text-align:right;"> 11.82 </td>
   <td style="text-align:right;"> 70.14 </td>
   <td style="text-align:right;"> 8.29 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Soo TSA </td>
   <td style="text-align:right;"> 16.87 </td>
   <td style="text-align:right;"> 72.42 </td>
   <td style="text-align:right;"> 12.22 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Arrowsmith TSA </td>
   <td style="text-align:right;"> 12.24 </td>
   <td style="text-align:right;"> 59.97 </td>
   <td style="text-align:right;"> 7.34 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Sunshine Coast TSA </td>
   <td style="text-align:right;"> 13.58 </td>
   <td style="text-align:right;"> 67.39 </td>
   <td style="text-align:right;"> 9.15 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Cassiar TSA </td>
   <td style="text-align:right;"> 21.39 </td>
   <td style="text-align:right;"> 70.10 </td>
   <td style="text-align:right;"> 14.99 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Fort St. John TSA </td>
   <td style="text-align:right;"> 9.04 </td>
   <td style="text-align:right;"> 60.38 </td>
   <td style="text-align:right;"> 5.46 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Dawson Creek TSA </td>
   <td style="text-align:right;"> 11.97 </td>
   <td style="text-align:right;"> 70.91 </td>
   <td style="text-align:right;"> 8.49 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Nass TSA </td>
   <td style="text-align:right;"> 13.00 </td>
   <td style="text-align:right;"> 49.26 </td>
   <td style="text-align:right;"> 6.41 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Pacific TSA </td>
   <td style="text-align:right;"> 14.58 </td>
   <td style="text-align:right;"> 58.53 </td>
   <td style="text-align:right;"> 8.53 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Cascadia TSA </td>
   <td style="text-align:right;"> 12.01 </td>
   <td style="text-align:right;"> 60.66 </td>
   <td style="text-align:right;"> 7.29 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GBR North TSA </td>
   <td style="text-align:right;"> 15.81 </td>
   <td style="text-align:right;"> 57.78 </td>
   <td style="text-align:right;"> 9.13 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> GBR South TSA </td>
   <td style="text-align:right;"> 15.30 </td>
   <td style="text-align:right;"> 28.69 </td>
   <td style="text-align:right;"> 4.39 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> North Island TSA </td>
   <td style="text-align:right;"> 14.45 </td>
   <td style="text-align:right;"> 58.68 </td>
   <td style="text-align:right;"> 8.48 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Cranbrook TSA </td>
   <td style="text-align:right;"> 14.79 </td>
   <td style="text-align:right;"> 52.12 </td>
   <td style="text-align:right;"> 7.71 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Golden TSA </td>
   <td style="text-align:right;"> 10.93 </td>
   <td style="text-align:right;"> 44.68 </td>
   <td style="text-align:right;"> 4.89 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Invermere TSA </td>
   <td style="text-align:right;"> 15.61 </td>
   <td style="text-align:right;"> 32.54 </td>
   <td style="text-align:right;"> 5.08 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Fort Nelson TSA </td>
   <td style="text-align:right;"> 9.04 </td>
   <td style="text-align:right;"> 60.38 </td>
   <td style="text-align:right;"> 5.46 </td>
  </tr>
</tbody>
</table>



``` r


retention_adjustment_df <- sql_to_df(query, conn_list)
```

#### Stand-level Retention Summary


``` r
## add in the adjusted retention as a column in the netdown dataframe
netdown_tab <- netdown_tab %>%
  left_join(
    retention_adjustment_df %>% select(tsa, adjusted_retention), 
    by = c("tsa_rank1" = "tsa")
  ) %>%
  rename(p15_future_retention = adjusted_retention)

lclass<-"Future Retention"
n_step<-"p15_future_retention"


netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-p15_future_retention))

running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 28,925,703 </td>
   <td style="text-align:right;"> 30.5154094 </td>
   <td style="text-align:right;"> 4,859,273.11 </td>
   <td style="text-align:right;"> 61,467,234 </td>
   <td style="text-align:right;"> 33,323,246 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 29,031,855 </td>
   <td style="text-align:right;"> 30.6273948 </td>
   <td style="text-align:right;"> 5,383,399.29 </td>
   <td style="text-align:right;"> 66,850,633 </td>
   <td style="text-align:right;"> 27,939,847 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Merchantable </td>
   <td style="text-align:right;"> 22,861,751 </td>
   <td style="text-align:right;"> 24.1181931 </td>
   <td style="text-align:right;"> 3,745,595.83 </td>
   <td style="text-align:right;"> 70,596,229 </td>
   <td style="text-align:right;"> 24,194,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Commercial </td>
   <td style="text-align:right;"> 6,241,057 </td>
   <td style="text-align:right;"> 6.5840546 </td>
   <td style="text-align:right;"> 570,450.02 </td>
   <td style="text-align:right;"> 71,166,679 </td>
   <td style="text-align:right;"> 23,623,801 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Future Retention </td>
   <td style="text-align:right;"> 8,405,527 </td>
   <td style="text-align:right;"> 8.8674798 </td>
   <td style="text-align:right;"> 2,070,009.10 </td>
   <td style="text-align:right;"> 73,236,688 </td>
   <td style="text-align:right;"> 21,553,792 </td>
  </tr>
</tbody>
</table>



### pTHLB Land Base Summary


``` r
lclass<-"LAND BASE SUMMARY - pTHLB"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=thlb_net)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> net_excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 94,790,480 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 94,790,480 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 38.1115087 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 58,664,398 </td>
   <td style="text-align:right;"> 61.8884913 </td>
   <td style="text-align:right;"> 36,126,082.00 </td>
   <td style="text-align:right;"> 36,126,082 </td>
   <td style="text-align:right;"> 58,664,398 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 4,884,376 </td>
   <td style="text-align:right;"> 5.1528128 </td>
   <td style="text-align:right;"> 2,841,457.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 55,822,941 </td>
   <td style="text-align:right;"> 58.8908728 </td>
   <td style="text-align:right;"> 38,967,539.00 </td>
   <td style="text-align:right;"> 38,967,539 </td>
   <td style="text-align:right;"> 55,822,941 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_pAFLB </td>
   <td style="text-align:right;"> 668,186 </td>
   <td style="text-align:right;"> 0.7049083 </td>
   <td style="text-align:right;"> 414,385.00 </td>
   <td style="text-align:right;"> 39,381,924 </td>
   <td style="text-align:right;"> 55,408,556 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 39,808,397 </td>
   <td style="text-align:right;"> 41.9961973 </td>
   <td style="text-align:right;"> 4,991,866.00 </td>
   <td style="text-align:right;"> 44,373,790 </td>
   <td style="text-align:right;"> 50,416,690 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 1,802,600 </td>
   <td style="text-align:right;"> 1.9016676 </td>
   <td style="text-align:right;"> 1,189,439.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pAFLB </td>
   <td style="text-align:right;"> 49,227,251 </td>
   <td style="text-align:right;"> 51.9326951 </td>
   <td style="text-align:right;"> 45,563,229.00 </td>
   <td style="text-align:right;"> 45,563,229 </td>
   <td style="text-align:right;"> 49,227,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 14,032,699 </td>
   <td style="text-align:right;"> 14.8039117 </td>
   <td style="text-align:right;"> 6,015,443.71 </td>
   <td style="text-align:right;"> 51,578,673 </td>
   <td style="text-align:right;"> 43,211,807 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 3,878,931 </td>
   <td style="text-align:right;"> 4.0921103 </td>
   <td style="text-align:right;"> 1,427,125.40 </td>
   <td style="text-align:right;"> 53,005,798 </td>
   <td style="text-align:right;"> 41,784,682 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 3,091,866 </td>
   <td style="text-align:right;"> 3.2617896 </td>
   <td style="text-align:right;"> 1,606,519.75 </td>
   <td style="text-align:right;"> 54,612,318 </td>
   <td style="text-align:right;"> 40,178,162 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 10,472,075 </td>
   <td style="text-align:right;"> 11.0476025 </td>
   <td style="text-align:right;"> 1,973,447.13 </td>
   <td style="text-align:right;"> 56,585,765 </td>
   <td style="text-align:right;"> 38,204,715 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 70,092 </td>
   <td style="text-align:right;"> 0.0739441 </td>
   <td style="text-align:right;"> 22,195.54 </td>
   <td style="text-align:right;"> 56,607,961 </td>
   <td style="text-align:right;"> 38,182,519 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 28,925,703 </td>
   <td style="text-align:right;"> 30.5154094 </td>
   <td style="text-align:right;"> 4,859,273.11 </td>
   <td style="text-align:right;"> 61,467,234 </td>
   <td style="text-align:right;"> 33,323,246 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 29,031,855 </td>
   <td style="text-align:right;"> 30.6273948 </td>
   <td style="text-align:right;"> 5,383,399.29 </td>
   <td style="text-align:right;"> 66,850,633 </td>
   <td style="text-align:right;"> 27,939,847 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Merchantable </td>
   <td style="text-align:right;"> 22,861,751 </td>
   <td style="text-align:right;"> 24.1181931 </td>
   <td style="text-align:right;"> 3,745,595.83 </td>
   <td style="text-align:right;"> 70,596,229 </td>
   <td style="text-align:right;"> 24,194,251 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Commercial </td>
   <td style="text-align:right;"> 6,241,057 </td>
   <td style="text-align:right;"> 6.5840546 </td>
   <td style="text-align:right;"> 570,450.02 </td>
   <td style="text-align:right;"> 71,166,679 </td>
   <td style="text-align:right;"> 23,623,801 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Future Retention </td>
   <td style="text-align:right;"> 8,405,527 </td>
   <td style="text-align:right;"> 8.8674798 </td>
   <td style="text-align:right;"> 2,070,009.10 </td>
   <td style="text-align:right;"> 73,236,688 </td>
   <td style="text-align:right;"> 21,553,792 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LAND BASE SUMMARY - pTHLB </td>
   <td style="text-align:right;"> 21,553,792 </td>
   <td style="text-align:right;"> 22.7383511 </td>
   <td style="text-align:right;"> 73,236,687.88 </td>
   <td style="text-align:right;"> 73,236,688 </td>
   <td style="text-align:right;"> 21,553,792 </td>
  </tr>
</tbody>
</table>



### pTHLB Land Base Modification
In the event that modifications of the land bases or netdown factors are required, a few suggestions are provided. 

 + Make a local copy of this git repository and modify this R markdown to include/exclude new or modified netdown factors. 
 + SQL is provided below of how the land base columns can be recreated using SQL instead of R. This can be useful when wanting to skip the process of the netdown table in favor of quickly updating the THLB field
 

``` sql
WITH harvest_netdown_adjustment AS (
SELECT
	gr_skey,
	-- recreate what the R netdown does by adjusting physically inoperable to be 1 when a cutblocks exists (harvest start year is pulled from consolidated cutblocks layer)
	CASE 
		WHEN harvest_start_year_calendar IS NOT NULL THEN 0
		ELSE p12_phys_inop
	END AS p12_phys_inop,
	-- recreate what the R netdown does by adjusting merchantability to be NULL when a cutblocks exists (harvest start year is pulled from consolidated cutblocks layer)
	CASE 
		WHEN harvest_start_year_calendar IS NOT NULL THEN NULL
		ELSE n13_non_merchantable
	END AS n13_non_merchantable,
	-- recreate what the R netdown does by adjusting non commercial to be NULL when a cutblocks exists (harvest start year is pulled from consolidated cutblocks layer)
	CASE 
		WHEN harvest_start_year_calendar IS NOT NULL THEN NULL
		ELSE n14_non_commercial
	END AS n14_non_commercial	
FROM
<public.proxy_table> net -- <- edit with the imported proxy table from the SQL dump
)
select 	
	sum(CASE
			WHEN 
				n01_fmlb IS NULL 
				THEN 1 
			ELSE 0 
		END) as fmlb,
	sum(CASE 
			-- categorical netdowns
			WHEN 
				n01_fmlb IS NULL AND 
				n02_ownership IS NULL 
				THEN 1
			ELSE 0 
		END) as falb,
	sum(CASE
			WHEN 
				n01_fmlb IS NULL AND 
				n02_ownership IS NULL AND 
				n03_ownership IS NULL AND 
				n04_nonfor IS NULL 
				THEN 1 * (1-p05_linear_features)
			ELSE 0 
		END) as paflb,
	sum(CASE 
			WHEN 
				-- categorical netdowns
				n01_fmlb IS NULL AND 
				n02_ownership IS NULL AND 
				n03_ownership IS NULL AND 
				n04_nonfor IS NULL AND 
				n06_parks IS NULL AND 
				n07_wha IS NULL AND 
				n08_misc IS NULL AND 
				n10_arch IS NULL AND
				n11_harvest_restrictions IS NULL AND
				adj.n13_non_merchantable IS NULL AND
				adj.n14_non_commercial IS NULL
				-- proportional netdowns
				THEN 1 * (1-p05_linear_features) * (1-p09_riparian) * (1-adj.p12_phys_inop) * (1-p15_future_retention)
			ELSE 0 
		END) as pthlb_net
from
<public.proxy_table> net -- <- edit with the imported proxy table from the SQL dump
JOIN harvest_netdown_adjustment adj USING (gr_skey);
```
 
 

``` r

df_to_pg(Id(schema = 'whse', table = 'prov_netdown_temp'), netdown_tab[,c('gr_skey', 'fmlb', 'falb', 'aflb', 'thlb_net', 'p15_future_retention')], conn_list, overwrite=TRUE)

```




``` r
query <- "UPDATE whse.thlb_proxy_netdown set 
  fmlb = a.fmlb,
  falb = a.falb,
  paflb = a.aflb,
  pthlb_net = a.thlb_net,
  p15_future_retention = a.p15_future_retention
from
  whse.prov_netdown_temp a
where a.gr_skey = whse.thlb_proxy_netdown.gr_skey;"
run_sql_r(query, conn_list)
```

