---
title: "Provincial Netdown"
author: "Hailey Eckstrand"
date: "Last run on January 16, 2025"
output: 
  html_document:
    code_folding: hide
    # highlight: monochrome
    highlight: tango
    keep_md: yes
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
---

## Background

This report describes the data and methodology used to classify the Provincial THLB Proxy land base into four nested categories: Forest Management Land Base (FMLB), Forest Assessment Land Base (FALB), Analysis Forested Land Base (AFLB) and Timber Harvesting Land Base (THLB).

### Document setup


``` r
r_version <- R.version.string
```

This report is prepared using [RStudio](https://www.rstudio.com) and R version 4.3.2 (2023-10-31 ucrt). All necessary R package libraries have been loaded into the work environment, and the required document elements have been set up.


``` r
# load libraries:
library(knitr)
library(kableExtra)
library(tidyverse)
library(sf)
library(ggnewscale)
library(tidyterra)
library(tmap)
library(ggspatial)
library(scales)
library(cowplot)
library(mapview)
library(tidytext)
library(janitor)

rm(list = ls())

start<-Sys.time()

#knitr...read about knitr here: https://sachsmc.github.io/knit-git-markr-guide/knitr/knit.html
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
knitr::opts_chunk$set(connection = "db")
knitr::opts_knit$set(sql.max.print = NA)
knitr::opts_chunk$set(fig.width = 8.5, fig.height = 7, collapse = TRUE)
```

### Netdown process overview

The netdown process is a progressive exclusion algorithm where the BC land base is classified into four nested categories: FMLB, FALB, AFLB, and THLB:

To delineate the 4 land base categories, several deductions occur, each of which is described in detail in this document. For each deduction, two steps are followed:

1.  Categorize the area deduction in a *netdown dataframe:*
    -   The netdown dataframe includes a record for each hectare within the Province and multiple fields used to determine area deductions. For example:

    -   The FMLB, FALB, AFLB and THLB variables are updated with each area deduction. Initially, the FMLB, FALB, AFLB and THLB all have a value of one. The value gets updated with each area deduction. 

2.  Summarize the area deductions in a netdown summary table - the table summarizes area information for each area deduction:
    -   The **total** area is the gross area for the area deduction category/landclass,
    -   The **percent** is the percent of total landbase,
    -   The **excluded** value is the area that is excluded from the final THLB - the areas are excluded in the order they appear in the netdown summary table and account for areas excluded in previous deductions.
    -   The **running total** value is the combined total of excluded area for the landclass and each previous landclass identified in the table,
    -   The **netdown** is the remaining area after excluded area is removed. The final value (bottom row) is the THLB.

For example:

### Categorical vs. numerical area deduction variables

**Categorical** variables are nominal variables that describe the type of area being excluded - there is no intrinsic ordering or ranking within each categorical netdown variable. For example, the ownership description variable classifies each hectare by the excluded ownership type (e.g., private land, federal land, etc.). In the netdown dataframe, categorical variables are prefixed with "n" followed by the order in which they occur in the netdown process (e.g., n01_fmlb occurs first)

**Numerical** variables capture finer resolution (i.e. less than 100-meter resolution) area deductions and contain numeric values that define the proportion of a given hectare that will be excluded from the AFLB and THLB (e.g., 10% of a 1-hectare grid cell may be occupied by road). Numeric variable names are prefixed with "p" followed by the order in which they occur (e.g., p04_lineal_features occurs 4th in the netdown process).


## Data assembly

Prior to completing the netdown process that creates the netdown dataframe and thlb summary, pre-processing was performed to create tables that contribute to the creation of the netdown table.

### Netdown dataframe

Area deduction variables that are required to classify the land base are loaded into the netdown dataframe through a postgres query. FMLB, FALB, AFLB, and THLB variables are added to the dataframe with default values of 1. As the netdown process continues, new variables are added corresponding to each area deduction factor and the FMLB, FALB, AFLB, and THLB values are updated accordingly.

### Netdown summary table

The netdown summary table is initially created with the Provincial Boundary. As the netdown process progresses, each area deduction is appended as a new row.

**Data source:** S:\\FOR\\VIC\\HTS\\ANA\\workarea\\PROVINCIAL\\BC_Boundary_Terrestrial.tif


``` r
library(dadmtools)
library(dplyr)
library(knitr)
library(kableExtra)
library(tidyverse)
source('../utils/functions.R')

conn_list <- dadmtools::get_pg_conn_list()
## The following query was ran prior
## src\analysis\3.netdown-create-table.R
query <- "	SELECT 
  p.gr_skey,
  p.tsa_rank1,
  p.own,
  p.wha_label,
  p.harvest_restriction_class_name,
  p.land_designation_type_code,
  p.harvest_start_year_calendar AS cc_year,
  p.res_opening_id,
	p.n01_fmlb,
	p.n02_ownership,
	p.n03_ownership,
	p.n04_nonfor,
	p.p05_linear_features,
	p.n06_parks,
	p.n07_wha,
	p.n08_rec,
	p.n09_misc,
	p.p10_riparian,
  p.n11_arch,
	p.n12_harvest_restrictions,
	p.p13_phys_inop,
	p.n14_merchantability,
	p.n15_non_commercial
FROM thlb_proxy.prov_netdown p
-- JOIN public.tsa13_netdown USING (gr_skey)                                                                                                                  -- 1,240,878 || AFLB = 753,633.27
-- WHERE tsa_rank1 = 'Kootenay Lake TSA'                                                                                                                      -- 1,240,878 || AFLB = 753,633.27
-- JOIN whse.prov_thlb_tsas_gr_skey thlb_key ON p.gr_skey = thlb_key.gr_skey JOIN whse.prov_thlb_tsas thlb ON thlb.pgid = thlb_key.pgid WHERE tsa_number = 13 -- 684,539   || AFLB = 663,045.87
WHERE man_unit = 'Kootenay Lake TSA' 
"
netdown_tab <- sql_to_df(query, conn_list)
netdown_summary <- setup_tracking_variable(netdown_tab)
running_total <- 0
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
</tbody>
</table>




## Netdown steps

Each netdown step (area deduction) is described in the following sub-sections.

## Delineating the FMLB

The following area deductions are removed from the Provincial Boundary area to classify the FMLB. The FMLB used for the provincial THLB Proxy is an adjusted version of the VRI field: `for_mgmt_land_base_ind`. A description and code snippet of the `for_mgmt_land_base_ind` is below. The field is a text field composed of either:

- 'N': non forested 
- 'Y': forested 

Description:

+ 'N' if BEC.natural_disturbance = 'NDT5'
+ 'Y' if harvest IS TRUE, (harvest is defined as: harvest is TRUE if vri.harvest_date is not null OR consolidated cutblocks exist OR vri.opening_id or vri.opening_number IS NOT NULL or '0' otherwise 'N')
+ 'Y' if (vri.bclcs_level_1 IN ('U', '') AND btm.present_land_use_label in ('Old Forest', 'Recently Logged', 'Selectively Logged', 'Young Forest'))
+ 'N' if bclcs_level_1 = 'V' AND bclcs_level_2 <> 'T' and vri.project NOT LIKE 'FIRE_UPDATE%'
+ 'N' if URBAN is true AND vri.for_mgmt_land_base_ind = 'Y', (URBAN defined as: URBAN IS TRUE if vri.non_productive_descriptor_cd = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' vri.OR land_cover_class_cd_3 = 'UR')
+ OTHERWISE vri.for_mgmt_land_base_ind

Code:
The following code snippet show's how `for_mgmt_land_base_ind` is derived.



``` sql
WITH recreate_for_mgmt_land_base_ind AS (
SELECT
  CASE
      -- when harvest does not exist
      WHEN (nullif(v.opening_id::text,'0') IS NULL AND nullif(v.opening_number::text,'0') IS NULL AND v.harvest_date IS NULL)
      -- AND
      AND
      -- inventory code = Forest Inventory Planning (FIP);
      -- AND is non productive or unreported
      -- OR
        (
        (
          v.inventory_standard_cd = 'F' 
          AND
          (
          (v.non_productive_cd IS NOT NULL AND v.non_productive_cd <> '00') 
          OR
            (v.non_productive_descriptor_cd IS NOT NULL AND v.non_productive_descriptor_cd <> '00') 
          OR
            v.bclcs_level_1 = 'U'
          )
        )
      -- inventory code != Forest Inventory Planning (FIP);
      -- AND land cover classification either non-vegetated or unreported
      -- OR
      OR
        (
          v.inventory_standard_cd IN ('V', 'I', 'L') 
          AND 
          (
            v.bclcs_level_1 In ('N', 'U')
            OR
            v.bclcs_level_3 = 'A'
          )
        )
      OR
      -- site_index < 5
        (
          COALESCE(COALESCE(v.site_index, v.est_site_index),0) < 5
        )
        )
      then
        'N'
      else
        'Y'
    END fmlb_initial,
    inventory_standard_cd,
    earliest_nonlogging_dist_type,
    crown_closure,
    site_index,
    bclcs_level_1,
    bclcs_level_2,
    bclcs_level_3,
    project
FROM
  whse.veg_comp_lyr_r1_poly_internal_2023 v
)
SELECT
-- Some Fire Update polygons are flipped back from N to Y if they fall into the following pattern:
	CASE WHEN project ilike 'FIRE_UPDATE%' 
		AND inventory_standard_cd = 'V' 
		AND earliest_nonlogging_dist_type like 'B%' 
		AND crown_closure < 5
		AND site_index >= 5
		AND bclcs_level_1 = 'N'
		AND bclcs_level_2 = 'L'
		AND bclcs_level_3 = 'U'
		AND fmlb_initial = 'N'
	THEN 'Y' 
	ELSE fmlb_initial
	END AS fmlb_recreate
FROM
recreate_for_mgmt_land_base_ind;
```


Below is a SQL snippet illustrating the logic used to build adjusted FMLB:


``` sql
		CASE 
			WHEN bec.natural_disturbance = 'NDT5' THEN 'NDT5'
			-- if its been harvested then its forested
			WHEN (nullif(vri.opening_id::text,'0') is not null or nullif(vri.opening_number::text,'0') is not null or cc.harvest_start_year_calendar is not null or ccg.gr_skey is not null) THEN NULL
			-- bring back in btm forested
			WHEN (coalesce(vri.bclcs_level_1,'') IN ('U', '') AND btm.present_land_use_label IN ('Old Forest', 'Recently Logged', 'Selectively Logged','Young Forest')) THEN NULL
			-- exclude where vegetated, not treed and not fire_update
			WHEN vri.bclcs_level_1 = 'V' AND coalesce(vri.bclcs_level_2,'') <> 'T' AND vri.project NOT LIKE 'FIRE_UPDATE%' THEN 'not_treed_not_fire'
			-- exclude urban that has been classified as forested
			WHEN ((trim(vri.non_productive_descriptor_cd) = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' OR vri.land_cover_class_cd_3 = 'UR' OR vri.non_veg_cover_type_1 = 'UR')) AND (coalesce(vri.for_mgmt_land_base_ind,'Y') = 'Y') THEN 'URBAN and fmlb_orig = Y'
			WHEN vri.for_mgmt_land_base_ind = 'Y' THEN NULL
			WHEN vri.for_mgmt_land_base_ind = 'N' THEN 'fmlb_orig = N'
		END AS n01_fmlb
```

**Data sources:** BCGW files: WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_BASEMAPPING.BTM_PRESENT_LAND_USE_V1_SVW, WHSE_FOREST_VEGETATION.BEC_BIOGEOCLIMATIC_POLY



``` r
netdown_tab <- netdown_tab %>%
  mutate(
    fmlb = 1,
    falb = 1,
    aflb = 1,
    thlb_net = 1,
    thlb_pre_ret = 1
  )

lclass<-"FMLB"
n_step<-"n01_fmlb"

netdown_summary <- netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab <- update_areas_fmlb(netdown_tab,n_step)
running_total <- get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100.00000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 32.62627 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
</tbody>
</table>




### FMLB Summary


``` r
lclass<-"LANDBASE SUMMARY - FMLB"

netdown_summary <- landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=fmlb)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100.00000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 32.62627 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564 </td>
   <td style="text-align:right;"> 67.37373 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
</tbody>
</table>




## Delineating the FALB

The following area deductions are removed from the FMLB to classify the FALB

### n02_ownership

The next phase of the netdown process delineates the FALB from the FMLB. The FALB excludes private, municipal and first nation reserve lands. Below is a specific list of ownership classes excluded:

+ 40N, Private, - Parcel has a title registered to a First Nations group
+ 41N, Private - Land Claim Settlement Area
+ 52N, Federal - Indian Reserve
+ 80N, Crown Municipal Parcels

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN


``` r

lclass<-"Ownership_Areas_Excluded_from_FALB"
n_step<-"n02_ownership"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_falb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100.00000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 32.62627 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564 </td>
   <td style="text-align:right;"> 67.37373 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524 </td>
   <td style="text-align:right;"> 10.15226 </td>
   <td style="text-align:right;"> 70,188 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
</tbody>
</table>



### FALB Summary


``` r

lclass<-"LANDBASE SUMMARY - FALB"

netdown_summary <- landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=falb)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100.00000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 32.62627 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564 </td>
   <td style="text-align:right;"> 67.37373 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524 </td>
   <td style="text-align:right;"> 10.15226 </td>
   <td style="text-align:right;"> 70,188 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376 </td>
   <td style="text-align:right;"> 61.36172 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
</tbody>
</table>



## Delineating the AFLB

The following area deductions are removed from the FALB to classify the AFLB

### n03_ownership

The next phase of the netdown process delineates the AFLB from the FALB. 
The FALB excludes the remaining federal lands. Below is a specific list of ownership classes excluded:

+ 50N, Federal - Federal Reserve
+ 51N, Federal - National Park
+ 53N, Federal - Military Reserve
+ 54N, Federal - Dominion government Block/Federal Parcels

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN


``` r

lclass<-"Ownership_Areas_Excluded_from_AFLB"
n_step<-"n03_ownership"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_aflb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown <- get_netdown(netdown_summary,lclass)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 451,113 </td>
   <td style="text-align:right;"> 716,351 </td>
  </tr>
</tbody>
</table>




### n04_nonfor

The FALB land base is further excluded to create a 'not forested or non productive forest'.  These land cover types are not expected to contribute to either timber supply or non-timber management objectives that are based on forested conditions. Attributes that identify non-vegetated and various classes of vegetated areas are classified based on the BC land classification system (BCLCS), the Freshwater Atlas and the Biogeoclimatic Ecosystem Classification (BEC). Areas within historic cutblocks are considered forested and contribute to the THLB except where noted below.

Identifying non-forest/non-productive is done using a long 'case when' statement in a previous postgres table creation. In the netdown table each non-productive class is assigned it’s own descriptive label under the variable n04_nonfor.

**Data sources:** BCGW files: WHSE_FOREST_VEGETATION.VEG_COMP_LYR_R1_POLY, WHSE_FOREST_VEGETATION.VEG_CONSOLIDATED_CUT_BLOCKS_SP, WHSE_BASEMAPPING.FWA_WETLANDS_POLY

Below is a SQL snippet illustrating the logic used to build non-productive and non-forest areas:


``` sql
		CASE 
			WHEN bec.natural_disturbance = 'NDT5' THEN 'NDT5'
			-- if its been harvested then its forested
			WHEN (nullif(vri.opening_id::text,'0') is not null or nullif(vri.opening_number::text,'0') is not null or cc.harvest_start_year_calendar is not null or ccg.gr_skey is not null) THEN NULL
			-- bring back in btm forested
			WHEN (coalesce(vri.bclcs_level_1,'') IN ('U', '') AND btm.present_land_use_label IN ('Old Forest', 'Recently Logged', 'Selectively Logged','Young Forest')) THEN NULL
			-- exclude where vegetated, not treed and not fire_update
			WHEN vri.bclcs_level_1 = 'V' AND coalesce(vri.bclcs_level_2,'') <> 'T' AND vri.project NOT LIKE 'FIRE_UPDATE%' THEN 'not_treed_not_fire'
			-- exclude urban that has been classified as forested
			WHEN ((trim(vri.non_productive_descriptor_cd) = 'U' OR vri.bclcs_level_5 = 'UR' OR vri.land_cover_class_cd_1 = 'UR' OR vri.land_cover_class_cd_2 = 'UR' OR vri.land_cover_class_cd_3 = 'UR' OR vri.non_veg_cover_type_1 = 'UR')) AND (coalesce(vri.for_mgmt_land_base_ind,'Y') = 'Y') THEN 'URBAN and fmlb_orig = Y'
			WHEN vri.for_mgmt_land_base_ind = 'Y' THEN NULL
			WHEN vri.for_mgmt_land_base_ind = 'N' THEN 'fmlb_orig = N'
		END AS n01_fmlb
```



``` r
lclass<-"Non_Forest_and_Non_Productive_Forest"
n_step<-"n04_nonfor"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab<-update_areas_aflb(netdown_tab,n_step)

running_total<-get_running_total(netdown_summary,lclass)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:right;"> 1,167,464 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 380,900 </td>
   <td style="text-align:right;"> 786,564 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 451,088 </td>
   <td style="text-align:right;"> 716,376 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25 </td>
   <td style="text-align:right;"> 451,113 </td>
   <td style="text-align:right;"> 716,351 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698 </td>
   <td style="text-align:right;"> 462,811 </td>
   <td style="text-align:right;"> 704,653 </td>
  </tr>
</tbody>
</table>



### p05_linear_features

Productive forest land is lost due to permanent roads, trails, pipelines, transmission lines and other linear features (something relating to or consisting of lines (buffered)). Existing estimates of the area occupied by linear features is determined by applying average feature width buffers to the identified features.

The linear features table was created in July 2024 and reflects the 2021 CE Integrated roads dataset that includes roads and other linear features (railways, power lines, etc.). 

**Data source:** BC cumulative effects framework 2021 integrated roads dataset, WHSE_TANTALIS.TA_CROWN_RIGHTS_OF_WAY_SVW, WHSE_MINERAL_TENURE.OG_PIPELINE_AREA_PERMIT_SP, WHSE_IMAGERY_AND_BASE_MAPS.DRP_OIL_GAS_PIPELINES_BC_SP, WHSE_BASEMAPPING.GBA_TRANSMISSION_LINES_SP, WHSE_BASEMAPPING.GBA_RAILWAY_TRACKS_SP



``` r
lclass<-"Linear_Features"
n_step<-"p05_linear_features"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)


netdown_tab <- netdown_tab %>%
mutate( aflb = aflb * (1-p05_linear_features),
thlb_net = thlb_net * (1-p05_linear_features),
thlb_pre_ret = thlb_pre_ret * (1-p05_linear_features)
)

running_total<-get_running_total(netdown_summary,lclass)

netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
</tbody>
</table>



### AFLB Summary


``` r
lclass<-"LANDBASE SUMMARY - AFLB"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=aflb)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
</tbody>
</table>




## Delineating the THLB

The next phase of the netdown process delineates the THLB from the AFLB. 

### n06_park
BC has an extensive protected areas strategy that was developed to protect natural, cultural and recreational values. Protection is afforded under several Acts including the Ecological Reserves Act, Park Act, Protected Areas Act and Environment and Land Use Act. These types of protected areas within the TSA will be considered part of the AFLB and contribute to objectives for biodiversity and wildlife. However, these areas are not administered by the MOF for timber supply and thus are excluded from the THLB. Once again the ownership code is used to identify protected areas to be excluded during the netdown process.

Below is a specific list of ownership classes excluded:

+ 60N, Crown - Ecological Reserve
+ 60N, Crown – Provincial Park 
+ 60N, Crown – Protected Area 
+ 60N, Crown - Conservancy Area
+ 81U, Local/Regional Park

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN


``` r
lclass<-"Parks_and_Protected_Areas"
n_step<-"n06_parks"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
## TODO FIX IT BACK
netdown_tab<-update_areas_thlb_pre_ret(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.78 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
</tbody>
</table>




### n07_wha
The Identified Wildlife Management Strategy (IWMS) provides direction, policy, procedures and guidelines for managing Identified Wildlife. The goals of the strategy are to minimize the effects of forest and range practices on Identified Wildlife situated on on the AFLB and to maintain their limiting habitats throughout their current ranges and, where appropriate, their historic ranges. In some cases, this will entail restoration of previously occupied habitats, particularly for those species most at risk. Identified Wildlife are managed through the establishment of Wildlife Habitat Areas (WHAs) and the implementation of GWMs and WHA objectives, or through other management practices specified in strategic or landscape level plans. Both Ungulate Winter Ranges (UWRs) and WHAs objectives fall into two categories: 

1. Harvest and Road construction activities are excluded
2. Fover Cover Objectives must be maintained

Areas that exclude harvest are maintained in the AFLB but are removed from the THLB

**Data sources:** BCGW file: WHSE_WILDLIFE_MANAGEMENT.WCP_WILDLIFE_HABITAT_AREA_POLY



``` r
lclass<-"Wildlife_Habitat_Areas"
n_step<-"n07_wha"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb_pre_ret(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.78 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.39 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
</tbody>
</table>



### n08_rec
Below is a specific list of ownership classes excluded:

+ 66N, Crown - Recreation Area 
+ 68U, Crown - Forest Recreation 

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN


``` r
lclass<-"Recreation_Features"
n_step<-"n08_rec"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb_pre_ret(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.78 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.39 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.22 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
</tbody>
</table>




### n09_misc
Below is a specific list of ownership classes excluded:

+ 69U, Crown - Misc. Reserves
+ 69U, Crown - Misc. Reserves Caribou
+ 69U, Crown - Watershed Reserve
+ 99N, Crown – Misc. lease

**Data sources:** BCGW file: WHSE_FOREST_VEGETATION.F_OWN


``` r
lclass <- "Misc_Tenures"
n_step <- "n09_misc"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb_pre_ret(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.78 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.39 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.22 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.58 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
</tbody>
</table>




### p10_riparian


``` r
lclass<-"Riparian_Buffers"
n_step<-"p10_riparian"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-p10_riparian),
         thlb_pre_ret = thlb_pre_ret * (1-p10_riparian)
  )

running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.00 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.00 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.00 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.00 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.15 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.78 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.39 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.22 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.58 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.50 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
</tbody>
</table>



### n11_arch

A cultural heritage resource is defined in the Forest Act as, “an object, site, or location of a traditional societal practice that is of historical, cultural or archaeological significance to the province, a community, or an aboriginal people”. Cultural heritage resources include archaeological sites structural features, heritage landscape features, and traditional use sites.

The Heritage Conservation Act provides for the protection of British Columbia’s archaeological sites predating 1846. In accordance with the Act (Section 13(2)), archaeological sites may not be damaged, excavated or altered without a permit issued by the Minister or designate.The BC Provincial Heritage Register database is the basis for records on archaeological sites and provides a polygon layer. For this timber supply review, all identified buffered archaeological sites within the provincial application Remote Access to Archaeological Data (RAAD) are excluded from the timber harvesting land base.

**Data source:** BCGW file (restricted) WHSE_ARCHAEOLOGY.RAAD_TFM_SITES_SVW
Access date: Jan 7, 2025


``` r
lclass<-"Non-Cultural_Heritage_Features"
n_step<-"n11_arch"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb_pre_ret(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
</tbody>
</table>



### THLB Summary pre RR


``` r
lclass<-"LANDBASE SUMMARY - THLB pre RR"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=thlb_net)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB pre RR </td>
   <td style="text-align:right;"> 364,674.46 </td>
   <td style="text-align:right;"> 31.2364630 </td>
   <td style="text-align:right;"> 802,789.5402 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
</tbody>
</table>




### n12_harvest_restrictions
Ensure to filter out nonlegal ogmas that are currently in the Prohibited category



``` r
lclass<-"Harvest_Restrictions"
n_step<-"n12_harvest_restrictions"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB pre RR </td>
   <td style="text-align:right;"> 364,674.46 </td>
   <td style="text-align:right;"> 31.2364630 </td>
   <td style="text-align:right;"> 802,789.5402 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 470,145.00 </td>
   <td style="text-align:right;"> 40.2706208 </td>
   <td style="text-align:right;"> 3,648.5427 </td>
   <td style="text-align:right;"> 806,438.1 </td>
   <td style="text-align:right;"> 361,025.9 </td>
  </tr>
</tbody>
</table>



### p13_phys_inop
To determine physically inoperable areas, elevation, slope and terrain stability mapping were assessed related to historic practice since 2014. 

For each TSA and TFL, binary rasters at 25-meter resolution were created to identify areas with slopes exceeding the 99th percentile within harvested cutblocks since 2014, areas with elevations exceeding 99th percentile within harvested cutblocks since 2014 and areas with unstable or potentially unstable slopes. These rasters were then combined to produce a single "physically inoperable" variable. Finally, the data was aggregated to a 1-hectare resolution to form a proportional inoperable variable.

Please note that when creating the 99th percentile threshold, it was required to have a minumum of 30 cutblocks within the TFL/TSA. If the unit did not have > 30 cutblocks, a TFL would using the threshold of the TSA the TFL overlaps with the most. Only TFL 43 had < 30 cutblocks, and instead, the thresolds from 39 - Sunshine Coast TSA were used for TFL 43.

Note: If an area has ever been harvested (ie. in the consolidated cutblock), the THLB is not adjusted by physically inoperability.


``` r
lclass<-"Physical_Inoperable"
n_step<-"p13_phys_inop"

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = case_when(
    (!is.na(cc_year)) ~ thlb_net, ## leave THLB as is if cell was ever previously a cutblock (ie. consolidated cutblock year exists)
    is.na(cc_year) ~ thlb_net * (1-p13_phys_inop)
    )
  )

running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB pre RR </td>
   <td style="text-align:right;"> 364,674.46 </td>
   <td style="text-align:right;"> 31.2364630 </td>
   <td style="text-align:right;"> 802,789.5402 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 470,145.00 </td>
   <td style="text-align:right;"> 40.2706208 </td>
   <td style="text-align:right;"> 3,648.5427 </td>
   <td style="text-align:right;"> 806,438.1 </td>
   <td style="text-align:right;"> 361,025.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 559,987.74 </td>
   <td style="text-align:right;"> 47.9661678 </td>
   <td style="text-align:right;"> 121,527.0074 </td>
   <td style="text-align:right;"> 927,965.1 </td>
   <td style="text-align:right;"> 239,498.9 </td>
  </tr>
</tbody>
</table>



### n14_merchantability
Note: If an area has ever been harvested (ie. in the consolidated cutblock), the THLB is not adjusted by merchantability.



``` r
lclass<-"Merchantability"
n_step<-"n14_merchantability"

netdown_tab <- netdown_tab %>%
  mutate(n14_merchantability = case_when(
    (!is.na(cc_year)) ~ NA, ##adjust non-merchantable value to NA if cell was ever previously a cutblock (ie. consolidated cutblock year exists)
    is.na(cc_year) ~ n14_merchantability
    )
  )
netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB pre RR </td>
   <td style="text-align:right;"> 364,674.46 </td>
   <td style="text-align:right;"> 31.2364630 </td>
   <td style="text-align:right;"> 802,789.5402 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 470,145.00 </td>
   <td style="text-align:right;"> 40.2706208 </td>
   <td style="text-align:right;"> 3,648.5427 </td>
   <td style="text-align:right;"> 806,438.1 </td>
   <td style="text-align:right;"> 361,025.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 559,987.74 </td>
   <td style="text-align:right;"> 47.9661678 </td>
   <td style="text-align:right;"> 121,527.0074 </td>
   <td style="text-align:right;"> 927,965.1 </td>
   <td style="text-align:right;"> 239,498.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Merchantability </td>
   <td style="text-align:right;"> 397,763.00 </td>
   <td style="text-align:right;"> 34.0706865 </td>
   <td style="text-align:right;"> 33,207.3919 </td>
   <td style="text-align:right;"> 961,172.5 </td>
   <td style="text-align:right;"> 206,291.5 </td>
  </tr>
</tbody>
</table>



### n15_non_commercial
Note: If an area has ever been harvested (ie. in the consolidated cutblock), the THLB is not adjusted by non-commercial.



``` r
lclass<-"Non-Commercial"
n_step<-"n15_non_commercial"

netdown_tab <- netdown_tab %>%
  mutate(n15_non_commercial = case_when(
    (!is.na(cc_year)) ~ NA, ##adjust non-merchantable value to NA if cell was ever previously a cutblock (ie. consolidated cutblock year exists)
    is.na(cc_year) ~ n15_non_commercial
    )
  )

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB pre RR </td>
   <td style="text-align:right;"> 364,674.46 </td>
   <td style="text-align:right;"> 31.2364630 </td>
   <td style="text-align:right;"> 802,789.5402 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 470,145.00 </td>
   <td style="text-align:right;"> 40.2706208 </td>
   <td style="text-align:right;"> 3,648.5427 </td>
   <td style="text-align:right;"> 806,438.1 </td>
   <td style="text-align:right;"> 361,025.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 559,987.74 </td>
   <td style="text-align:right;"> 47.9661678 </td>
   <td style="text-align:right;"> 121,527.0074 </td>
   <td style="text-align:right;"> 927,965.1 </td>
   <td style="text-align:right;"> 239,498.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Merchantability </td>
   <td style="text-align:right;"> 397,763.00 </td>
   <td style="text-align:right;"> 34.0706865 </td>
   <td style="text-align:right;"> 33,207.3919 </td>
   <td style="text-align:right;"> 961,172.5 </td>
   <td style="text-align:right;"> 206,291.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Commercial </td>
   <td style="text-align:right;"> 22,599.00 </td>
   <td style="text-align:right;"> 1.9357342 </td>
   <td style="text-align:right;"> 4,968.7361 </td>
   <td style="text-align:right;"> 966,141.2 </td>
   <td style="text-align:right;"> 201,322.8 </td>
  </tr>
</tbody>
</table>



### retention


Stand level retention refers to unharvested areas associated with individual cutblocks. An analysis of retention practices derived from RESULTS spatial data collected from 2012 to 2024 were utilized to estimate total stand level retention for the province.

The retention estimate includes areas occupied by biodiveristy, riparian retention, wildlife tree retention (grouped retention), as well as retention for the protection of forest values including archaeological features, site specific habitat features, and/or blue listed species or ecosystems. Stand level retention in the netdown process is modelled as an aspatial adjustment factor and applied to each hectare in the THLB, based on the geometric mean stand level retention for the TSA.

This approach recognises that although retention is not dispersed evenly across the land base the spatial variation in retention levels can be generalized across the land base without undue risk to yield estimation and forms a reasonable approximation for modelling timber supply in a TSA.

To calculate long-term retention, the percentage of coverage by RESULTS reserves relative to the total opening area was determined. Reserves with the Reserve Objective Codes "TIM" (Timber Objective) and "RMA" (Riparian Management Area) were excluded from this calculation. The "TIM" objective does not represent long-term retention, and riparian areas were excluded to avoid double-counting as they are addressed during a separate netdown step.

Additionally, the RESULTS reserves data was filtered to include:
+ Reserves with a silviculture reserve code of "G" (mapped reserves).
+ Disturbance data from 2012 onward, as the "G" reserve code was established in 2011 with a grace period of 1 year, before enforcement in 2012.
+ Only openings where the Opening Category Code is not in ('NREQ', 'SPEX', 'UHRV'), to exclude government-funded silviculture activities.

The distribution of the % retention over the opening was analyzed. A lower cutoff and an upper cutoff was developed to "clean" the data and to remove outliers. The weighted mean of the cleaned RESULTS dataset for each TSA was calculated as the preliminary stand level retention THLB reduction factor. 

The second phase of the process is to adjust the stand level retention reduction to THLB to account for land classes that have already been excluded from the THLB to avoid double counting. A spatial sample of the RESULTS retention dataset was examined through the netdown process to assess the amount of non-productive, inoperable or non merchantable forest that was generally retained within openings.


See below table of cutoffs and ..



``` r
avg_opening_thlb <- netdown_tab %>%
  group_by(res_opening_id, tsa_rank1) %>%
  summarize(
    sum_thlb_net = sum(thlb_net, na.rm = TRUE),
    count = n(),
    pct = sum_thlb_net / count,
    .groups = "drop"
  ) %>%
  group_by(tsa_rank1) %>%
  summarize(
    avg_thlb_pct = mean(pct, na.rm = TRUE),
    .groups = "drop"
  )

## bring in the table of long term retention
ltr <- sql_to_df('SELECT b.tsa_number_description AS tsa_rank1, weighted_mean_ltr FROM thlb_proxy.retention_thresholds_man_unit a JOIN whse.mu_lookup_table_im b USING (man_unit)', conn_list)

## merge the long term retention with the table of THLB percent per opening per TSA
ltr_thlb <- merge(ltr, avg_opening_thlb, by='tsa_rank1')
ltr_thlb$n16_long_term_retention <- ltr_thlb$weighted_mean_ltr * ltr_thlb$avg_thlb_pct

lclass<-"Long_Term_Retention"
n_step<-"n16_long_term_retention"


netdown_tab <- netdown_tab %>%
  left_join(ltr_thlb, by = "tsa_rank1")

netdown_tab <- netdown_tab %>%
  mutate(thlb_net = thlb_net * (1-n16_long_term_retention)
  )

netdown_summary<-netdown_prop(netdown_tab,netdown_summary,running_total,lclass,n_step)


running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```




``` r
lclass<-"Current_Retention"
n_step<-"n16_current_retention"

netdown_summary<-netdown100pct(netdown_tab,netdown_summary,running_total,lclass,n_step)
netdown_tab<-update_areas_thlb(netdown_tab,n_step)
running_total<-get_running_total(netdown_summary,lclass)
netdown<-get_netdown(netdown_summary,lclass)
pretty_table(netdown_summary)
```



### THLB Summary


``` r
lclass<-"LANDBASE SUMMARY - THLB"

netdown_summary<-landbase_sum(netdown_tab,netdown_summary,running_total,lclass,netdown,which_landbase=thlb_net)

pretty_table(netdown_summary)
```

<table class="table table-striped" style="font-size: 10px; color: black; margin-left: auto; margin-right: auto;">
<caption style="font-size: initial !important;">Netdown Summary Table</caption>
 <thead>
  <tr>
   <th style="text-align:left;"> landclass </th>
   <th style="text-align:right;"> total </th>
   <th style="text-align:right;"> percent </th>
   <th style="text-align:right;"> excluded </th>
   <th style="text-align:right;"> running_total </th>
   <th style="text-align:right;"> netdown </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:left;"> Provincial_Boundary </td>
   <td style="text-align:right;"> 1,167,464.00 </td>
   <td style="text-align:right;"> 100.0000000 </td>
   <td style="text-align:right;"> 0.0000 </td>
   <td style="text-align:right;"> 0.0 </td>
   <td style="text-align:right;"> 1,167,464.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> FMLB </td>
   <td style="text-align:right;"> 380,900.00 </td>
   <td style="text-align:right;"> 32.6262737 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FMLB </td>
   <td style="text-align:right;"> 786,564.00 </td>
   <td style="text-align:right;"> 67.3737263 </td>
   <td style="text-align:right;"> 380,900.0000 </td>
   <td style="text-align:right;"> 380,900.0 </td>
   <td style="text-align:right;"> 786,564.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_FALB </td>
   <td style="text-align:right;"> 118,524.00 </td>
   <td style="text-align:right;"> 10.1522617 </td>
   <td style="text-align:right;"> 70,188.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - FALB </td>
   <td style="text-align:right;"> 716,376.00 </td>
   <td style="text-align:right;"> 61.3617208 </td>
   <td style="text-align:right;"> 451,088.0000 </td>
   <td style="text-align:right;"> 451,088.0 </td>
   <td style="text-align:right;"> 716,376.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Ownership_Areas_Excluded_from_AFLB </td>
   <td style="text-align:right;"> 200.00 </td>
   <td style="text-align:right;"> 0.0171311 </td>
   <td style="text-align:right;"> 25.0000 </td>
   <td style="text-align:right;"> 451,113.0 </td>
   <td style="text-align:right;"> 716,351.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non_Forest_and_Non_Productive_Forest </td>
   <td style="text-align:right;"> 370,819.00 </td>
   <td style="text-align:right;"> 31.7627781 </td>
   <td style="text-align:right;"> 11,698.0000 </td>
   <td style="text-align:right;"> 462,811.0 </td>
   <td style="text-align:right;"> 704,653.0 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Linear_Features </td>
   <td style="text-align:right;"> 23,940.54 </td>
   <td style="text-align:right;"> 2.0506448 </td>
   <td style="text-align:right;"> 15,436.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - AFLB </td>
   <td style="text-align:right;"> 689,216.85 </td>
   <td style="text-align:right;"> 59.0353836 </td>
   <td style="text-align:right;"> 478,247.1497 </td>
   <td style="text-align:right;"> 478,247.1 </td>
   <td style="text-align:right;"> 689,216.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Parks_and_Protected_Areas </td>
   <td style="text-align:right;"> 218,241.00 </td>
   <td style="text-align:right;"> 18.6935957 </td>
   <td style="text-align:right;"> 121,277.7800 </td>
   <td style="text-align:right;"> 599,524.9 </td>
   <td style="text-align:right;"> 567,939.1 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Wildlife_Habitat_Areas </td>
   <td style="text-align:right;"> 4,566.00 </td>
   <td style="text-align:right;"> 0.3911041 </td>
   <td style="text-align:right;"> 3,169.3900 </td>
   <td style="text-align:right;"> 602,694.3 </td>
   <td style="text-align:right;"> 564,769.7 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Recreation_Features </td>
   <td style="text-align:right;"> 34,644.00 </td>
   <td style="text-align:right;"> 2.9674577 </td>
   <td style="text-align:right;"> 27,195.2200 </td>
   <td style="text-align:right;"> 629,889.5 </td>
   <td style="text-align:right;"> 537,574.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Misc_Tenures </td>
   <td style="text-align:right;"> 242,623.00 </td>
   <td style="text-align:right;"> 20.7820541 </td>
   <td style="text-align:right;"> 161,143.5801 </td>
   <td style="text-align:right;"> 791,033.1 </td>
   <td style="text-align:right;"> 376,430.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Riparian_Buffers </td>
   <td style="text-align:right;"> 288,363.00 </td>
   <td style="text-align:right;"> 24.6999479 </td>
   <td style="text-align:right;"> 11,727.4961 </td>
   <td style="text-align:right;"> 802,760.6 </td>
   <td style="text-align:right;"> 364,703.4 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Cultural_Heritage_Features </td>
   <td style="text-align:right;"> 133.00 </td>
   <td style="text-align:right;"> 0.0113922 </td>
   <td style="text-align:right;"> 28.9244 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB pre RR </td>
   <td style="text-align:right;"> 364,674.46 </td>
   <td style="text-align:right;"> 31.2364630 </td>
   <td style="text-align:right;"> 802,789.5402 </td>
   <td style="text-align:right;"> 802,789.5 </td>
   <td style="text-align:right;"> 364,674.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Harvest_Restrictions </td>
   <td style="text-align:right;"> 470,145.00 </td>
   <td style="text-align:right;"> 40.2706208 </td>
   <td style="text-align:right;"> 3,648.5427 </td>
   <td style="text-align:right;"> 806,438.1 </td>
   <td style="text-align:right;"> 361,025.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Physical_Inoperable </td>
   <td style="text-align:right;"> 559,987.74 </td>
   <td style="text-align:right;"> 47.9661678 </td>
   <td style="text-align:right;"> 121,527.0074 </td>
   <td style="text-align:right;"> 927,965.1 </td>
   <td style="text-align:right;"> 239,498.9 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Merchantability </td>
   <td style="text-align:right;"> 397,763.00 </td>
   <td style="text-align:right;"> 34.0706865 </td>
   <td style="text-align:right;"> 33,207.3919 </td>
   <td style="text-align:right;"> 961,172.5 </td>
   <td style="text-align:right;"> 206,291.5 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> Non-Commercial </td>
   <td style="text-align:right;"> 22,599.00 </td>
   <td style="text-align:right;"> 1.9357342 </td>
   <td style="text-align:right;"> 4,968.7361 </td>
   <td style="text-align:right;"> 966,141.2 </td>
   <td style="text-align:right;"> 201,322.8 </td>
  </tr>
  <tr>
   <td style="text-align:left;"> LANDBASE SUMMARY - THLB </td>
   <td style="text-align:right;"> 209,636.69 </td>
   <td style="text-align:right;"> 17.9565875 </td>
   <td style="text-align:right;"> 966,141.2182 </td>
   <td style="text-align:right;"> 966,141.2 </td>
   <td style="text-align:right;"> 201,322.8 </td>
  </tr>
</tbody>
</table>





``` r

df_to_pg(Id(schema = 'thlb_proxy', table = 'prov_netdown_jan13'), netdown_tab[,c('gr_skey', 'fmlb','falb','aflb','thlb_pre_ret', 'thlb_net')], conn_list, overwrite=TRUE)

query <- "ALTER TABLE thlb_proxy.prov_netdown add column future_retention double precision;"
run_sql_r(query, conn_list)
query <- "ALTER TABLE thlb_proxy.prov_netdown add column fmlb double precision;"
run_sql_r(query, conn_list)
query <- "ALTER TABLE thlb_proxy.prov_netdown add column falb double precision;"
run_sql_r(query, conn_list)
query <- "ALTER TABLE thlb_proxy.prov_netdown add column aflb double precision;"
run_sql_r(query, conn_list)
query <- "ALTER TABLE thlb_proxy.prov_netdown add column thlb_net double precision;"
run_sql_r(query, conn_list)

query <- "UPDATE thlb_proxy.prov_netdown set fmlb = a.fmlb,
falb = a.falb,
aflb = a.aflb,
thlb_net = a.thlb_net
from
thlb_proxy.prov_netdown_jan13 a
where a.gr_skey = thlb_proxy.prov_netdown.gr_skey;"
run_sql_r(query, conn_list)
```

